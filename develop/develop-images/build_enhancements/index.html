<!-- Page generated 2020-05-30 14:52:22 +0900 -->
<!-- Logic for 'edit this button'


    

    

    

    

    

    

    

    

-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <style type="text/css">
      @charset "UTF-8";
      [ng\:cloak],
      [ng-cloak],
      [data-ng-cloak],
      [x-ng-cloak],
      .ng-cloak,
      .x-ng-cloak,
      .ng-hide:not(.ng-hide-animate) {
          display: none !important;
      }

      ng\:form {
          display: block;
      }
  </style>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WL2QLG5');</script>

  
  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta name="msapplication-TileImage" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico">
  <link rel="apple-touch-icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta property="og:image" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
  <!-- metadata -->
  <meta property="og:type" content="website"/>
  <meta property="og:updated_time" itemprop="dateUpdated" content="2020-05-30T14:52:22+09:00"/>
  <meta property="og:image" itemprop="image primaryImageOfPage" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:domain" content="docs.docker.com"/>
  <meta name="twitter:site" content="@docker_docs"/>
  <meta name="twitter:url" content="https://twitter.com/docker_docs"/>
  <meta name="twitter:title" itemprop="title name" content="BuildKit によるイメージ構築"/>
  <meta name="twitter:description" property="og:description" itemprop="description" content="Docker によるビルドは、Docker Engine においてもっとも利用されている機能と言えます。 開発者、ビルドチーム、リリースチームなど幅広いユーザーがこの Docker ビルドを行います。 Docker 18.09 のリリースにおいて行われたビルド機能の拡張は、ビルドアーキテクチャーの総見直しにより必要となる機能を導入しています。 BuildKit を統合したことによって、処理性能、ストレージ管理、ツール機能、セキュリティのどれをとっても改善が見られるはずです。 BuildKit を用いて生成された Docker イメージは、従来の Docker イメージと同じように Docker Hub にプッシュすることができます。 従来のビルドに対して動作している Dockerfile の記述は、BuildKit を用いてビルドを行っても同様に動作します。 新しくコマンドラインオプション --secret が導入され、Dockerfile を用いたイメージビルドにあたり、機密情報を受け渡すことができるようになりました。 ビルド時のオプションに関しては..." />
  <meta name="twitter:image:src" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:image:alt" content="Docker Documentation"/>
  <meta property="article:published_time" itemprop="datePublished" content="2020-05-30T14:52:22+09:00"/>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="build, security, engine, secret, BuildKit">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/font-awesome.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/bootstrap.min.css">
  <link id="pygments" rel="stylesheet" href="/docs.docker.jp.onthefly/css/pygments/perldoc.css">
  <link id="pagestyle" rel="stylesheet" href="/docs.docker.jp.onthefly/css/style.css">

  <!-- Go get "Open Sans" font from Google -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <!-- SEO stuff -->
  <title>BuildKit によるイメージ構築 | Docker Documentation</title>
  <meta property="og:title" content="BuildKit によるイメージ構築" />
  <meta property="og:locale" content="ja_JP" />
  <meta name="description" content="BuildKit により Docker ビルドについて学びます。" />
  <meta property="og:description" content="BuildKit により Docker ビルドについて学びます。" />
  <link rel="canonical" href="/develop/develop-images/build_enhancements/" />
  <meta property="og:url" content="https://docs.docker.com/develop/develop-images/build_enhancements/" />
  <meta property="og:site_name" content="Docker ドキュメント" />
  <script type="application/ld+json">{"@context":"http://schema.org","@type":"WebPage","headline":"BuildKit によるイメージ構築","description":"BuildKit により Docker ビルドについて学びます。","url":"https://docs.docker.com/develop/develop-images/build_enhancements/"}</script>
  <!-- END SEO STUFF -->
  
  <script>
  // Default to assuming this is an archive and hiding some stuff
  // See js/archive.js and js/docs.js for logic relating to this
  var isArchive = true;
  var dockerVersion = 'v19.03';
  </script>
</head>


    <body ng-app="Docker" ng-controller="DockerController" class="colums">
    <header>
        <nav class="nav-secondary navbar navbar-fixed-top">
    <!-- <div class="fan"></div> -->
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="/docs.docker.jp.onthefly/">
                <img class="logo" src="/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs">
            </a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="logo-mobile">
    <a href="/docs.docker.jp.onthefly/">
        <img src="/docs.docker.jp.onthefly/images/docker-icon.svg" alt="Docker Docs" title="Docker Docs">
    </a>
</div>
<div class="search-form" id="search-div" style="visibility: hidden">
    <form class="search-form form-inline ng-pristine ng-valid" id="searchForm" action="https://matsuand.github.io/docs.docker.jp.onthefly/search/">
        <input class="search-field form-control ds-input" id="st-search-input" value="" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteContainer">
            <div id="autocompleteResults"></div>
        </div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container hidden-sm hidden-xs">
    <div id="tabs">
        <ul class="tabs jsTOCHorizontal">

        </ul>
    </div>
    <div class="ctrl-right">
        <a href="javascript:void(0)" id="menu-toggle"><i class="fa fa-indent" aria-hidden="true"></i></a>
        <div class="btn-group" style="visibility: hidden">
  <button type="button" class="btn btn-default dropdown-btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Docker v19.03 (最新)     <span class="caret"></span>
  </button>
  <ul class="dropdown-menu">
    <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v18.09/">Docker v18.09</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v18.03/">Docker v18.03</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.06/">Docker v17.06</a></li>
  </ul>
</div>

    </div>
</div>

        </div>
    </div>
</nav>

    </header>
    <div class="wrapper right-open">
        <div class="container-fluid">
            <div class="row">
                <div class="col-body">
                    <main class="col-content content">
                        <section class="section">
                            
                            
                            <h1>BuildKit によるイメージ構築</h1> 
                            <span class="reading-time" title="Estimated reading time">
  <span class="reading-time-label">読む時間の目安: </span>
  
  
    7 分
  
</span>

                            
                            
                            
<p>Docker によるビルドは、Docker Engine においてもっとも利用されている機能と言えます。
開発者、ビルドチーム、リリースチームなど幅広いユーザーがこの Docker ビルドを行います。</p>

<p>Docker 18.09 のリリースにおいて行われたビルド機能の拡張は、ビルドアーキテクチャーの総見直しにより必要となる機能を導入しています。
BuildKit を統合したことによって、処理性能、ストレージ管理、ツール機能、セキュリティのどれをとっても改善が見られるはずです。</p>

<ul>
  <li>BuildKit を用いて生成された Docker イメージは、従来の Docker イメージと同じように Docker Hub にプッシュすることができます。</li>
  <li>従来のビルドに対して動作している Dockerfile の記述は、BuildKit を用いてビルドを行っても同様に動作します。</li>
  <li>新しくコマンドラインオプション <code class="highlighter-rouge">--secret</code> が導入され、Dockerfile を用いたイメージビルドにあたり、機密情報を受け渡すことができるようになりました。</li>
</ul>

<p>ビルド時のオプションに関しては <a href="/engine/reference/commandline/build/">コマンドライン build オプション</a> を参照してください。</p>

<h2 id="requirements">システム要件</h2>

<ul>
  <li>システム要件は docker-ce x86_64, ppc64le, s390x, aarch64, armhf、また docker-ee であれば x86_64 のみです。</li>
  <li>独自のフロントエンドイメージをダウンロードするにはネットワーク接続が必要です。</li>
</ul>

<h2 id="limitations">制約条件</h2>

<ul>
  <li>Linux コンテナーのビルドにのみ対応しています。</li>
  <li>BuildKit モードは、UCP 3.2 およびそれ以降と互換性があります。</li>
</ul>

<h2 id="to-enable-buildkit-builds">BuildKit によるビルドの有効化</h2>

<p>一番簡単な方法としては docker を起動し始める際に環境変数 <code class="highlighter-rouge">DOCKER_BUILDKIT=1</code> を設定した上で <code class="highlighter-rouge">docker build</code> コマンドを起動します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ DOCKER_BUILDKIT</span><span class="o">=</span>1 docker build <span class="nb">.</span>
</code></pre></div></div>

<p>docker BuildKit をデフォルトで有効にするには、<code class="highlighter-rouge">/etc/docker/daemon.json</code> にあるデーモン設定の features を true にしデーモンを再起動します。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> </span><span class="s2">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"buildkit"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="new-docker-build-command-line-build-output">新たな Docker ビルドのコマンドライン出力</h2>

<p>新たな Docker BuildKit の TTY 出力は（デフォルトで）以下のとおりです。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker build <span class="nb">.</span>
<span class="go">
[+] Building 70.9s (34/59)
</span><span class="gp"> =&gt;</span> <span class="o">[</span>runc 1/4] COPY hack/dockerfile/install/install.sh ./install.sh       14.0s
<span class="gp"> =&gt;</span> <span class="o">[</span>frozen-images 3/4] RUN /download-frozen-image-v2.sh /build  buildpa  24.9s
<span class="gp"> =&gt;</span> <span class="o">[</span>containerd 4/5] RUN <span class="nv">PREFIX</span><span class="o">=</span>/build/ ./install.sh containerd           37.1s
<span class="gp"> =&gt;</span> <span class="o">[</span>tini 2/5] COPY hack/dockerfile/install/install.sh ./install.sh        4.9s
<span class="gp"> =&gt;</span> <span class="o">[</span>vndr 2/4] COPY hack/dockerfile/install/vndr.installer ./              1.6s
<span class="gp"> =&gt;</span> <span class="o">[</span>dockercli 2/4] COPY hack/dockerfile/install/dockercli.installer ./    5.9s
<span class="gp"> =&gt;</span> <span class="o">[</span>proxy 2/4] COPY hack/dockerfile/install/proxy.installer ./           15.7s
<span class="gp"> =&gt;</span> <span class="o">[</span>tomlv 2/4] COPY hack/dockerfile/install/tomlv.installer ./           12.4s
<span class="gp"> =&gt;</span> <span class="o">[</span>gometalinter 2/4] COPY hack/dockerfile/install/gometalinter.install  25.5s
<span class="gp"> =&gt;</span> <span class="o">[</span>vndr 3/4] RUN <span class="nv">PREFIX</span><span class="o">=</span>/build/ ./install.sh vndr                       33.2s
<span class="gp"> =&gt;</span> <span class="o">[</span>tini 3/5] COPY hack/dockerfile/install/tini.installer ./              6.1s
<span class="gp"> =&gt;</span> <span class="o">[</span>dockercli 3/4] RUN <span class="nv">PREFIX</span><span class="o">=</span>/build/ ./install.sh dockercli             18.0s
<span class="gp"> =&gt;</span> <span class="o">[</span>runc 2/4] COPY hack/dockerfile/install/runc.installer ./              2.4s
<span class="gp"> =&gt;</span> <span class="o">[</span>tini 4/5] RUN <span class="nv">PREFIX</span><span class="o">=</span>/build/ ./install.sh tini                       11.6s
<span class="gp"> =&gt;</span> <span class="o">[</span>runc 3/4] RUN <span class="nv">PREFIX</span><span class="o">=</span>/build/ ./install.sh runc                       23.4s
<span class="gp"> =&gt;</span> <span class="o">[</span>tomlv 3/4] RUN <span class="nv">PREFIX</span><span class="o">=</span>/build/ ./install.sh tomlv                      9.7s
<span class="gp"> =&gt;</span> <span class="o">[</span>proxy 3/4] RUN <span class="nv">PREFIX</span><span class="o">=</span>/build/ ./install.sh proxy                     14.6s
<span class="gp"> =&gt;</span> <span class="o">[</span>dev 2/23] RUN useradd <span class="nt">--create-home</span> <span class="nt">--gid</span> docker unprivilegeduser     5.1s
<span class="gp"> =&gt;</span> <span class="o">[</span>gometalinter 3/4] RUN <span class="nv">PREFIX</span><span class="o">=</span>/build/ ./install.sh gometalinter        9.4s
<span class="gp"> =&gt;</span> <span class="o">[</span>dev 3/23] RUN ln <span class="nt">-sfv</span> /go/src/github.com/docker/docker/.bashrc ~/.ba  4.3s
<span class="gp"> =&gt;</span> <span class="o">[</span>dev 4/23] RUN <span class="nb">echo source</span> /usr/share/bash-completion/bash_completion  2.5s
<span class="gp"> =&gt;</span> <span class="o">[</span>dev 5/23] RUN ln <span class="nt">-s</span> /usr/local/completion/bash/docker /etc/bash_comp  2.1s
</code></pre></div></div>

<p>新たな BuildKit の plain な出力は以下のとおりです。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker build <span class="nt">--progress</span><span class="o">=</span>plain <span class="nb">.</span>
<span class="go">
</span><span class="gp">#</span>1 <span class="o">[</span>internal] load .dockerignore
<span class="gp">#</span>1       digest: sha256:d0b5f1b2d994bfdacee98198b07119b61cf2442e548a41cf4cd6d0471a627414
<span class="gp">#</span>1         name: <span class="s2">"[internal] load .dockerignore"</span>
<span class="gp">#</span>1      started: 2018-08-31 19:07:09.246319297 +0000 UTC
<span class="gp">#</span>1    completed: 2018-08-31 19:07:09.246386115 +0000 UTC
<span class="gp">#</span>1     duration: 66.818µs
<span class="gp">#</span>1      started: 2018-08-31 19:07:09.246547272 +0000 UTC
<span class="gp">#</span>1    completed: 2018-08-31 19:07:09.260979324 +0000 UTC
<span class="gp">#</span>1     duration: 14.432052ms
<span class="gp">#</span>1 transferring context: 142B <span class="k">done</span>
<span class="go">

</span><span class="gp">#</span>2 <span class="o">[</span>internal] load Dockerfile
<span class="gp">#</span>2       digest: sha256:2f10ef7338b6eebaf1b072752d0d936c3d38c4383476a3985824ff70398569fa
<span class="gp">#</span>2         name: <span class="s2">"[internal] load Dockerfile"</span>
<span class="gp">#</span>2      started: 2018-08-31 19:07:09.246331352 +0000 UTC
<span class="gp">#</span>2    completed: 2018-08-31 19:07:09.246386021 +0000 UTC
<span class="gp">#</span>2     duration: 54.669µs
<span class="gp">#</span>2      started: 2018-08-31 19:07:09.246720773 +0000 UTC
<span class="gp">#</span>2    completed: 2018-08-31 19:07:09.270231987 +0000 UTC
<span class="gp">#</span>2     duration: 23.511214ms
<span class="gp">#</span>2 transferring dockerfile: 9.26kB <span class="k">done</span>
</code></pre></div></div>

<h2 id="overriding-default-frontends">デフォルトフロントエンドの上書き設定</h2>

<p><code class="highlighter-rouge">Dockerfile</code> における新たな文法機能として、デフォルトのフロントエンドを上書き設定することが可能になりました。
これを行うには <code class="highlighter-rouge">Dockerfile</code> の先頭行に、コメントとして特定のフロントエンドイメージを指定します。</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># syntax = &lt;frontend image&gt;, e.g. # syntax = docker/dockerfile:1.0-experimental</span>
</code></pre></div></div>

<h2 id="new-docker-build-secret-information">新たな Docker ビルドにおける機密情報の扱い</h2>

<p>Docker ビルドにおいては新たに <code class="highlighter-rouge">--secret</code> フラグが導入され、Dockerfile を用いたイメージビルドにあたり、機密情報を受け渡すことができるようになりました。
機密情報は、最終的にイメージ内に保存されることはないので、安全に取り扱うことができます。</p>

<p><code class="highlighter-rouge">id</code> は <code class="highlighter-rouge">docker build --secret</code> において受け渡される識別子です。
これは Dockerfile 内において用いられる <code class="highlighter-rouge">RUN --mount</code> 識別子に関連づいています。
Docker では Dockerfile の外に保持されている機密情報のファイル名は用いません。
これが重要な情報となることもあるからです。</p>

<p><code class="highlighter-rouge">dst</code> は Dockerfile 内にて用いられる <code class="highlighter-rouge">RUN</code> コマンドにおいての機密情報ファイルを、所定ファイル名に名称変更します。</p>

<p>たとえば以下のようなテキストファイル内に、一部の機密情報が含まれているとします。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">echo</span> <span class="s1">'WARMACHINEROX'</span> <span class="o">&gt;</span> mysecret.txt
</code></pre></div></div>

<p>And with a Dockerfile that specifies use of a BuildKit frontend
<code class="highlighter-rouge">docker/dockerfile:1.0-experimental</code>, the secret can be accessed.</p>

<p>たとえば以下のとおりです。</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># syntax = docker/dockerfile:1.0-experimental</span>
<span class="k">FROM</span><span class="s"> alpine</span>

<span class="c"># shows secret from default secret location:</span>
<span class="k">RUN </span><span class="nt">--mount</span><span class="o">=</span><span class="nb">type</span><span class="o">=</span>secret,id<span class="o">=</span>mysecret <span class="nb">cat</span> /run/secrets/mysecret

<span class="c"># shows secret from custom secret location:</span>
<span class="k">RUN </span><span class="nt">--mount</span><span class="o">=</span><span class="nb">type</span><span class="o">=</span>secret,id<span class="o">=</span>mysecret,dst<span class="o">=</span>/foobar <span class="nb">cat</span> /foobar
</code></pre></div></div>

<p>This Dockerfile is only to demonstrate that the secret can be accessed. As you
can see the secret printed in the build output. The final image built will not
have the secret file:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker build <span class="nt">--no-cache</span> <span class="nt">--progress</span><span class="o">=</span>plain <span class="nt">--secret</span> <span class="nv">id</span><span class="o">=</span>mysecret,src<span class="o">=</span>mysecret.txt <span class="nb">.</span>
<span class="c">...
</span><span class="gp">#</span>8 <span class="o">[</span>2/3] RUN <span class="nt">--mount</span><span class="o">=</span><span class="nb">type</span><span class="o">=</span>secret,id<span class="o">=</span>mysecret <span class="nb">cat</span> /run/secrets/mysecret
<span class="gp">#</span>8       digest: sha256:5d8cbaeb66183993700828632bfbde246cae8feded11aad40e524f54ce7438d6
<span class="gp">#</span>8         name: <span class="s2">"[2/3] RUN --mount=type=secret,id=mysecret cat /run/secrets/mysecret"</span>
<span class="gp">#</span>8      started: 2018-08-31 21:03:30.703550864 +0000 UTC
<span class="gp">#</span>8 1.081 WARMACHINEROX
<span class="gp">#</span>8    completed: 2018-08-31 21:03:32.051053831 +0000 UTC
<span class="gp">#</span>8     duration: 1.347502967s
<span class="go">

</span><span class="gp">#</span>9 <span class="o">[</span>3/3] RUN <span class="nt">--mount</span><span class="o">=</span><span class="nb">type</span><span class="o">=</span>secret,id<span class="o">=</span>mysecret,dst<span class="o">=</span>/foobar <span class="nb">cat</span> /foobar
<span class="gp">#</span>9       digest: sha256:6c7ebda4599ec6acb40358017e51ccb4c5471dc434573b9b7188143757459efa
<span class="gp">#</span>9         name: <span class="s2">"[3/3] RUN --mount=type=secret,id=mysecret,dst=/foobar cat /foobar"</span>
<span class="gp">#</span>9      started: 2018-08-31 21:03:32.052880985 +0000 UTC
<span class="gp">#</span>9 1.216 WARMACHINEROX
<span class="gp">#</span>9    completed: 2018-08-31 21:03:33.523282118 +0000 UTC
<span class="gp">#</span>9     duration: 1.470401133s
<span class="c">...
</span></code></pre></div></div>

<h2 id="using-ssh-to-access-private-data-in-builds">Using SSH to access private data in builds</h2>

<blockquote>
  <p><strong>Acknowledgment</strong>:
Please see <a href="https://medium.com/@tonistiigi/build-secrets-and-ssh-forwarding-in-docker-18-09-ae8161d066">Build secrets and SSH forwarding in Docker 18.09</a>
for more information and examples.</p>
</blockquote>

<p>The <code class="highlighter-rouge">docker build</code> has a <code class="highlighter-rouge">--ssh</code> option to allow the Docker Engine to forward
SSH agent connections. For more information on SSH agent, see the
<a href="https://man.openbsd.org/ssh-agent">OpenSSH man page</a>.</p>

<p>Only the commands in the <code class="highlighter-rouge">Dockerfile</code> that have explicitly requested the SSH
access by defining <code class="highlighter-rouge">type=ssh</code> mount have access to SSH agent connections. The
other commands have no knowledge of any SSH agent being available.</p>

<p>To request SSH access for a <code class="highlighter-rouge">RUN</code> command in the <code class="highlighter-rouge">Dockerfile</code>, define a mount
with type <code class="highlighter-rouge">ssh</code>. This will set up the <code class="highlighter-rouge">SSH_AUTH_SOCK</code> environment variable to
make programs relying on SSH automatically use that socket.</p>

<p>Here is an example Dockerfile using SSH in the container:</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># syntax=docker/dockerfile:experimental</span>
<span class="k">FROM</span><span class="s"> alpine</span>

<span class="c"># Install ssh client and git</span>
<span class="k">RUN </span>apk add <span class="nt">--no-cache</span> openssh-client git

<span class="c"># Download public key for github.com</span>
<span class="k">RUN </span>mkdir <span class="nt">-p</span> <span class="nt">-m</span> 0600 ~/.ssh <span class="o">&amp;&amp;</span> ssh-keyscan github.com <span class="o">&gt;&gt;</span> ~/.ssh/known_hosts

<span class="c"># Clone private repository</span>
<span class="k">RUN </span><span class="nt">--mount</span><span class="o">=</span><span class="nb">type</span><span class="o">=</span>ssh git clone git@github.com:myorg/myproject.git myproject
</code></pre></div></div>

<p>Once the <code class="highlighter-rouge">Dockerfile</code> is created, use the <code class="highlighter-rouge">--ssh</code> option for connectivity with
the SSH agent.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker build <span class="nt">--ssh</span> default <span class="nb">.</span>
</code></pre></div></div>

<h2 id="troubleshooting--issues-with-private-registries">トラブルシューティング： プライベートレジストリに関する問題</h2>

<h4 id="x509-certificate-signed-by-unknown-authority">x509: certificate signed by unknown authority</h4>

<p>If you are fetching images from insecure registry (with self-signed certificates)
and/or using such a registry as a mirror, you are facing a known issue in
Docker 18.09 :</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">[+] Building 0.4s (3/3) FINISHED
</span><span class="gp"> =&gt;</span> <span class="o">[</span>internal] load build definition from Dockerfile
<span class="gp"> =&gt;</span> <span class="o">=&gt;</span> transferring dockerfile: 169B
<span class="gp"> =&gt;</span> <span class="o">[</span>internal] load .dockerignore
<span class="gp"> =&gt;</span> <span class="o">=&gt;</span> transferring context: 2B
<span class="gp"> =&gt;</span> ERROR resolve image config <span class="k">for </span>docker.io/docker/dockerfile:experimental
<span class="go">------
</span><span class="gp"> &gt;</span> resolve image config <span class="k">for </span>docker.io/docker/dockerfile:experimental:
<span class="go">------
failed to do request: Head https://repo.mycompany.com/v2/docker/dockerfile/manifests/experimental: x509: certificate signed by unknown authority
</span></code></pre></div></div>

<p>Solution : secure your registry properly. You can get SSL certificates from
Let’s Encrypt for free. See /registry/deploying/</p>

<h4 id="image-not-found-when-the-private-registry-is-running-on-sonatype-nexus-version--315">image not found when the private registry is running on Sonatype Nexus version &lt; 3.15</h4>

<p>If you are running a private registry using Sonatype Nexus version &lt; 3.15, and
receive an error similar to the following :</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">------
</span><span class="gp"> &gt;</span> <span class="o">[</span>internal] load metadata <span class="k">for </span>docker.io/library/maven:3.5.3-alpine:
<span class="go">------
------
</span><span class="gp"> &gt;</span> <span class="o">[</span>1/4] FROM docker.io/library/maven:3.5.3-alpine:
<span class="go">------
rpc error: code = Unknown desc = docker.io/library/maven:3.5.3-alpine not found
</span></code></pre></div></div>

<p>you may be facing the bug below : <a href="https://issues.sonatype.org/browse/NEXUS-12684">NEXUS-12684</a></p>

<p>Solution is to upgrade your Nexus to version 3.15 or above.</p>

                            <!-- tags -->
                            
                            <span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span
                                style="vertical-align: 2px"><a
                                    href="https://docs.docker.com/search/?q=build">build</a>, <a
                                    href="https://docs.docker.com/search/?q=security">security</a>, <a
                                    href="https://docs.docker.com/search/?q=engine">engine</a>, <a
                                    href="https://docs.docker.com/search/?q=secret">secret</a>, <a
                                    href="https://docs.docker.com/search/?q=BuildKit">BuildKit</a></span>
                            
                            
                            <div id="ratings-div"
                                style="color:#b9c2cc; text-align: center; margin-top: 150px; visibility: hidden">
                                <div id="pd_rating_holder_8453675"></div>
                                <script type="text/javascript">
                                    PDRTJS_settings_8453675 = {
                                        "id": "8453675",
                                        "unique_id": "develop/develop-images/build_enhancements.md",
                                        "title": "BuildKit によるイメージ構築",
                                        "permalink": "https://github.com/docker/docker.github.io/blob/master/develop/develop-images/build_enhancements.md"
                                    };
                                    (function (d, c, j) {
                                        if (!document.getElementById(j)) {
                                            var pd = d.createElement(c),
                                                s;
                                            pd.id = j;
                                            pd.src = ('https:' == document.location.protocol) ? 'https://polldaddy.com/js/rating/rating.js' : 'http://i0.poll.fm/js/rating/rating.js';
                                            s = document.getElementsByTagName(c)[0];
                                            s.parentNode.insertBefore(pd, s);
                                        }
                                    }(document, 'script', 'pd-rating-js'));
                                </script>
                            </div>
                            
                        </section>
                    </main>
                    <nav class="col-nav">
                        <div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
                            <div id="navbar" class="nav-sidebar">
    <ul class="nav jsTOCHorizontal hidden-md hidden-lg">
    </ul>
    <div class="divider hidden-md hidden-lg"></div>
    <ul class="nav" id="jsTOCLeftNav">
    </ul>
</div>

                        </div>
                    </nav>
                    <div class="col-toc">
                        <div class="sidebar hidden-xs hidden-sm">
                            <div class="toc-nav">
                                <div class="feedback-links">
                                    <ul>
                                        
                                        <li style="visibility: hidden"><a href="https://github.com/matsuand/docs.docker.jp/edit/v19.03.local/develop/develop-images/build_enhancements.md"><i
                                                    class="fa fa-pencil-square-o" aria-hidden="true"></i> このページの編集</a></li>
                                        <li><a href="https://github.com/matsuand/docs.docker.jp/issues/new?body=ファイル: [develop/develop-images/build_enhancements.md](https://matsuand.github.io/docs.docker.jp.onthefly/develop/develop-images/build_enhancements/)"
                                                class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 文書変更のリクエスト</a></li>
                                        <!-- toggle mode -->
                                        <li>
                                            <div class="toggle-mode">
                                                <div class="icon">
                                                    <i class="fa fa-sun-o" aria-hidden="true"></i>
                                                </div>
                                                <div class="toggle-switch">
                                                    <label class="switch">
                                                        <input type="checkbox" id="switch-style">
                                                        <div class="slider round"></div>
                                                    </label>
                                                </div>
                                                <div class="icon">
                                                    <i class="fa fa-moon-o" aria-hidden="true"></i>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                
                                
                                
                                
                                <div id="side-toc-title">本ページ内:</div>
                                
<ul id="my_toc" class="inline_toc">
  <li><a href="#requirements" class="nomunge">システム要件</a></li>
  <li><a href="#limitations" class="nomunge">制約条件</a></li>
  <li><a href="#to-enable-buildkit-builds" class="nomunge">BuildKit によるビルドの有効化</a></li>
  <li><a href="#new-docker-build-command-line-build-output" class="nomunge">新たな Docker ビルドのコマンドライン出力</a></li>
  <li><a href="#overriding-default-frontends" class="nomunge">デフォルトフロントエンドの上書き設定</a></li>
  <li><a href="#new-docker-build-secret-information" class="nomunge">新たな Docker ビルドにおける機密情報の扱い</a></li>
  <li><a href="#using-ssh-to-access-private-data-in-builds" class="nomunge">Using SSH to access private data in builds</a></li>
  <li><a href="#troubleshooting--issues-with-private-registries" class="nomunge">トラブルシューティング： プライベートレジストリに関する問題</a></li>
</ul>


                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <footer class="footer">
          
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/why-docker">Why Docker</a></b></li>
                        <li><a href="https://www.docker.com/what-container">What is a Container</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/overview">Products</a></b></li>
                        <li><a href="https://www.docker.com/products/docker-desktop">Docker Desktop</a></li>
                        <li><a href="https://www.docker.com/products/docker-hub">Docker Hub</a></li>
                        <li><b><a href="https://www.docker.com/products/docker-desktop">Features</a></b></li>
                        <li><a href="https://www.docker.com/products/container-runtime">Container Runtime</a></li>
                        <li><a href="https://www.docker.com/products/developer-tools">Developer Tools</a></li>
                        <li><a href="https://www.docker.com/products/kubernetes">Kubernetes</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop">Developers</a></b></li>
                        <li><a href="https://www.docker.com/use-cases">Use Cases</a></li>
                        <li><a href="https://www.docker.com/play-with-docker">Play with Docker</a></li>
                        <li><a href="https://www.docker.com/docker-community">Community</a></li>
                        <li><a href="https://www.docker.com/open-source">Open Source</a></li>
                        <li><a href="https://www.docker.com/community/docker-captains">Docker Captains</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/company" target="_blank">Company</a></b></li>
                        <li><a href="https://www.docker.com/company">About Us</a></li>
                        <li><a href="https://www.docker.com/blog/" target="_blank">Blog</a></li>
                        <li><a href="https://www.docker.com/customers">Customers</a></li>
                        <li><a href="https://www.docker.com/partners">Partners</a></li>
                        <li><a href="https://www.docker.com/company/newsroom">Newsroom</a></li>
                        <li><a href="https://www.docker.com/careers">Careers</a></li>
                        <li><a href="https://www.docker.com/company/contact">Contact Us</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="http://status.docker.com/">Status</a></li>
                        <li><a href="https://www.docker.com/docker-security">Security</a></li>
                        <li><a href="https://www.docker.com/legal">Legal</a></li>
                        <li><a href="https://www.docker.com/company/contact">Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2013-2020 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="http://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="http://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-slideshare"><a href="https://www.slideshare.net/docker">Slideshare</a></li>
                    <li class="fa fa-reddit"><a href="https://www.reddit.com/r/docker">Reddit</a></li>
                </ul>
            </div>
        </div>
    </div>

    </footer>
    <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/github.css">
    
    <script defer src="/docs.docker.jp.onthefly/js/anchorlinks.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/menu.js"></script>
    <script src="/docs.docker.jp.onthefly/js/jquery.js"></script>
    <script src="/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
    <!-- Always include the archive.js, but it doesn't do much unless we are an archive -->
    <script>
        // Default to assuming this is an archive and hiding some stuff
        // See js/archive.js and js/docs.js for logic relating to this
        var isArchive = true;
        var dockerVersion = 'v19.03';
        // In archives, we need to know the page root and we get it from JEKYLL_ENV in the jekyll build command
        var jekyllEnv = 'development';
        // If unset (in non-archive branches), defaults to "development". In that case, reset it to empty
        if (jekyllEnv === 'development') {
            jekyllEnv = '';
        }
        var pageURL = jekyllEnv + '/develop/develop-images/build_enhancements/';
    </script>
    <script src="/docs.docker.jp.onthefly/js/archive.js"></script>
    <script src="/docs.docker.jp.onthefly/js/stickyfill.min.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/metadata.js"></script>
    <script src="/docs.docker.jp.onthefly/js/glossary.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/docs.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/toc.js"></script>
    <script defer src="/js/search.js"></script>
</body>


</html>
