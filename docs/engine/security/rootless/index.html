<!-- Page generated 2021-10-14 19:29:01 +0900-->
<!DOCTYPE html>
<html lang="ja"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>root ユーザー以外による Docker デーモン起動（rootless モード） | Docker ドキュメント</title>
  <meta name="description" content="root ユーザー以外によって Docker デーモンを起動します（rootless モード）。" />
  <meta name="keywords" content="security, namespaces, rootless">
  <link rel="canonical" href="https://localhost:4000{{ site.baseurl }}/engine/security/rootless/" />

  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <link rel="apple-touch-icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta name="msapplication-TileImage" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico">
  <meta property="og:image" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
  <meta name="theme-color" content="#2496ed" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- hide elements that are only shown without JavaScript enabled -->
  <script>document.documentElement.classList.add('js')</script>
  <style>html.js .no-js { display: none !important; }</style><script defer src="/docs.docker.jp.onthefly/js/theme-switcher.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/anchorlinks.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/jquery.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/docs.js"></script><script defer src="/docs.docker.jp.onthefly/js/search.js"></script><link rel="preload" as="font" href="https://fonts.gstatic.com/s/opensans/v18/mem8YaGs126MiZpBA-UFVZ0bf8pkAg.woff2" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/geomanist/hinted-Geomanist-Book.woff2"    type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/geomanist/hinted-Geomanist-Regular.woff2" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/glyphicons-halflings-regular.woff2"       type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/fontawesome-webfont.woff2?v=4.7.0"        type="font/woff2" crossorigin="anonymous">

  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/font-awesome.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/bootstrap.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/style.css" id="pagestyle">

  <!-- SEO stuff -->
  <meta name="twitter:title" itemprop="title name" content="root ユーザー以外による Docker デーモン起動（rootless モード）"/>
  <meta name="twitter:description" property="og:description" itemprop="description" content="" />
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:domain" content="matsuand.github.io"/>
  <meta name="twitter:site" content="@docker_docs"/>
  <meta name="twitter:url" content="https://twitter.com/docker_docs"/>
  <meta name="twitter:image:src" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:image:alt" content="Docker ドキュメント"/>
  <meta property="og:title" content="root ユーザー以外による Docker デーモン起動（rootless モード）" />
  <meta property="og:description" content="root ユーザー以外によって Docker デーモンを起動します（rootless モード）。" />
  <meta property="og:type" content="website"/>
  <meta property="og:updated_time" itemprop="dateUpdated" content="2021-10-14T19:29:01+09:00"/>
  <meta property="og:image" itemprop="image primaryImageOfPage" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta property="og:locale" content="ja_JP" />
  <meta property="og:url" content="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/rootless/" />
  <meta property="og:site_name" content="Docker ドキュメント" />
  <meta property="article:published_time" itemprop="datePublished" content="2021-10-14T19:29:01+09:00"/>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebPage","headline":"root ユーザー以外による Docker デーモン起動（rootless モード）","description":"root ユーザー以外によって Docker デーモンを起動します（rootless モード）。","url":"https://docs.docker.com/engine/security/rootless/"}</script>
  <!-- END SEO STUFF -->
</head>
<body class="colums">
    <header>
        <nav class="nav-secondary navbar navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="/docs.docker.jp.onthefly/">
                <img class="logo" src="/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs" width="160" height="28" />
            </a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="logo-mobile">
    <a href="/docs.docker.jp.onthefly/">
        <img src="/docs.docker.jp.onthefly/images/docker-icon.svg" alt="Docker Docs" title="Docker Docs" width="30" height="30" />
    </a>
</div>
<div class="search-form" id="search-div">
    <form class="search-form form-inline" id="searchForm" action="/docs.docker.jp.onthefly/search/" method="get">
        <label for="st-search-input" class="sr-only">検索</label>
        <input class="search-field form-control ds-input" id="st-search-input" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteResults"></div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container hidden-sm hidden-xs">
    <div>
        <ul class="nav navbar-nav"><li><a href="/docs.docker.jp.onthefly/" id="home">ホーム</a></li><li><a href="/docs.docker.jp.onthefly/get-started/overview/" id="guides">ガイド</a></li><li><a href="/docs.docker.jp.onthefly/desktop/" id="manuals">マニュアル</a></li><li><a href="/docs.docker.jp.onthefly/reference/" id="reference">リファレンス</a></li><li><a href="/docs.docker.jp.onthefly/samples/" id="samples">サンプル</a></li></ul>
    </div>
    <div class="ctrl-right">
        <a href="javascript:void(0)" id="menu-toggle" aria-label="現在ページのメニュートグル"><i class="fa fa-indent" aria-hidden="true"></i></a>
    </div>
</div>
<div class="row hidden-sm hidden-xs">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li><a href="/docs.docker.jp.onthefly/" title="Docker docs homepage"><i class="fa fa-home"></i></a></li>
            <li><a href="/docs.docker.jp.onthefly/get-started/overview/">ガイド</a></li><li><a>本番環境でのアプリ運用</a></li><li><a href="/docs.docker.jp.onthefly/config/containers/start-containers-automatically/">コンテナーの設定</a></li><li><a href="/docs.docker.jp.onthefly/engine/security/">セキュリティ</a></li><li><a href="/docs.docker.jp.onthefly/engine/security/rootless/">rootless モード</a></li></ol>
    </nav>
</div></div>
    </div>
</nav>

    </header>
    <div class="wrapper right-open">
        <div class="container-fluid">
            <div class="row">
                <div class="col-body">
                    <main class="col-content content">
                        <section class="section"><h1>root ユーザー以外による Docker デーモン起動（rootless モード）</h1><p><em class="reading-time">読む時間の目安: 18 分</em></p><p>rootless モードとは、root 以外のユーザーによって Docker デーモンやコンテナーを起動するものであり、デーモンや起動コンテナーにおける潜在的なぜい弱性を軽減します。</p>

<p>rootless モードは root 権限を必要としません。
しかも <a href="#prerequisites">前提条件</a> を満たしていれば、Docker デーモンのインストール時も必要としません。</p>

<p>rootless モードは Docker Engine v19.03 において試験的機能として導入されました。
rootless モードは Docker Engine v20.10 から正規機能となりました。</p>

<h2 id="how-it-works">どのように動作するか</h2>

<p>rootless モードは、Docker デーモンやコンテナーをユーザー名前空間の内部で実行します。
これは <a href="/docs.docker.jp.onthefly/engine/security/userns-remap/"><code class="language-plaintext highlighter-rouge">userns-remap</code> モード</a> に非常によく似ています。
ただし<code class="language-plaintext highlighter-rouge">userns-remap</code>モードにおいては、デーモンだけは root 権限で起動します。
rootless モードの場合は、デーモンとコンテナーがそれぞれ root 権限なしに動作します。</p>

<p>rootless モードは、実行モジュールの<code class="language-plaintext highlighter-rouge">SETUID</code>ビットやファイルケーパビリティーは利用しません。
ただし<code class="language-plaintext highlighter-rouge">newuidmap</code>と<code class="language-plaintext highlighter-rouge">newgidmap</code>は利用します。
これらはユーザー名前空間内において、複数の UID/GID を利用するために必要となるものです。</p>

<h2 id="prerequisites">前提条件</h2>

<ul>
  <li>
    <p>ホスト上に<code class="language-plaintext highlighter-rouge">newuidmap</code>と<code class="language-plaintext highlighter-rouge">newgidmap</code>をインストールすることが必要です。
このコマンドは、たいていのディストリビューションにおいて<code class="language-plaintext highlighter-rouge">uidmap</code>パッケージとして提供されています。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/etc/subuid</code>と<code class="language-plaintext highlighter-rouge">/etc/subgid</code>では、ユーザーに対して最低でも 65,536 個のサブ UID/サブ GIDを許容しておくことが必要です。
以下の例において<code class="language-plaintext highlighter-rouge">testuser</code>ユーザーには 65,536 個のサブ UID/サブ GID (231072-296607) が与えられています。</p>
  </li>
</ul>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">id</span> <span class="nt">-u</span>
<span class="go">1001
</span><span class="gp">$</span><span class="w"> </span><span class="nb">whoami</span>
<span class="go">testuser
</span><span class="gp">$</span><span class="w"> </span><span class="nb">grep</span> ^<span class="si">$(</span><span class="nb">whoami</span><span class="si">)</span>: /etc/subuid
<span class="go">testuser:231072:65536
</span><span class="gp">$</span><span class="w"> </span><span class="nb">grep</span> ^<span class="si">$(</span><span class="nb">whoami</span><span class="si">)</span>: /etc/subgid
<span class="go">testuser:231072:65536
</span></code></pre></div></div>

<h3 id="distribution-specific-hint">ディストリビューション固有の情報</h3>

<blockquote>
  <p>メモ: ここでは Ubuntu カーネルの利用をお勧めします。</p>
</blockquote>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" data-target="#hint-ubuntu">Ubuntu</a></li>
  <li><a data-toggle="tab" data-target="#hint-debian">Debian GNU/Linux</a></li>
  <li><a data-toggle="tab" data-target="#hint-arch">Arch Linux</a></li>
  <li><a data-toggle="tab" data-target="#hint-opensuse-sles">openSUSE と SLES</a></li>
  <li><a data-toggle="tab" data-target="#hint-centos8-rhel8-fedora">CentOS 、RHEL 8、Fedora</a></li>
  <li><a data-toggle="tab" data-target="#hint-centos7-rhel7">CentOS 7、RHEL 7</a></li>
</ul>
<div class="tab-content">
  <div id="hint-ubuntu" class="tab-pane fade in active">
    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">dbus-user-session</code>パッケージをインストールしていない場合は、インストールしてください。
<code class="language-plaintext highlighter-rouge">sudo apt-get install -y dbus-user-session</code>を実行して、再ログインしてください。</p>
      </li>
      <li>
        <p>デフォルトで<code class="language-plaintext highlighter-rouge">overlay2</code>ストレージドライバーが有効になっています。
(<a href="https://kernel.ubuntu.com/git/ubuntu/ubuntu-bionic.git/commit/fs/overlayfs?id=3b7da90f28fe1ed4b79ef2d994c81efbc58f1144">Ubuntu 固有のカーネルパッチ</a>)</p>
      </li>
      <li>
        <p>Ubuntu 18.04、20.04、21.04 において動作します。</p>
      </li>
    </ul>
  </div>
  <div id="hint-debian" class="tab-pane fade in">
    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">dbus-user-session</code>パッケージをインストールしていない場合は、インストールしてください。
<code class="language-plaintext highlighter-rouge">sudo apt-get install -y dbus-user-session</code>を実行して、再ログインしてください。</p>
      </li>
      <li>
        <p>Debian 10 においては、<code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code>（または<code class="language-plaintext highlighter-rouge">/etc/sysctl.d</code>）に<code class="language-plaintext highlighter-rouge">kernel.unprivileged_userns_clone=1</code>を追加して、<code class="language-plaintext highlighter-rouge">sudo sysctl --system</code>を実行してください。
この手順は Debian 11 では必要ありません。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">fuse-overlayfs</code>をインストールすることが推奨されるので、<code class="language-plaintext highlighter-rouge">sudo apt-get install -y fuse-overlayfs</code>を実行してください。
<code class="language-plaintext highlighter-rouge">overlay2</code>ストレージドライバーの利用にあたっては、Debian 固有の modprobe オプション <code class="language-plaintext highlighter-rouge">sudo modprobe overlay permit_mounts_in_userns=1</code>を用いることもできます。
ただし <a href="https://github.com/moby/moby/issues/42302">不安定性</a> があるため、利用するのは避けてください。</p>
      </li>
      <li>
        <p>rootless docker では、<code class="language-plaintext highlighter-rouge">slirp4netns</code>のバージョンは<code class="language-plaintext highlighter-rouge">v0.4.0</code>以上が必要です (<code class="language-plaintext highlighter-rouge">vpnkit</code>がインストールされていない場合)。
これを確認するには以下のようにします。</p>

        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>slirp4netns <span class="nt">--version</span>
</code></pre></div>        </div>
        <p>これをまだ入手していない場合は、<code class="language-plaintext highlighter-rouge">sudo apt-get install -y slirp4netns</code>によってインストールするか、あるいは最新版の <a href="https://github.com/rootless-containers/slirp4netns/releases">リリース</a> をダウンロードしてインストールしてください。</p>
      </li>
    </ul>

  </div>
  <div id="hint-arch" class="tab-pane fade in">
    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">fuse-overlayfs</code>をインストールすることが推奨されます。
その場合は<code class="language-plaintext highlighter-rouge">sudo pacman -S fuse-overlayfs</code>を実行します。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code>（または<code class="language-plaintext highlighter-rouge">/etc/sysctl.d</code>）に<code class="language-plaintext highlighter-rouge">kernel.unprivileged_userns_clone=1</code>を追加して、<code class="language-plaintext highlighter-rouge">sudo sysctl --system</code>を実行してください。</p>
      </li>
    </ul>
  </div>
  <div id="hint-opensuse-sles" class="tab-pane fade in">
    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">fuse-overlayfs</code>をインストールすることが推奨されます。
その場合は<code class="language-plaintext highlighter-rouge">sudo zypper install -y fuse-overlayfs</code>を実行します。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">sudo modprobe ip_tables iptable_mangle iptable_nat iptable_filter</code>を実行することが必要です。
設定方法によっては他のディストリビューションにおいても必要なことかもしれません。</p>
      </li>
      <li>
        <p>openSUSE 15 と SLES 15 において動作します。</p>
      </li>
    </ul>
  </div>
  <div id="hint-centos8-rhel8-fedora" class="tab-pane fade in">
    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">fuse-overlayfs</code>をインストールすることが推奨されます。
その場合は<code class="language-plaintext highlighter-rouge">sudo dnf install -y fuse-overlayfs</code>を実行します。</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">sudo dnf install -y iptables</code>が必要かもしれません。</p>
      </li>
      <li>
        <p>Known to work on CentOS 8, RHEL 8, and Fedora 34.</p>
      </li>
    </ul>
  </div>
  <div id="hint-centos7-rhel7" class="tab-pane fade in">
    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code>（または<code class="language-plaintext highlighter-rouge">/etc/sysctl.d</code>）に<code class="language-plaintext highlighter-rouge">user.max_user_namespaces=28633</code>を追加して、<code class="language-plaintext highlighter-rouge">sudo sysctl --system</code>を実行してください。</p>
      </li>
      <li>
        <p>デフォルトでは<code class="language-plaintext highlighter-rouge">systemctl --user</code>は動作しません。
デーモンは sysmted を使わずに直接<code class="language-plaintext highlighter-rouge">dockerd-rootless.sh</code>を起動してください。</p>
      </li>
    </ul>
  </div>
</div>
<p><!-- tab-content --></p>

<h2 id="known-limitations">既知の制約</h2>

<ul>
  <li>以下のストレージドライバーのみがサポートされます。
    <ul>
      <li><code class="language-plaintext highlighter-rouge">overlay2</code>（カーネル 5.11 およびこれ以降が稼働する場合のみ。または Ubuntu 系カーネルのみ。）</li>
      <li><code class="language-plaintext highlighter-rouge">fuse-overlayfs</code>（カーネル 4.18 またはそれ以降の稼動時、そして<code class="language-plaintext highlighter-rouge">fuse-overlayfs</code>インストール時のみ。）</li>
      <li><code class="language-plaintext highlighter-rouge">btrfs</code>（カーネル 4.18 またはそれ以降で利用する場合のみ。あるいは<code class="language-plaintext highlighter-rouge">user_subvol_rm_allowed</code>マウントオプションを使って<code class="language-plaintext highlighter-rouge">~/.local/share/docker</code>をマウントしている場合。）</li>
      <li><code class="language-plaintext highlighter-rouge">vfs</code></li>
    </ul>
  </li>
  <li>cgroup は cgroup v2 および systemd を用いて実行するときのみサポートされます。
<a href="#limiting-resources">リソースの利用制限</a> を参照してください。</li>
  <li>以下の機能はサポートされません。
    <ul>
      <li>AppArmor</li>
      <li>Checkpoint</li>
      <li>Overlay ネットワーク</li>
      <li>SCTP ポートの公開</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">ping</code> コマンドを利用するには <a href="#routing-ping-packets">Routing ping packets</a> を参照してください。</li>
  <li>TCP/UDP の特権ポート（1024 未満）を公開するには <a href="#exposing-privileged-ports">特権ポートの公開</a> を参照してください。</li>
  <li><code class="language-plaintext highlighter-rouge">docker inspect</code>に表示される<code class="language-plaintext highlighter-rouge">IPAddress</code>は RootlessKit のネットワーク名前空間内で名前空間化されます。
これはつまりこの IP アドレスへは、<code class="language-plaintext highlighter-rouge">nsenter</code>を使ってそのネットワーク名前空間にアクセスしない限りは、ホストからアクセスできないということです。</li>
  <li>ホストネットワーク（<code class="language-plaintext highlighter-rouge">docker run --net=host</code>）も RootlessKit 内で名前空間化されます。</li>
  <li>Docker の「data-root」としての NFS マウントはサポートされません。
この制約は rootless モードだけのものではありません。</li>
</ul>

<h2 id="install">インストール</h2>
<blockquote>
  <p><strong>メモ</strong></p>

  <p>If the system-wide Docker daemon is already running, consider disabling it:
<code class="language-plaintext highlighter-rouge">$ sudo systemctl disable --now docker.service docker.socket</code></p>
</blockquote>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" data-target="#install-with-packages">With packages (RPM/DEB)</a></li>
  <li><a data-toggle="tab" data-target="#install-without-packages">Without packages</a></li>
</ul>
<div class="tab-content">
  <div id="install-with-packages" class="tab-pane fade in active">
    <p>If you installed Docker 20.10 or later with <a href="/engine/install">RPM/DEB packages</a>, you should have <code class="language-plaintext highlighter-rouge">dockerd-rootless-setuptool.sh</code> in <code class="language-plaintext highlighter-rouge">/usr/bin</code>.</p>

    <p>Run <code class="language-plaintext highlighter-rouge">dockerd-rootless-setuptool.sh install</code> as a non-root user to set up the daemon:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>dockerd-rootless-setuptool.sh <span class="nb">install</span>
<span class="go">[INFO] Creating /home/testuser/.config/systemd/user/docker.service
</span><span class="c">...
</span><span class="go">[INFO] Installed docker.service successfully.
[INFO] To control docker.service, run: `systemctl --user (start|stop|restart) docker.service`
[INFO] To run docker.service on system startup, run: `sudo loginctl enable-linger testuser`

[INFO] Make sure the following environment variables are set (or add them to ~/.bashrc):

</span><span class="gp">export PATH=/usr/bin:$</span>PATH
<span class="go">export DOCKER_HOST=unix:///run/user/1000/docker.sock
</span></code></pre></div>    </div>

    <p>If <code class="language-plaintext highlighter-rouge">dockerd-rootless-setuptool.sh</code> is not present, you may need to install the <code class="language-plaintext highlighter-rouge">docker-ce-rootless-extras</code> package manually, e.g.,</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> docker-ce-rootless-extras
</code></pre></div>    </div>

  </div>
  <div id="install-without-packages" class="tab-pane fade in">
    <p>If you do not have permission to run package managers like <code class="language-plaintext highlighter-rouge">apt-get</code> and <code class="language-plaintext highlighter-rouge">dnf</code>,
consider using the installation script available at <a href="https://get.docker.com/rootless" target="_blank" rel="noopener" class="_">https://get.docker.com/rootless</a>.
Since static packages are not available for <code class="language-plaintext highlighter-rouge">s390x</code>, hence it is not supported for <code class="language-plaintext highlighter-rouge">s390x</code>.</p>

    <ul class="nav nav-tabs">
      <li class="active"><a data-toggle="tab" href="#origin1">画面表記</a></li>
      <li><a data-toggle="tab" href="#japanese1">日本語訳</a></li>
    </ul>
    <div class="tab-content">
      <div id="origin1" class="tab-pane fade in active">
        <div class="language-console highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl -fsSL https://get.docker.com/rootless | sh
...
[INFO] Creating /home/testuser/.config/systemd/user/docker.service
...
[INFO] Installed docker.service successfully.
[INFO] To control docker.service, run: `systemctl --user (start|stop|restart) docker.service`
[INFO] To run docker.service on system startup, run: `sudo loginctl enable-linger testuser`

[INFO] Make sure the following environment variables are set (or add them to ~/.bashrc):

export PATH=/home/testuser/bin:$PATH
export DOCKER_HOST=unix:///run/user/1000/docker.sock
</code></pre></div>            </div>
          </div>
        </div>
      </div>
      <div id="japanese1" class="tab-pane fade">

        <div class="language-console highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl -fsSL https://get.docker.com/rootless | sh
...
[INFO] Creating /home/testuser/.config/systemd/user/docker.service
...
[INFO] Installed docker.service successfully.
[INFO] To control docker.service, run: `systemctl --user (start|stop|restart) docker.service`
[INFO] To run docker.service on system startup, run: `sudo loginctl enable-linger testuser`

[INFO] Make sure the following environment variables are set (or add them to ~/.bashrc):

export PATH=/home/testuser/bin:$PATH
export DOCKER_HOST=unix:///run/user/1000/docker.sock
</code></pre></div>            </div>
          </div>
        </div>

      </div>
    </div>

    <p>The binaries will be installed at <code class="language-plaintext highlighter-rouge">~/bin</code>.</p>
  </div>
</div>
<p><!-- tab-content --></p>

<p>See <a href="#troubleshooting">Troubleshooting</a> if you faced an error.</p>

<h2 id="uninstall">アンインストール</h2>

<p>To remove the systemd service of the Docker daemon, run <code class="language-plaintext highlighter-rouge">dockerd-rootless-setuptool.sh uninstall</code>:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>dockerd-rootless-setuptool.sh uninstall
<span class="go">+ systemctl --user stop docker.service
+ systemctl --user disable docker.service
Removed /home/testuser/.config/systemd/user/default.target.wants/docker.service.
[INFO] Uninstalled docker.service
[INFO] This uninstallation tool does NOT remove Docker binaries and data.
[INFO] To remove data, run: `/usr/bin/rootlesskit rm -rf /home/testuser/.local/share/docker`
</span></code></pre></div></div>

<p>Unset environment variables PATH and DOCKER_HOST if you have added them to <code class="language-plaintext highlighter-rouge">~/.bashrc</code>.</p>

<p>To remove the data directory, run <code class="language-plaintext highlighter-rouge">rootlesskit rm -rf ~/.local/share/docker</code>.</p>

<p>To remove the binaries, remove <code class="language-plaintext highlighter-rouge">docker-ce-rootless-extras</code> package if you installed Docker with package managers.
If you installed Docker with https://get.docker.com/rootless (<a href="#install">Install without packages</a>),
remove the binary files under <code class="language-plaintext highlighter-rouge">~/bin</code>:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cd</span> ~/bin
<span class="gp">$</span><span class="w"> </span><span class="nb">rm</span> <span class="nt">-f</span> containerd containerd-shim containerd-shim-runc-v2 ctr docker docker-init docker-proxy dockerd dockerd-rootless-setuptool.sh dockerd-rootless.sh rootlesskit rootlesskit-docker-proxy runc vpnkit
</code></pre></div></div>

<h2 id="usage">利用方法</h2>

<h3 id="daemon">デーモン</h3>
<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" data-target="#usage-with-systemd">With systemd (Highly recommended)</a></li>
  <li><a data-toggle="tab" data-target="#usage-without-systemd">Without systemd</a></li>
</ul>
<div class="tab-content">
  <div id="usage-with-systemd" class="tab-pane fade in active">
    <p>The systemd unit file is installed as  <code class="language-plaintext highlighter-rouge">~/.config/systemd/user/docker.service</code>.</p>

    <p>Use <code class="language-plaintext highlighter-rouge">systemctl --user</code> to manage the lifecycle of the daemon:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>systemctl <span class="nt">--user</span> start docker
</code></pre></div>    </div>

    <p>システム起動時にデーモンを起動するには、Systemd サービスに対して linger を有効にします。</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>systemctl <span class="nt">--user</span> <span class="nb">enable </span>docker
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>loginctl enable-linger <span class="si">$(</span><span class="nb">whoami</span><span class="si">)</span>
</code></pre></div>    </div>

    <p>Starting Rootless Docker as a systemd-wide service (<code class="language-plaintext highlighter-rouge">/etc/systemd/system/docker.service</code>)
is not supported, even with the <code class="language-plaintext highlighter-rouge">User=</code> directive.</p>

  </div>
  <div id="usage-without-systemd" class="tab-pane fade in">
    <p>To run the daemon directly without systemd, you need to run <code class="language-plaintext highlighter-rouge">dockerd-rootless.sh</code> instead of <code class="language-plaintext highlighter-rouge">dockerd</code>.</p>

    <p>The following environment variables must be set:</p>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">$HOME</code>: the home directory</li>
      <li><code class="language-plaintext highlighter-rouge">$XDG_RUNTIME_DIR</code>: an ephemeral directory that is only accessible by the expected user, e,g, <code class="language-plaintext highlighter-rouge">~/.docker/run</code>.
The directory should be removed on every host shutdown.
The directory can be on tmpfs, however, should not be under <code class="language-plaintext highlighter-rouge">/tmp</code>.
Locating this directory under <code class="language-plaintext highlighter-rouge">/tmp</code> might be vulnerable to TOCTOU attack.</li>
    </ul>

  </div>
</div>
<p><!-- tab-content --></p>

<p>ディレクトリパスについて触れておきます。</p>

<ul>
  <li>ソケットパスはデフォルトで<code class="language-plaintext highlighter-rouge">$XDG_RUNTIME_DIR/docker.sock</code>に設定されます。
<code class="language-plaintext highlighter-rouge">$XDG_RUNTIME_DIR</code>は通常<code class="language-plaintext highlighter-rouge">/run/user/$UID</code>に設定されます。</li>
  <li>データディレクトリはデフォルトで<code class="language-plaintext highlighter-rouge">~/.local/share/docker</code>に設定されます。
The data dir should not be on NFS.</li>
  <li>The daemon config dir is set to <code class="language-plaintext highlighter-rouge">~/.config/docker</code> by default.
This directory is different from <code class="language-plaintext highlighter-rouge">~/.docker</code> that is used by the client.</li>
</ul>

<h3 id="client">クライアント</h3>

<p>ソケットパスまたは CLI コンテキストを明示的に指定する必要があります。</p>

<p><code class="language-plaintext highlighter-rouge">$DOCKER_HOST</code>を用いてソケットパス指定するには以下のようにします。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">export </span><span class="nv">DOCKER_HOST</span><span class="o">=</span>unix://<span class="nv">$XDG_RUNTIME_DIR</span>/docker.sock
<span class="gp">$</span><span class="w"> </span>docker run <span class="nt">-d</span> <span class="nt">-p</span> 8080:80 nginx
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">docker context</code>を用いて CLI コンテキストを指定するには以下のようにします。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>docker context use rootless
<span class="go">rootless
Current context is now "rootless"
</span><span class="gp">$</span><span class="w"> </span>docker run <span class="nt">-d</span> <span class="nt">-p</span> 8080:80 nginx
</code></pre></div></div>

<h2 id="best-practices">ベストプラクティス</h2>

<h3 id="rootless-docker-in-docker">Rootless Docker in Docker</h3>

<p>「完全な root」で動作する Docker 内において Rootless Docker を起動するには、<code class="language-plaintext highlighter-rouge">docker:&lt;version&gt;-dind</code>イメージの代わりに<code class="language-plaintext highlighter-rouge">docker:&lt;version&gt;-dind-rootless</code>イメージを利用します。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>docker run <span class="nt">-d</span> <span class="nt">--name</span> dind-rootless <span class="nt">--privileged</span> docker:20.10-dind-rootless
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">docker:&lt;version&gt;-dind-rootless</code>イメージは非 root ユーザー（UID 1000）により動作します。
ただし seccomp、AppArmor、マウントマスクを無効化するには<code class="language-plaintext highlighter-rouge">--privileged</code>の指定が必要です。</p>

<h3 id="expose-docker-api-socket-through-tcp">TCP を通じた Docker API ソケットの公開</h3>

<p>TCP を通じて Docker API ソケットを公開するには、<code class="language-plaintext highlighter-rouge">dockerd-rootless.sh</code>の実行にあたって<code class="language-plaintext highlighter-rouge">DOCKERD_ROOTLESS_ROOTLESSKIT_FLAGS="-p 0.0.0.0:2376:2376/tcp"</code>を指定する必要があります。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nv">DOCKERD_ROOTLESS_ROOTLESSKIT_FLAGS</span><span class="o">=</span><span class="s2">"-p 0.0.0.0:2376:2376/tcp"</span> <span class="se">\</span>
  dockerd-rootless.sh <span class="se">\</span>
  <span class="nt">-H</span> tcp://0.0.0.0:2376 <span class="se">\</span>
  <span class="nt">--tlsverify</span> <span class="nt">--tlscacert</span><span class="o">=</span>ca.pem <span class="nt">--tlscert</span><span class="o">=</span>cert.pem <span class="nt">--tlskey</span><span class="o">=</span>key.pem
</code></pre></div></div>

<h3 id="expose-docker-api-socket-through-ssh">SSH を通じた Docker API ソケットの公開</h3>

<p>SSH を通じて Docker API ソケットを公開するには、リモートホスト上において<code class="language-plaintext highlighter-rouge">$DOCKER_HOST</code>を設定することが必要です。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>ssh <span class="nt">-l</span> &lt;REMOTEUSER&gt; &lt;REMOTEHOST&gt; <span class="s1">'echo $DOCKER_HOST'</span>
<span class="go">unix:///run/user/1001/docker.sock
</span><span class="gp">$</span><span class="w"> </span>docker <span class="nt">-H</span> ssh://&lt;REMOTEUSER&gt;@&lt;REMOTEHOST&gt; run ...
</code></pre></div></div>

<h3 id="routing-ping-packets">ping パケットのルーティング</h3>

<p>ディストリビューションの中には、デフォルトで<code class="language-plaintext highlighter-rouge">ping</code>が動作しないものがあります。</p>

<p><code class="language-plaintext highlighter-rouge">ping</code>を利用するためには<code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code>に（あるいは<code class="language-plaintext highlighter-rouge">/etc/sysctl.d</code>に）<code class="language-plaintext highlighter-rouge">net.ipv4.ping_group_range = 0   2147483647</code>を追加して<code class="language-plaintext highlighter-rouge">sudo sysctl --system</code>を実行します。</p>

<h3 id="exposing-privileged-ports">特権ポートの公開</h3>

<p>特権ポート（1024 未満）を公開するには、<code class="language-plaintext highlighter-rouge">rootlesskit</code>バイナリに対して<code class="language-plaintext highlighter-rouge">CAP_NET_BIND_SERVICE</code>を設定します。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>setcap <span class="nv">cap_net_bind_service</span><span class="o">=</span>ep <span class="nv">$HOME</span>/bin/rootlesskit
</code></pre></div></div>

<p>または<code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code>（あるいは<code class="language-plaintext highlighter-rouge">/etc/sysctl.d</code>）に<code class="language-plaintext highlighter-rouge">net.ipv4.ip_unprivileged_port_start=0</code>を追加して<code class="language-plaintext highlighter-rouge">sudo sysctl --system</code>を実行します。</p>

<h3 id="limiting-resources">リソースの利用制限</h3>
<p>Limiting resources with cgroup-related <code class="language-plaintext highlighter-rouge">docker run</code> flags such as <code class="language-plaintext highlighter-rouge">--cpus</code>, <code class="language-plaintext highlighter-rouge">--memory</code>, <code class="language-plaintext highlighter-rouge">--pids-limit</code>
is supported only when running with cgroup v2 and systemd.
See <a href="/docs.docker.jp.onthefly/config/containers/runmetrics/">Changing cgroup version</a> to enable cgroup v2.</p>

<p>If <code class="language-plaintext highlighter-rouge">docker info</code> shows <code class="language-plaintext highlighter-rouge">none</code> as <code class="language-plaintext highlighter-rouge">Cgroup Driver</code>, the conditions are not satisfied.
When these conditions are not satisfied, rootless mode ignores the cgroup-related <code class="language-plaintext highlighter-rouge">docker run</code> flags.
See <a href="#limiting-resources-without-cgroup">Limiting resources without cgroup</a> for workarounds.</p>

<p>If <code class="language-plaintext highlighter-rouge">docker info</code> shows <code class="language-plaintext highlighter-rouge">systemd</code> as <code class="language-plaintext highlighter-rouge">Cgroup Driver</code>, the conditions are satisfied.
However, typically, only <code class="language-plaintext highlighter-rouge">memory</code> and <code class="language-plaintext highlighter-rouge">pids</code> controllers are delegated to non-root users by default.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cat</span> /sys/fs/cgroup/user.slice/user-<span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>.slice/user@<span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>.service/cgroup.controllers
<span class="go">memory pids
</span></code></pre></div></div>

<p>To allow delegation of all controllers, you need to change the systemd configuration as follows:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span><span class="nb">mkdir</span> <span class="nt">-p</span> /etc/systemd/system/user@.service.d
<span class="gp">#</span><span class="w"> </span><span class="nb">cat</span> <span class="o">&gt;</span> /etc/systemd/system/user@.service.d/delegate.conf <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
</span><span class="go">[Service]
Delegate=cpu cpuset io memory pids
EOF
</span><span class="gp">#</span><span class="w"> </span>systemctl daemon-reload
</code></pre></div></div>

<blockquote>
  <p><strong>メモ</strong></p>

  <p><code class="language-plaintext highlighter-rouge">cpuset</code>のデリゲートには systemd 244 またはそれ以降が必要です。</p>
</blockquote>

<h4 id="limiting-resources-without-cgroup">Limiting resources without cgroup</h4>
<p>Even when cgroup is not available, you can still use the traditional <code class="language-plaintext highlighter-rouge">ulimit</code> and <a href="https://github.com/opsengine/cpulimit"><code class="language-plaintext highlighter-rouge">cpulimit</code></a>,
though they work in process-granularity rather than in container-granularity,
and can be arbitrarily disabled by the container process.</p>

<p>たとえば以下です。</p>

<ul>
  <li>（<code class="language-plaintext highlighter-rouge">docker run --cpus 0.5</code>と同じように）CPU 利用量を 0.5 コアに制限するには、<code class="language-plaintext highlighter-rouge">docker run &lt;IMAGE&gt; cpulimit --limit=50 --include-children &lt;COMMAND&gt;</code> を実行します。</li>
  <li>
    <p>（<code class="language-plaintext highlighter-rouge">docker run --memory 64m</code>と同じように）VSZ の最大値を 64 MiB に制限するには、<code class="language-plaintext highlighter-rouge">docker run &lt;IMAGE&gt; sh -c "ulimit -v 65536; &lt;COMMAND&gt;"</code>を実行します。</p>
  </li>
  <li>（<code class="language-plaintext highlighter-rouge">docker run --pids-limit=100</code>と同じように）最大プロセス数を UID 2000 の名前空間ごとに 100 とするには<code class="language-plaintext highlighter-rouge">docker run --user 2000 --ulimit nproc=100 &lt;IMAGE&gt; &lt;COMMAND&gt;</code>を実行します。</li>
</ul>

<h2 id="troubleshooting">トラブルシューティング</h2>

<h3 id="errors-when-starting-the-docker-daemon">Errors when starting the Docker daemon</h3>

<p><strong>[rootlesskit:parent] error: failed to start the child: fork/exec /proc/self/exe: operation not permitted</strong></p>

<p>This error occurs mostly when the value of <code class="language-plaintext highlighter-rouge">/proc/sys/kernel/unprivileged_userns_clone </code> is set to 0:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cat</span> /proc/sys/kernel/unprivileged_userns_clone
<span class="go">0
</span></code></pre></div></div>

<p>To fix this issue, add  <code class="language-plaintext highlighter-rouge">kernel.unprivileged_userns_clone=1</code> to
<code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code> (or <code class="language-plaintext highlighter-rouge">/etc/sysctl.d</code>) and run <code class="language-plaintext highlighter-rouge">sudo sysctl --system</code>.</p>

<p><strong>[rootlesskit:parent] error: failed to start the child: fork/exec /proc/self/exe: no space left on device</strong></p>

<p>This error occurs mostly when the value of <code class="language-plaintext highlighter-rouge">/proc/sys/user/max_user_namespaces</code> is too small:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cat</span> /proc/sys/user/max_user_namespaces
<span class="go">0
</span></code></pre></div></div>

<p>To fix this issue, add  <code class="language-plaintext highlighter-rouge">user.max_user_namespaces=28633</code> to
<code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code> (or <code class="language-plaintext highlighter-rouge">/etc/sysctl.d</code>) and run <code class="language-plaintext highlighter-rouge">sudo sysctl --system</code>.</p>

<p><strong>[rootlesskit:parent] error: failed to setup UID/GID map: failed to compute uid/gid map: No subuid ranges found for user 1001 (“testuser”)</strong></p>

<p>This error occurs when <code class="language-plaintext highlighter-rouge">/etc/subuid</code> and <code class="language-plaintext highlighter-rouge">/etc/subgid</code> are not configured. See <a href="#prerequisites">Prerequisites</a>.</p>

<p><strong>could not get XDG_RUNTIME_DIR</strong></p>

<p>This error occurs when <code class="language-plaintext highlighter-rouge">$XDG_RUNTIME_DIR</code> is not set.</p>

<p>On a non-systemd host, you need to create a directory and then set the path:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">export </span><span class="nv">XDG_RUNTIME_DIR</span><span class="o">=</span><span class="nv">$HOME</span>/.docker/xrd
<span class="gp">$</span><span class="w"> </span><span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$XDG_RUNTIME_DIR</span>
<span class="gp">$</span><span class="w"> </span><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$XDG_RUNTIME_DIR</span>
<span class="gp">$</span><span class="w"> </span>dockerd-rootless.sh
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong>:
You must remove the directory every time you log out.</p>
</blockquote>

<p>On a systemd host, log into the host using <code class="language-plaintext highlighter-rouge">pam_systemd</code> (see below).
The value is automatically set to <code class="language-plaintext highlighter-rouge">/run/user/$UID</code> and cleaned up on every logout.</p>

<p><strong><code class="language-plaintext highlighter-rouge">systemctl --user</code> fails with “Failed to connect to bus: No such file or directory”</strong></p>

<p>This error occurs mostly when you switch from the root user to an non-root user with <code class="language-plaintext highlighter-rouge">sudo</code>:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span><span class="nb">sudo</span> <span class="nt">-iu</span> testuser
<span class="gp">$</span><span class="w"> </span>systemctl <span class="nt">--user</span> start docker
<span class="go">Failed to connect to bus: No such file or directory
</span></code></pre></div></div>

<p>Instead of <code class="language-plaintext highlighter-rouge">sudo -iu &lt;USERNAME&gt;</code>, you need to log in using <code class="language-plaintext highlighter-rouge">pam_systemd</code>. For example:</p>

<ul>
  <li>Log in through the graphic console</li>
  <li><code class="language-plaintext highlighter-rouge">ssh &lt;USERNAME&gt;@localhost</code></li>
  <li><code class="language-plaintext highlighter-rouge">machinectl shell &lt;USERNAME&gt;@</code></li>
</ul>

<p><strong>The daemon does not start up automatically</strong></p>

<p>You need <code class="language-plaintext highlighter-rouge">sudo loginctl enable-linger $(whoami)</code> to enable the daemon to start
up automatically. See <a href="#usage">Usage</a>.</p>

<p><strong>iptables failed: iptables -t nat -N DOCKER: Fatal: can’t open lock file /run/xtables.lock: Permission denied</strong></p>

<p>This error may happen with an older version of Docker when SELinux is enabled on the host.</p>

<p>The issue has been fixed in Docker 20.10.8.
A known workaround for older version of Docker is to run the following commands to disable SELinux for <code class="language-plaintext highlighter-rouge">iptables</code>:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>dnf <span class="nb">install</span> <span class="nt">-y</span> policycoreutils-python-utils <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>semanage permissive <span class="nt">-a</span> iptables_t
</code></pre></div></div>

<h3 id="docker-pull-errors"><code class="language-plaintext highlighter-rouge">docker pull</code> errors</h3>

<p><strong>docker: failed to register layer: Error processing tar file(exit status 1): lchown &lt;FILE&gt;: invalid argument</strong></p>

<p>This error occurs when the number of available entries in <code class="language-plaintext highlighter-rouge">/etc/subuid</code> or
<code class="language-plaintext highlighter-rouge">/etc/subgid</code> is not sufficient. The number of entries required vary across
images. However, 65,536 entries are sufficient for most images. See
<a href="#prerequisites">Prerequisites</a>.</p>

<p><strong>docker: failed to register layer: ApplyLayer exit status 1 stdout:  stderr: lchown &lt;FILE&gt;: operation not permitted</strong></p>

<p>This error occurs mostly when <code class="language-plaintext highlighter-rouge">~/.local/share/docker</code> is located on NFS.</p>

<p>A workaround is to specify non-NFS <code class="language-plaintext highlighter-rouge">data-root</code> directory in <code class="language-plaintext highlighter-rouge">~/.config/docker/daemon.json</code> as follows:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"data-root"</span><span class="p">:</span><span class="s2">"/somewhere-out-of-nfs"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="docker-run-errors"><code class="language-plaintext highlighter-rouge">docker run</code> errors</h3>

<p><strong>docker: Error response from daemon: OCI runtime create failed: ...: read unix @-&gt;/run/systemd/private: read: connection reset by peer: unknown.</strong></p>

<p>This error occurs on cgroup v2 hosts mostly when the dbus daemon is not running for the user.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>systemctl <span class="nt">--user</span> is-active dbus
<span class="go">inactive

</span><span class="gp">$</span><span class="w"> </span>docker run hello-world
<span class="go">docker: Error response from daemon: OCI runtime create failed: container_linux.go:380: starting container process caused: process_linux.go:385: applying cgroup configuration for process caused: error while starting unit "docker
-931c15729b5a968ce803784d04c7421f791d87e5ca1891f34387bb9f694c488e.scope" with properties [{Name:Description Value:"libcontainer container 931c15729b5a968ce803784d04c7421f791d87e5ca1891f34387bb9f694c488e"} {Name:Slice Value:"use
r.slice"} {Name:PIDs Value:@au [4529]} {Name:Delegate Value:true} {Name:MemoryAccounting Value:true} {Name:CPUAccounting Value:true} {Name:IOAccounting Value:true} {Name:TasksAccounting Value:true} {Name:DefaultDependencies Val
</span><span class="gp">ue:false}]: read unix @-&gt;</span>/run/systemd/private: <span class="nb">read</span>: connection reset by peer: unknown.
</code></pre></div></div>

<p>To fix the issue, run <code class="language-plaintext highlighter-rouge">sudo apt-get install -y dbus-user-session</code> or <code class="language-plaintext highlighter-rouge">sudo dnf install -y dbus-daemon</code>, and then relogin.</p>

<p>If the error still occurs, try running <code class="language-plaintext highlighter-rouge">systemctl --user enable --now dbus</code> (without sudo).</p>

<p><strong><code class="language-plaintext highlighter-rouge">--cpus</code>, <code class="language-plaintext highlighter-rouge">--memory</code>, and <code class="language-plaintext highlighter-rouge">--pids-limit</code> are ignored</strong></p>

<p>This is an expected behavior on cgroup v1 mode.
To use these flags, the host needs to be configured for enabling cgroup v2.
For more information, see <a href="#limiting-resources">Limiting resources</a>.</p>

<h3 id="networking-errors">Networking errors</h3>

<p><strong><code class="language-plaintext highlighter-rouge">docker run -p</code> fails with <code class="language-plaintext highlighter-rouge">cannot expose privileged port</code></strong></p>

<p><code class="language-plaintext highlighter-rouge">docker run -p</code> fails with this error when a privileged port (&lt; 1024) is specified as the host port.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>docker run <span class="nt">-p</span> 80:80 nginx:alpine
<span class="gp">docker: Error response from daemon: driver failed programming external connectivity on endpoint focused_swanson (9e2e139a9d8fc92b37c36edfa6214a6e986fa2028c0cc359812f685173fa6df7): Error starting userland proxy: error while calling PortManager.AddPort(): cannot expose privileged port 80, you might need to add "net.ipv4.ip_unprivileged_port_start=0" (currently 1024) to /etc/sysctl.conf, or set CAP_NET_BIND_SERVICE on rootlesskit binary, or choose a larger port number (&gt;</span><span class="o">=</span> 1024<span class="o">)</span>: listen tcp 0.0.0.0:80: <span class="nb">bind</span>: permission denied.
</code></pre></div></div>

<p>When you experience this error, consider using an unprivileged port instead. For example, 8080 instead of 80.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>docker run <span class="nt">-p</span> 8080:80 nginx:alpine
</code></pre></div></div>

<p>To allow exposing privileged ports, see <a href="#exposing-privileged-ports">Exposing privileged ports</a>.</p>

<p><strong>ping doesn’t work</strong></p>

<p>Ping does not work when <code class="language-plaintext highlighter-rouge">/proc/sys/net/ipv4/ping_group_range</code> is set to <code class="language-plaintext highlighter-rouge">1 0</code>:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cat</span> /proc/sys/net/ipv4/ping_group_range
<span class="go">1       0
</span></code></pre></div></div>

<p>For details, see <a href="#routing-ping-packets">Routing ping packets</a>.</p>

<p><strong><code class="language-plaintext highlighter-rouge">IPAddress</code> shown in <code class="language-plaintext highlighter-rouge">docker inspect</code> is unreachable</strong></p>

<p>This is an expected behavior, as the daemon is namespaced inside RootlessKit’s
network namespace. Use <code class="language-plaintext highlighter-rouge">docker run -p</code> instead.</p>

<p><strong><code class="language-plaintext highlighter-rouge">--net=host</code> doesn’t listen ports on the host network namespace</strong></p>

<p>This is an expected behavior, as the daemon is namespaced inside RootlessKit’s
network namespace. Use <code class="language-plaintext highlighter-rouge">docker run -p</code> instead.</p>

<p><strong>Network is slow</strong></p>

<p>Docker with rootless mode uses <a href="https://github.com/rootless-containers/slirp4netns">slirp4netns</a> as the default network stack if slirp4netns v0.4.0 or later is installed.
If slirp4netns is not installed, Docker falls back to <a href="https://github.com/moby/vpnkit">VPNKit</a>.</p>

<p>Installing slirp4netns may improve the network throughput.
See <a href="https://github.com/rootless-containers/rootlesskit/tree/v0.13.0#network-drivers">RootlessKit documentation</a> for the benchmark result.</p>

<p>Also, changing MTU value may improve the throughput.
The MTU value can be specified by creating <code class="language-plaintext highlighter-rouge">~/.config/systemd/user/docker.service.d/override.conf</code> with the following content:</p>

<div class="language-systemd highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">[Service]</span>
<span class="nt">Environment</span><span class="p">=</span>"DOCKERD_ROOTLESS_ROOTLESSKIT_MTU=&lt;INTEGER&gt;"
</code></pre></div></div>

<p>And then restart the daemon:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>systemctl <span class="nt">--user</span> daemon-reload
<span class="gp">$</span><span class="w"> </span>systemctl <span class="nt">--user</span> restart docker
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">docker run -p</code> does not propagate source IP addresses</strong></p>

<p>The source IP addresses can be propagated by creating <code class="language-plaintext highlighter-rouge">~/.config/systemd/user/docker.service.d/override.conf</code> with the following content:</p>

<div class="language-systemd highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">[Service]</span>
<span class="nt">Environment</span><span class="p">=</span>"DOCKERD_ROOTLESS_ROOTLESSKIT_PORT_DRIVER=slirp4netns"
</code></pre></div></div>

<p>And then restart the daemon:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>systemctl <span class="nt">--user</span> daemon-reload
<span class="gp">$</span><span class="w"> </span>systemctl <span class="nt">--user</span> restart docker
</code></pre></div></div>

<p>Note that this configuration decreases throughput.
See <a href="https://github.com/rootless-containers/rootlesskit/tree/v0.13.0#port-drivers">RootlessKit documentation</a> for the benchmark result.</p>

<h3 id="tips-for-debugging">Tips for debugging</h3>
<p><strong>Entering into <code class="language-plaintext highlighter-rouge">dockerd</code> namespaces</strong></p>

<p>The <code class="language-plaintext highlighter-rouge">dockerd-rootless.sh</code> script executes <code class="language-plaintext highlighter-rouge">dockerd</code> in its own user, mount, and network namespaces.</p>

<p>For debugging, you can enter the namespaces by running
<code class="language-plaintext highlighter-rouge">nsenter -U --preserve-credentials -n -m -t $(cat $XDG_RUNTIME_DIR/docker.pid)</code>.</p>
<span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span style="vertical-align: 2px"><a href="/docs.docker.jp.onthefly/search/?q=security">security</a>, <a href="/docs.docker.jp.onthefly/search/?q=namespaces">namespaces</a>, <a href="/docs.docker.jp.onthefly/search/?q=rootless">rootless</a></span><div class="ratings-div"><div id="pd_rating_holder_8453675"></div></div></section>
                    </main>
                    <nav class="col-nav">
                        <div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
                            <div id="navbar" class="nav-sidebar">
                                <ul class="nav hidden-md hidden-lg"></ul>
                                <ul class="nav" id="jsTOCLeftNav"></ul>
                            </div>
                        </div>
                    </nav>
                    <div class="col-toc">
                        <div class="sidebar hidden-xs hidden-sm">
                            <div class="toc-nav">
                                <div class="feedback-links">
                                    <ul><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/edit/master/src/engine/security/rootless.ch"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 本ページの編集</a></li><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/issues/new?body=File: [engine/security/rootless.ch](https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/rootless/)" class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 変更リクエスト</a></li>
                                        <li><div class="toggle-mode">
  <div class="icon">
      <i class="fa fa-sun-o" aria-hidden="true"></i>
  </div>
  <div class="toggle-switch">
      <label class="switch">
          <input type="checkbox" id="switch-style">
          <span class="slider round"></span>
      </label>
  </div>
  <div class="icon">
      <i class="fa fa-moon-o" aria-hidden="true"></i>
  </div>
</div>
</li>
                                    </ul>
                                </div><div id="side-toc-title">本ページ内:</div>
<ul id="my_toc" class="inline_toc">
  <li><a href="#how-it-works" class="nomunge">どのように動作するか</a></li>
  <li><a href="#prerequisites" class="nomunge">前提条件</a>
    <ul>
      <li><a href="#distribution-specific-hint" class="nomunge">ディストリビューション固有の情報</a></li>
    </ul>
  </li>
  <li><a href="#known-limitations" class="nomunge">既知の制約</a></li>
  <li><a href="#install" class="nomunge">インストール</a></li>
  <li><a href="#uninstall" class="nomunge">アンインストール</a></li>
  <li><a href="#usage" class="nomunge">利用方法</a>
    <ul>
      <li><a href="#daemon" class="nomunge">デーモン</a></li>
      <li><a href="#client" class="nomunge">クライアント</a></li>
    </ul>
  </li>
  <li><a href="#best-practices" class="nomunge">ベストプラクティス</a>
    <ul>
      <li><a href="#rootless-docker-in-docker" class="nomunge">Rootless Docker in Docker</a></li>
      <li><a href="#expose-docker-api-socket-through-tcp" class="nomunge">TCP を通じた Docker API ソケットの公開</a></li>
      <li><a href="#expose-docker-api-socket-through-ssh" class="nomunge">SSH を通じた Docker API ソケットの公開</a></li>
      <li><a href="#routing-ping-packets" class="nomunge">ping パケットのルーティング</a></li>
      <li><a href="#exposing-privileged-ports" class="nomunge">特権ポートの公開</a></li>
      <li><a href="#limiting-resources" class="nomunge">リソースの利用制限</a></li>
    </ul>
  </li>
  <li><a href="#troubleshooting" class="nomunge">トラブルシューティング</a>
    <ul>
      <li><a href="#errors-when-starting-the-docker-daemon" class="nomunge">Errors when starting the Docker daemon</a></li>
      <li><a href="#docker-pull-errors" class="nomunge">docker pull errors</a></li>
      <li><a href="#docker-run-errors" class="nomunge">docker run errors</a></li>
      <li><a href="#networking-errors" class="nomunge">Networking errors</a></li>
      <li><a href="#tips-for-debugging" class="nomunge">Tips for debugging</a></li>
    </ul>
  </li>
</ul>

</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">
          
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products" target="_blank" rel="noopener">製品ラインアップ</a></b></li>
                        <li><a href="https://www.docker.com/products/personal" target="_blank" rel="noopener">Docker Personal</a></li>
                        <li><a href="https://www.docker.com/products/pro" target="_blank" rel="noopener">Docker Pro</a></li>
                        <li><a href="https://www.docker.com/products/team" target="_blank" rel="noopener">Docker Team</a></li>
                        <li><a href="https://www.docker.com/products/business" target="_blank" rel="noopener">Docker Business</a></li>
                        <li><a href="https://www.docker.com/products" target="_blank" rel="noopener">サブスクリプション比較</a></li>
                        <li><b><a href="https://www.docker.com/" target="_blank" rel="noopener">機能</a></b></li>
                        <li><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">Docker Desktop</a></li>
                        <li><a href="https://www.docker.com/products/docker-hub" target="_blank" rel="noopener">Docker Hub</a></li>
                        <li><a href="https://www.docker.com/products/secure-software-supply-chain" target="_blank" rel="noopener">セキュアなソフトウェアサプライチェーン</a></li>
                        <li><a href="https://www.docker.com/products/container-runtime" target="_blank" rel="noopener">コンテナーランタイム</a></li>
                        <li><a href="https://www.docker.com/products/developer-tools" target="_blank" rel="noopener">開発ツール</a></li>
                        <li><a href="https://www.docker.com/partners" target="_blank" rel="noopener">信頼できるコンテント</a></li>
                        <li><a href="https://www.docker.com/roadmap" target="_blank" rel="noopener">Docker 製品ロードマップ</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">開発者</a></b></li>
                        <li><a href="https://www.docker.com/use-cases" target="_blank" rel="noopener">利用例</a></li>
                        <li><a href="https://docs.docker.com/get-started/" target="_blank" rel="noopener">はじめよう</a></li>
                        <li><a href="https://www.docker.com/blog/" target="_blank" rel="noopener">ブログ</a></li>
                        <li><a href="https://www.docker.com/docker-community" target="_blank" rel="noopener">コミュニティー</a></li>
                        <li><a href="https://www.docker.com/open-source" target="_blank" rel="noopener">オープンソース</a></li>
                        <li><a href="https://www.docker.com/community/get-involved/developer-preview" target="_blank" rel="noopener">プレビュープログラム</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">価格体系</a></b></li>
                        <li><a href="https://www.docker.com/pricing/faq" target="_blank" rel="noopener">FAQ</a></li>
                        <li><a href="https://www.docker.com/partners/programs" target="_blank" rel="noopener">Docker 認定公開者向けプログラム</a></li>
                        <li><a href="https://www.docker.com/partners" target="_blank" rel="noopener">パートナー</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/company" target="_blank" rel="noopener">会社概要</a></b></li>
                        <li><a href="https://www.docker.com/what-container" target="_blank" rel="noopener">コンテナーって何？</a></li>
                        <li><a href="https://www.docker.com/why-docker" target="_blank" rel="noopener">なぜ Docker？</a></li>
                        <li><a href="https://www.docker.com/events" target="_blank" rel="noopener">仮想イベント</a></li>
                        <li><a href="https://www.docker.com/swag" target="_blank" rel="noopener">Swag ストア
                        </a></li>
                        <li><a href="https://www.docker.com/company/newsroom" target="_blank" rel="noopener">ニュースルーム</a></li>
                        <li><a href="https://www.docker.com/careers" target="_blank" rel="noopener">採用情報</a></li>
                        <li><a href="https://www.docker.com/company/contact" target="_blank" rel="noopener">連絡先</a></li>
                        <li><a href="https://www.docker.com/customers" target="_blank" rel="noopener">顧客</a></li>
                        <li><a href="https://www.docker.com/newsletter-subscription" target="_blank" rel="noopener">ニュースレター</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="https://www.docker.com/legal/docker-terms-service" target="_blank" rel="noopener">サービス契約</a></li>
                        <li><a href="https://status.docker.com/" target="_blank" rel="noopener">ステータス</a></li>
                        <li><a href="https://www.docker.com/legal" target="_blank" rel="noopener">法的情報</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2013-2021 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="https://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="https://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-slideshare"><a href="https://www.slideshare.net/docker">Slideshare</a></li>
                    <li class="fa fa-reddit"><a href="https://www.reddit.com/r/docker">Reddit</a></li>
                </ul>
            </div>
        </div>
    </div>

    </footer>
    <script>const pageURL = "/engine/security/rootless/";</script></body>
</html>
