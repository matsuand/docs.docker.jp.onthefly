<!DOCTYPE html>
<!-- Page generated 2022-04-25 09:39:05 +0900-->
<html lang="ja"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>dockerd | Docker ドキュメント</title>
  <meta name="description" content="The daemon command description and usage" />
  <meta name="keywords" content="container, daemon, runtime">
  <link rel="canonical" href="https://localhost:4000{{ site.baseurl }}/engine/reference/commandline/dockerd/" />

  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <link rel="apple-touch-icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta name="msapplication-TileImage" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico">
  <meta property="og:image" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
  <meta name="theme-color" content="#2496ed" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- hide elements that are only shown without JavaScript enabled -->
  <script>document.documentElement.classList.add('js')</script>
  <style>html.js .no-js { display: none !important; }</style><script defer src="/docs.docker.jp.onthefly/js/theme-switcher.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/anchorlinks.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/jquery.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/docs.js"></script><script defer src="/docs.docker.jp.onthefly/js/search.js"></script><link rel="preload" as="font" href="https://fonts.gstatic.com/s/opensans/v18/mem8YaGs126MiZpBA-UFVZ0bf8pkAg.woff2" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/geomanist/hinted-Geomanist-Book.woff2"    type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/geomanist/hinted-Geomanist-Regular.woff2" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/glyphicons-halflings-regular.woff2"       type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/fontawesome-webfont.woff2?v=4.7.0"        type="font/woff2" crossorigin="anonymous">

  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/font-awesome.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/bootstrap.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/style.css" id="pagestyle">

  <!-- SEO stuff -->
  <meta name="twitter:title" itemprop="title name" content="dockerd"/>
  <meta name="twitter:description" property="og:description" itemprop="description" content="" />
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:domain" content="matsuand.github.io"/>
  <meta name="twitter:site" content="@docker_docs"/>
  <meta name="twitter:url" content="https://twitter.com/docker_docs"/>
  <meta name="twitter:image:src" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:image:alt" content="Docker ドキュメント"/>
  <meta property="og:title" content="dockerd" />
  <meta property="og:description" content="The daemon command description and usage" />
  <meta property="og:type" content="website"/>
  <meta property="og:updated_time" itemprop="dateUpdated" content="2022-04-25T09:39:05+09:00"/>
  <meta property="og:image" itemprop="image primaryImageOfPage" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta property="og:locale" content="ja_JP" />
  <meta property="og:url" content="https://matsuand.github.io/docs.docker.jp.onthefly/engine/reference/commandline/dockerd/" />
  <meta property="og:site_name" content="Docker ドキュメント" />
  <meta property="article:published_time" itemprop="datePublished" content="2022-04-25T09:39:05+09:00"/>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebPage","headline":"dockerd","description":"The daemon command description and usage","url":"https://docs.docker.com/engine/reference/commandline/dockerd/"}</script>
  <!-- END SEO STUFF -->
</head>
<body class="colums">
    <header>
        <nav class="nav-secondary navbar navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="/docs.docker.jp.onthefly/">
                <img class="logo" src="/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs" width="160" height="28" />
            </a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="logo-mobile">
    <a href="/docs.docker.jp.onthefly/">
        <img src="/docs.docker.jp.onthefly/images/docker-icon.svg" alt="Docker Docs" title="Docker Docs" width="30" height="30" />
    </a>
</div>
<div class="search-form" id="search-div">
    <form class="search-form form-inline" id="searchForm" action="/docs.docker.jp.onthefly/search/" method="get">
        <label for="st-search-input" class="sr-only">検索</label>
        <input class="search-field form-control ds-input" id="st-search-input" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteResults"></div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container hidden-sm hidden-xs">
    <div>
        <ul class="nav navbar-nav"><li><a href="/docs.docker.jp.onthefly/" id="home">ホーム</a></li><li><a href="/docs.docker.jp.onthefly/get-started/overview/" id="guides">ガイド</a></li><li><a href="/docs.docker.jp.onthefly/desktop/" id="manuals">マニュアル</a></li><li><a href="/docs.docker.jp.onthefly/reference/" id="reference">リファレンス</a></li><li><a href="/docs.docker.jp.onthefly/samples/" id="samples">サンプル</a></li></ul>
    </div>
    <div class="ctrl-right">
        <a href="javascript:void(0)" id="menu-toggle" aria-label="現在ページのメニュートグル"><i class="fa fa-indent" aria-hidden="true"></i></a>
    </div>
</div>
<div class="row hidden-sm hidden-xs">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li><a href="/docs.docker.jp.onthefly/" title="Docker docs homepage"><i class="fa fa-home"></i></a></li>
            <li><a href="/docs.docker.jp.onthefly/reference/">リファレンス</a></li><li><a>コマンドラインインターフェイス</a></li><li><a href="/docs.docker.jp.onthefly/engine/reference/commandline/dockerd/">Daemon CLI (dockerd)</a></li></ol>
    </nav>
</div></div>
    </div>
</nav>

    </header>
    <div class="wrapper right-open">
        <div class="container-fluid">
            <div class="row">
                <div class="col-body">
                    <main class="col-content content">
                        <section class="section"><h1>dockerd</h1><p><em class="reading-time">読む時間の目安: 28 分</em></p><!-- This file is maintained within the docker/cli GitHub
     repository at https://github.com/docker/cli/. Make all
     pull requests against that repo. If you see this file in
     another repository, consider it read-only there, as it will
     periodically be overwritten by the definitive file. Pull
     requests which include edits to this file in other repositories
     will be rejected.
-->

<h1 id="daemon">デーモン</h1>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#japanese">日本語表記</a></li>
  <li><a data-toggle="tab" href="#origin">英語表記</a></li>
</ul>
<div class="tab-content">
  <div id="japanese" class="tab-pane fade in active">
    <div class="language-markdown highlighter-rouge">
      <div class="highlight">
        <div class="highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>利用方法:	dockerd &lt;コマンド&gt;

コンテナーに対する独立したランタイム。

オプション:
      --add-runtime runtime                   OCI 準拠の追加ランタイムを登録します。（デフォルトは []）
      --allow-nondistributable-artifacts list 配布制限のある成果物を指定レジストリにプッシュします。（デフォルトは []）
      --api-cors-header string                Engine API において CORS ヘッダーを設定します。
      --authorization-plugin list             利用する認証プラグインを指定します。（デフォルトは []）
      --bip string                            ネットワークブリッジ IP を指定します。
  -b, --bridge string                         コンテナーにネットワークブリッジを割り当てます。
      --cgroup-parent string                  全コンテナーに親 cgroup を設定します。
      --cluster-advertise string              通知(advertise)するアドレスまたはインターフェース名。
      --cluster-store string                  分散ストレージバックエンドの URL。
      --cluster-store-opt map                 クラスターストアオプションを設定します。（デフォルトは map[]）
      --config-file string                    デーモン設定ファイル。（デフォルトは "/etc/docker/daemon.json"）
      --containerd string                     containerd ソケットへのパス。
      --cpu-rt-period int                     マイクロ秒で指定される CPU のリアルタイム時間（real-time period）を制限します。
      --cpu-rt-runtime int                    マイクロ秒で指定される CPU のリアルタイムランタイム（real-time runtime）を制限します。
      --data-root string                      永続的な Docker 状態ファイルのルートディレクトリ。（デフォルトは "/var/lib/docker"）
  -D, --debug                                 デバッグモードを有効にします。
      --default-gateway ip                    コンテナーデフォルトゲートウェイの IPv4 アドレス。
      --default-gateway-v6 ip                 コンテナーデフォルトゲートウェイの IPv6 アドレス。
      --default-address-pool                  ローカルのノードネットワークに対してデフォルトのアドレスプールを設定します。
      --default-runtime string                コンテナーに対するデフォルトの OCI ランタイム。（デフォルトは "runc"）
      --default-ulimit ulimit                 コンテナーにデフォルト ulimit を設定します。（デフォルトは []）
      --dns list                              利用する DNS サーバー。（デフォルトは []）
      --dns-opt list                          利用する DNS オプション。（デフォルトは []）
      --dns-search list                       利用する DNS 検索ドメイン。（デフォルトは []）
      --exec-opt list                         ランタイム実行オプション。（デフォルトは []）
      --exec-root string                      実行状態ファイルのルートディレクトリ。（デフォルトは "/var/run/docker）)
      --experimental                          試験的機能（experimental features）を有効にします。
      --fixed-cidr string                     固定 IP に対する IPv4 サブネット。
      --fixed-cidr-v6 string                  固定 IP に対する IPv6 サブネット。
  -G, --group string                          unix ソケットのグループ。（デフォルトは"docker"）
      --help                                  利用方法を表示します。
  -H, --host list                             接続するデーモンソケット。（デフォルトは []）
      --icc                                   コンテナー間の通信を有効にします。（デフォルトは true）
      --init                                  コンテナー内に init を実行し、シグナル転送とプロセス回収（reap）を行います。
      --init-path string                      docker-init バイナリへのパス。
      --insecure-registry list                セキュアでないレジストリとのやりとりを有効にします。（デフォルトは []）
      --ip ip                                 コンテナーポートをバインドする際のデフォルト IP。（デフォルトは 0.0.0.0）
      --ip-forward                            net.ipv4.ip_forward を有効にします。（デフォルトは true）
      --ip-masq                               IP マスカレードを有効にします。（デフォルトは true）
      --iptables                              iptables ルールの追加を許可します。（デフォルトは true）
      --ipv6                                  IPv6 ネットワークを有効にします。
      --label list                            デーモンに対してキーバリューラベルを設定します。（デフォルトは []）
      --live-restore                          コンテナー実行中でのライブリストアを有効にします。
      --log-driver string                     コンテナーログに対するデフォルトドライバー。（デフォルトは "json-file"）
  -l, --log-level string                      ログ出力レベルを設定します。（"debug", "info", "warn", "error", "fatal"）（デフォルトは "info"）
      --log-opt map                           コンテナーに対するデフォルトのログドライバーオプション。（デフォルトは map[]）
      --max-concurrent-downloads int          プルごとの最大同時ダウンロード数を設定します。（デフォルト 3）
      --max-concurrent-uploads int            プッシュごとの最大同時ダウンロード数を設定します。（デフォルト 5）
      --metrics-addr string                   メトリックス API を提供するデフォルトのアドレスとポートを指定します。
      --mtu int                               コンテナーネットワークに MTU を設定します。
      --node-generic-resources list           ユーザー定義のリソースを通知します。
      --no-new-privileges                     新たなコンテナーに対してデフォルトで no-new-privileges を設定します。
      --oom-score-adjust int                  デーモンに対して oom_score_adj を設定します。（デフォルトは -500）
  -p, --pidfile string                        デーモン PID ファイルへのパス。（デフォルトは "/var/run/docker.pid"）
      --raw-logs                              ANSI カラーなしのフルタイムスタンプ。
      --registry-mirror list                  指定したい Docker レジストリミラー。（デフォルトは []）
      --seccomp-profile string                seccomp プロファイルへのパス。
      --selinux-enabled                       selinux サポートを有効にします。
      --shutdown-timeout int                  デフォルトのシャットダウンタイムアウトを設定します。（デフォルトは 15）
  -s, --storage-driver string                 利用するストレージドライバー。
      --storage-opt list                      ストレージドライバーのオプション。（デフォルトは []）
      --swarm-default-advertise-addr string   Swarm の通知アドレスに対してデフォルトのアドレスまたはインターフェースを設定します。
      --tls                                   TLS の利用。暗に --tlsverify を含みます。
      --tlscacert string                      この CA によってのみ署名された信頼できる証明局。（デフォルトは "~/.docker/ca.pem"）
      --tlscert string                        TLS 証明書ファイルへのパス。（デフォルトは "~/.docker/cert.pem"）
      --tlskey string                         TLS 鍵ファイルへのパス。（デフォルトは "~/.docker/key.pem"）
      --tlsverify                             TLS を利用しリモートを確認します。
      --userland-proxy                        ループバックトラフィックに対してユーザーランドプロキシーを利用します。（デフォルトは true）
      --userland-proxy-path string            ユーザーランドプロキシーのバイナリへのパス。
      --userns-remap string                   ユーザー名前空間に対するユーザー/グループの設定。
  -v, --version                               バージョン情報を表示して終了します。
</code></pre></div>        </div>
      </div>
    </div>
  </div>
  <div id="origin" class="tab-pane fade">

    <div class="language-markdown highlighter-rouge">
      <div class="highlight">
        <div class="highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Usage:	dockerd COMMAND

A self-sufficient runtime for containers.

Options:
      --add-runtime runtime                   Register an additional OCI compatible runtime (default [])
      --allow-nondistributable-artifacts list Push nondistributable artifacts to specified registries (default [])
      --api-cors-header string                Set CORS headers in the Engine API
      --authorization-plugin list             Authorization plugins to load (default [])
      --bip string                            Specify network bridge IP
  -b, --bridge string                         Attach containers to a network bridge
      --cgroup-parent string                  Set parent cgroup for all containers
      --cluster-advertise string              Address or interface name to advertise
      --cluster-store string                  URL of the distributed storage backend
      --cluster-store-opt map                 Set cluster store options (default map[])
      --config-file string                    Daemon configuration file (default "/etc/docker/daemon.json")
      --containerd string                     Path to containerd socket
      --cpu-rt-period int                     Limit the CPU real-time period in microseconds
      --cpu-rt-runtime int                    Limit the CPU real-time runtime in microseconds
      --data-root string                      Root directory of persistent Docker state (default "/var/lib/docker")
  -D, --debug                                 Enable debug mode
      --default-gateway ip                    Container default gateway IPv4 address
      --default-gateway-v6 ip                 Container default gateway IPv6 address
      --default-address-pool                  Set the default address pool for local node networks
      --default-runtime string                Default OCI runtime for containers (default "runc")
      --default-ulimit ulimit                 Default ulimits for containers (default [])
      --dns list                              DNS server to use (default [])
      --dns-opt list                          DNS options to use (default [])
      --dns-search list                       DNS search domains to use (default [])
      --exec-opt list                         Runtime execution options (default [])
      --exec-root string                      Root directory for execution state files (default "/var/run/docker")
      --experimental                          Enable experimental features
      --fixed-cidr string                     IPv4 subnet for fixed IPs
      --fixed-cidr-v6 string                  IPv6 subnet for fixed IPs
  -G, --group string                          Group for the unix socket (default "docker")
      --help                                  Print usage
  -H, --host list                             Daemon socket(s) to connect to (default [])
      --icc                                   Enable inter-container communication (default true)
      --init                                  Run an init in the container to forward signals and reap processes
      --init-path string                      Path to the docker-init binary
      --insecure-registry list                Enable insecure registry communication (default [])
      --ip ip                                 Default IP when binding container ports (default 0.0.0.0)
      --ip-forward                            Enable net.ipv4.ip_forward (default true)
      --ip-masq                               Enable IP masquerading (default true)
      --iptables                              Enable addition of iptables rules (default true)
      --ipv6                                  Enable IPv6 networking
      --label list                            Set key=value labels to the daemon (default [])
      --live-restore                          Enable live restore of docker when containers are still running
      --log-driver string                     Default driver for container logs (default "json-file")
  -l, --log-level string                      Set the logging level ("debug", "info", "warn", "error", "fatal") (default "info")
      --log-opt map                           Default log driver options for containers (default map[])
      --max-concurrent-downloads int          Set the max concurrent downloads for each pull (default 3)
      --max-concurrent-uploads int            Set the max concurrent uploads for each push (default 5)
      --metrics-addr string                   Set default address and port to serve the metrics api on
      --mtu int                               Set the containers network MTU
      --node-generic-resources list           Advertise user-defined resource
      --no-new-privileges                     Set no-new-privileges by default for new containers
      --oom-score-adjust int                  Set the oom_score_adj for the daemon (default -500)
  -p, --pidfile string                        Path to use for daemon PID file (default "/var/run/docker.pid")
      --raw-logs                              Full timestamps without ANSI coloring
      --registry-mirror list                  Preferred Docker registry mirror (default [])
      --seccomp-profile string                Path to seccomp profile
      --selinux-enabled                       Enable selinux support
      --shutdown-timeout int                  Set the default shutdown timeout (default 15)
  -s, --storage-driver string                 Storage driver to use
      --storage-opt list                      Storage driver options (default [])
      --swarm-default-advertise-addr string   Set default address or interface for swarm advertised address
      --tls                                   Use TLS; implied by --tlsverify
      --tlscacert string                      Trust certs signed only by this CA (default "~/.docker/ca.pem")
      --tlscert string                        Path to TLS certificate file (default "~/.docker/cert.pem")
      --tlskey string                         Path to TLS key file (default ~/.docker/key.pem")
      --tlsverify                             Use TLS and verify the remote
      --userland-proxy                        Use userland proxy for loopback traffic (default true)
      --userland-proxy-path string            Path to the userland proxy binary
      --userns-remap string                   User/Group setting for user namespaces
  -v, --version                               Print version information and quit
</code></pre></div>        </div>
      </div>
    </div>

  </div>
</div>

<p>オプションにおいて [] が書かれているものは、複数個の指定が可能です。</p>

<h2 id="description">内容説明</h2>

<p><code class="highlighter-rouge">dockerd</code>はコンテナー管理を行う常駐プロセスです。
Docker ではデーモンとクライアントのそれぞれに対して異なる実行バイナリを利用します。
デーモンを実行するには<code class="highlighter-rouge">dockerd</code>を入力します。</p>

<p>デーモン実行においてデバッグ出力を行うには、<code class="highlighter-rouge">dockerd -D</code>を実行します。
あるいは<code class="highlighter-rouge">daemon.json</code>ファイルに<code class="highlighter-rouge">"debug": true</code>を追加します。</p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>Docker 1.13 およびそれ以降において試験的機能（experimental features）を有効にするには、<code class="highlighter-rouge">dockerd</code>に<code class="highlighter-rouge">--experimental</code>フラグをつけて実行するか、<code class="highlighter-rouge">daemon.json</code>ファイルに<code class="highlighter-rouge">"experimental": true</code>を追加します。
それ以前の Docker バージョンにおいて試験的機能を有効にするには、特別にビルドされたものを利用することが必要でした。</p>
</blockquote>

<h2 id="examples">利用例</h2>

<h3 id="daemon-socket-option">デーモンソケットオプション</h3>

<p>Docker デーモンは <a href="/docs.docker.jp.onthefly/engine/api/">Docker Engine API</a> リクエストを待ち受けます。
その際には 3 種類のタイプのソケット、つまり<code class="highlighter-rouge">unix</code>、<code class="highlighter-rouge">tcp</code>、<code class="highlighter-rouge">fd</code>が利用されます。</p>

<p><code class="highlighter-rouge">unix</code>デーモンソケット（あるいは IPC ソケット）は、デフォルトで<code class="highlighter-rouge">/var/run/docker.sock</code>に生成されます。
実行には<code class="highlighter-rouge">root</code>権限、または<code class="highlighter-rouge">docker</code>グループメンバー権限を必要とします。</p>

<p>Docker デーモンにリモートからアクセスする必要がある場合は<code class="highlighter-rouge">tcp</code>ソケットの有効化が必要です。
デフォルトの設定では暗号化や認証がなく、Docker デーモンに直接アクセスできるようになっているので注意してください。
これは <a href="/docs.docker.jp.onthefly/engine/security/https/">HTTPS 暗号化ソケットを用いた方式</a> を行うか、あるいはセキュアなウェブプロキシーを介するようにして、安全化を図ることが必要です。
すべてのネットワークインターフェースに対しては、ポート<code class="highlighter-rouge">2375</code>から<code class="highlighter-rouge">-H tcp://0.0.0.0:2375</code>のようにアクセスします。
また特定のネットワークインターフェースに対しては、IP アドレスを使って<code class="highlighter-rouge">-H tcp://0.0.0.0:2375</code>のようにします。
慣例として、デーモンとの通信が暗号化されていない場合にはポート<code class="highlighter-rouge">2375</code>、暗号化されている場合はポート<code class="highlighter-rouge">2376</code>を利用します。</p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>HTTPS による暗号化されたソケットを利用する場合、サポートされるのが TLS1.0 またはそれ以降であることに注意してください。
セキュリティに関する理由により、プロトコル SSLv3 またはそれ以下はサポートされません。</p>
</blockquote>

<p>Systemd に基づいたシステムにおいては、デーモンに対しては Systemd の <a href="http://0pointer.de/blog/projects/socket-activation.html">ソケットアクティベーション</a>（socket activation）を通じて<code class="highlighter-rouge">dockerd -H fd://</code>のようにしてやりとりができます。
<code class="highlighter-rouge">fd://</code>と指定すればどのような環境でもほぼ間違いなく動作しますが、<code class="highlighter-rouge">dockerd -H fd://3</code>のようにして個別のソケットを指定することもできます。
指定したソケットアクティベーションのファイルが見つからなかった場合、Docker は終了します。
Docker と Systemd を使ったソケットアクティベーションの利用例については <a href="https://github.com/docker/docker/tree/master/contrib/init/systemd/">Docker source tree</a> において見ることができます。</p>

<p>Docker デーモンに対して複数ソケットを同時に待ち受けるようにするには<code class="highlighter-rouge">-H</code>オプションを複数指定します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># デフォルトのunixソケットを利用、合わせて当ホスト上の指定IPアドレス2つを待ち受ける</span>

<span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">-H</span> unix:///var/run/docker.sock <span class="nt">-H</span> tcp://192.168.59.106 <span class="nt">-H</span> tcp://10.10.10.2
</code></pre></div></div>

<p>Docker クライアントは環境変数<code class="highlighter-rouge">DOCKER_HOST</code>に<code class="highlighter-rouge">-H</code>フラグの設定があれば、これを参照します。
したがって以下のコマンドはいずれか <strong>一方を</strong> 選んでください。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nt">-H</span> tcp://0.0.0.0:2375 ps
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">DOCKER_HOST</span><span class="o">=</span><span class="s2">"tcp://0.0.0.0:2375"</span>

<span class="nv">$ </span>docker ps
</code></pre></div></div>

<p>環境変数<code class="highlighter-rouge">DOCKER_TLS_VERIFY</code>に空文字以外の値を何か設定すれば、<code class="highlighter-rouge">--tlsverify</code>フラグを設定することと同じになります。
つまり以下はいずれも同じです。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nt">--tlsverify</span> ps
<span class="c"># または</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">DOCKER_TLS_VERIFY</span><span class="o">=</span>1
<span class="nv">$ </span>docker ps
</code></pre></div></div>

<p>Docker クライアントは環境変数<code class="highlighter-rouge">HTTP_PROXY</code>、<code class="highlighter-rouge">HTTPS_PROXY</code>、<code class="highlighter-rouge">NO_PROXY</code>（またその英小文字による変数）を参照します。
<code class="highlighter-rouge">HTTPS_PROXY</code>は<code class="highlighter-rouge">HTTP_PROXY</code>よりも優先されます。</p>

<p>Docker 18.09 以降では Docker クライアントが、リモートデーモンに対して SSH を通じた接続をサポートするようになりました。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker -H ssh://me@example.com:22 ps
$ docker -H ssh://me@example.com ps
$ docker -H ssh://example.com ps
</code></pre></div></div>

<p>SSH 接続を利用するためには<code class="highlighter-rouge">ssh</code>の設定が必要です。
これを行うことでリモートホストへの公開鍵認証が可能となります。
なおパスワード認証はサポートされていません。
鍵にパスフレーズをつけて保護した場合は<code class="highlighter-rouge">ssh-agent</code>の設定が必要です。</p>

<p>またこの場合はデーモンホスト上に<code class="highlighter-rouge">docker</code>バイナリ 18.09 またはそれ以降が必要です。</p>

<h4 id="bind-docker-to-another-hostport-or-a-unix-socket">別ホスト/ポートあるいは Unix ソケットへの Docker のバインド</h4>

<blockquote>
  <p><strong>警告</strong></p>

  <p><code class="highlighter-rouge">docker</code>デーモンはデフォルトで、TCP ポートあるいは Unix のユーザーグループ<code class="highlighter-rouge">docker</code>へバインドされていますが、これを変更すると、非 root ユーザーによってホスト上の root 権限が取得されるというセキュリティリスクが発生します。
<code class="highlighter-rouge">docker</code>へのアクセスは適切に制御してください。
1 つの TCP ポートにバインドした場合、そのポートに他者がアクセスすれば Docker のすべてにアクセスできるということです。
したがってオープンなネットワーク上において、これを行うことはお勧めしません。</p>
</blockquote>

<p><code class="highlighter-rouge">-H</code>オプションを使えば Docker デーモンが特定の IP およびポートを待ち受けるように設定できます。
デフォルトは<code class="highlighter-rouge">unix:///var/run/docker.sock</code>であり、<strong>root</strong> ユーザーによるローカル接続のみが可能です。
この設定を<code class="highlighter-rouge">0.0.0.0:2375</code>や特定ホスト IP に設定して、誰もがアクセスできるようにすることはできます。
ただしこうすることは <strong>推奨しません</strong>。
なぜなら、デーモンを起動するホストへの root アクセスが簡単にできるようになってしまうためです。</p>

<p>同じように Docker クライアントからは<code class="highlighter-rouge">-H</code>を使って独自のポートにアクセスすることができます。
Docker クライアントは Linux の場合、デフォルトで<code class="highlighter-rouge">unix:///var/run/docker.sock</code>に接続します。
また Windows では<code class="highlighter-rouge">tcp://127.0.0.1:2376</code>がデフォルトです。</p>

<p><code class="highlighter-rouge">-H</code>によるホストとポートの割り当ては、以下の書式に従います。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tcp://[host]:[port][path] または unix://path
</code></pre></div></div>

<p>たとえば以下のとおりです。</p>

<ul>
  <li><code class="highlighter-rouge">tcp://</code>は<code class="highlighter-rouge">127.0.0.1</code>への TCP 接続であり、TLS 暗号化が有効な場合は<code class="highlighter-rouge">2376</code>ポート、通信が平文による場合は<code class="highlighter-rouge">2375</code>ポートを利用します。</li>
  <li><code class="highlighter-rouge">tcp://host:2375</code>は host:2375 への TCP 接続です。</li>
  <li><code class="highlighter-rouge">tcp://host:2375/path</code>は host:2375 への TCP 接続であり、すべてのリクエストに path を追加します。</li>
  <li><code class="highlighter-rouge">unix://path/to/socket</code>は<code class="highlighter-rouge">path/to/socket</code>にある Unix ソケットです。</li>
</ul>

<p><code class="highlighter-rouge">-H</code>への設定値が空の場合、<code class="highlighter-rouge">-H</code>が渡されなかった場合と同じデフォルトになります。</p>

<p><code class="highlighter-rouge">-H</code>では TCP バインディングに対する短い書式での記述もできます。
<code class="highlighter-rouge">host:</code>、<code class="highlighter-rouge">host:port</code>、<code class="highlighter-rouge">:port</code>などです。</p>

<p>以下は Docker をデーモンモードで実行します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo</span> &lt;path to&gt;/dockerd <span class="nt">-H</span> 0.0.0.0:5555 &amp;
</code></pre></div></div>

<p>以下は<code class="highlighter-rouge">ubuntu</code>イメージをダウンロードします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nt">-H</span> :5555 pull ubuntu
</code></pre></div></div>

<p><code class="highlighter-rouge">-H</code>を複数指定することもできます。
たとえば TCP と Unix ソケットの両方を待ち受けたい場合です。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># デーモンモードにより Docker を起動します。</span>
<span class="nv">$ </span><span class="nb">sudo</span> &lt;path to&gt;/dockerd <span class="nt">-H</span> tcp://127.0.0.1:2375 <span class="nt">-H</span> unix:///var/run/docker.sock &amp;
<span class="c"># ubuntu イメージのダウンロードにあたって、デフォルトの Unix ソケットを利用します。</span>
<span class="nv">$ </span>docker pull ubuntu
<span class="c"># あるいは TCP ポートを利用します。</span>
<span class="nv">$ </span>docker <span class="nt">-H</span> tcp://127.0.0.1:2375 pull ubuntu
</code></pre></div></div>

<h3 id="daemon-storage-driver">デーモンのストレージドライバー</h3>

<p>Linux 上の Docker デーモンは、イメージレイヤーに対するストレージドライバーをいくつかサポートしています。
<code class="highlighter-rouge">aufs</code>、<code class="highlighter-rouge">devicemapper</code>、<code class="highlighter-rouge">btrfs</code>、<code class="highlighter-rouge">zfs</code>、<code class="highlighter-rouge">overlay</code>、<code class="highlighter-rouge">overlay2</code>といったものです。</p>

<p><code class="highlighter-rouge">aufs</code>ドライバーは中でも古いものです。
Linux カーネルのパッチセットの形式になっていますが、Linux のソースにマージされることはまずありません。
なおこのパッチセットは重大なカーネルクラッシュを引き起こす場合があることが知られています。
ただし<code class="highlighter-rouge">aufs</code>を用いると、コンテナーが実行モジュールや共有ライブラリのメモリを共有することができます。
したがって同一プログラムまたは同一ライブラリを利用するコンテナーが何千にも及ぶような状況では、便利なドライバーです。</p>

<p><code class="highlighter-rouge">devicemapper</code>ドライバーはシンプロビジョニング（thin provisioning）とコピーオンライト（Copy on Write; CoW）スナップショットを利用します。
devicemapper のグラフの場所ごと、通常は<code class="highlighter-rouge">/var/lib/docker/devicemapper</code>において、2 つのブロックデバイスに基づいたシンプールが生成されます。
その 2 つとは、1 つがデータ用、もう 1 つがメタデータ用です。
これらのブロックデバイスはデフォルトでは、自動生成されるスパースファイルへのループバックマウントを利用して自動生成されます。
この設定のカスタマイズ方法については、以下に示す <a href="#devicemapper-options">Devicemapper オプション</a> を参照してください。
以下の記事 <a href="http://jpetazzo.github.io/2014/01/29/docker-device-mapper-resize/">~jpetazzo/Resizing Docker containers with the Device Mapper plugin</a> では、オプションを利用せずに既存の設定を変更する方法を説明しています。</p>

<p><code class="highlighter-rouge">btrfs</code>ドライバーは<code class="highlighter-rouge">docker build</code>を高速に処理します。
ただし<code class="highlighter-rouge">devicemapper</code>と同じく、デバイス間で実行モジュールメモリを共有しません。
<code class="highlighter-rouge">dockerd -s btrfs -g /mnt/btrfs_partition</code>として利用します。</p>

<p><code class="highlighter-rouge">zfs</code>ドライバーは、おそらく<code class="highlighter-rouge">btrfs</code>ほど高速ではありません。
ただしこちらの方が安定性に関する実績があります。
<code class="highlighter-rouge">Single Copy ARC</code>という機能があるおかげで、クローン間でのブロック共有が一度だけはキャッシュされます。
<code class="highlighter-rouge">dockerd -s zfs</code>として利用します。
zfs ファイルシステムとして別のものを選ぶ場合は、<a href="#zfs-options">ZFS オプション</a> に説明している<code class="highlighter-rouge">zfs.fsname</code>オプションを利用します。</p>

<p><code class="highlighter-rouge">overlay</code>は非常に高速のユニオンファイルシステムです。
これは Linux カーネルの <a href="https://lkml.org/lkml/2014/10/26/137">3.18.0</a> からマージされるようになりました。
<code class="highlighter-rouge">overlay</code>はページキャッシュ共有もサポートします。
これはつまり、複数のコンテナーが同一ファイルにアクセスした場合でも、単一のページキャッシュエントリーを共有できることになります。
これによって<code class="highlighter-rouge">overlay</code>は<code class="highlighter-rouge">aufs</code>ドライバーと同様に、メモリを効率よく活用します。
利用するには<code class="highlighter-rouge">dockerd -s overlay</code>とします。</p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p><code class="highlighter-rouge">overlay</code>は優れた機能ですが、まだ開発されたばかりなので、本番環境では利用しないでください。
特に<code class="highlighter-rouge">overlay</code>を利用した場合に inode の消費が過剰に発生する場合があります（特にイメージ数が増えるほど）。
また RPM 使用との互換性がありません。</p>
</blockquote>

<p><code class="highlighter-rouge">overlay2</code>は同じく高速のユニオンファイルシステムを用いますが、Linux カーネル 4.0 において加えられた <a href="https://lkml.org/lkml/2015/2/11/106">追加機能</a> を活用します。
利用するには<code class="highlighter-rouge">dockerd -s overlay2</code>とします。</p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p><code class="highlighter-rouge">overlay</code>と<code class="highlighter-rouge">overlay2</code>は、ともに現時点において<code class="highlighter-rouge">btrfs</code>に対して、あるいはコピーオンライト（Copy on Write）ファイルシステムにおいてはサポートされていません。
したがってこれらは<code class="highlighter-rouge">ext4</code>パーティションに対してのみ用いてください。</p>
</blockquote>

<p>Windows において Docker デーモンは、イメージプラットフォームに応じて単一のイメージレイヤー向けストレージドライバーを提供します。
Windows イメージに対しては<code class="highlighter-rouge">windowsfilter</code>、Windows 上の Linux コンテナーに対しては<code class="highlighter-rouge">lcow</code>です。</p>

<h3 id="options-per-storage-driver">各ストレージドライバーのオプション</h3>

<p>特定のストレージドライバーに対するオプションは<code class="highlighter-rouge">--storage-opt</code>フラグを使って設定することができます。
<code class="highlighter-rouge">devicemapper</code>用のオプション名は<code class="highlighter-rouge">dm</code>で始まります。
同様に<code class="highlighter-rouge">zfs</code>用は<code class="highlighter-rouge">zfs</code>、<code class="highlighter-rouge">btrfs</code>用は<code class="highlighter-rouge">btrfs</code>、<code class="highlighter-rouge">lcow</code>用は<code class="highlighter-rouge">lcow</code>でそれぞれ始まります。</p>

<h4 id="devicemapper-options">devicemapper 用オプション</h4>

<p>以下の例は Linux 上における devicemapper 用設定ファイルです。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"storage-driver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"devicemapper"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"storage-opts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"dm.thinpooldev=/dev/mapper/thin-pool"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"dm.use_deferred_deletion=true"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"dm.use_deferred_removal=true"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="dmthinpooldev"><code class="highlighter-rouge">dm.thinpooldev</code>オプション</h5>

<p>シンプール（thin pool）を利用するカスタムブロックストレージデバイスを指定します。</p>

<p>device mapper ストレージに対してブロックデバイスを利用する場合は、シンプールボリュームを生成して管理するために<code class="highlighter-rouge">lvm</code>を利用するのが最適です。
このボリュームはその後に Docker に受け渡されて、イメージやコンテナーに必要となるスナップショットボリュームを生成するために利用されます。</p>

<p>シンプールの管理を Engine 外部で行なえば、豊富な機能を実現することができます。
つまり Docker コンテナーに対するバックストレージとして、デバイスマッパーのシンプロビジョニングが利用できます。
lvm ベースのシンプール管理機能の主な特徴は以下のものです。
自動的および対話的なシンプールのリサイズ機能のサポート、動的なシンプール変更機能、lvm によるシンプールアクティブ時の自動的シンプールメタデータチェック機能、などです。</p>

<p>シンプールが提供されない状態では、これよりも劣るループバックファイルが生成されます。
ループバックは処理が遅いかわりに、前もってストレージ設定を行わずに利用することができます。
このループバックは本番環境において利用することはお勧めできません。
したがって Engine デーモンに、引数<code class="highlighter-rouge">--storage-opt dm.thinpooldev</code>が設定されていることを十分に確認してください。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.thinpooldev<span class="o">=</span>/dev/mapper/thin-pool
</code></pre></div></div>

<h5 id="dmdirectlvm_device"><code class="highlighter-rouge">dm.directlvm_device</code>オプション</h5>

<p>上に示したシンプールを利用するものとは別の方法として、ブロックデバイスを設定することができます。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.directlvm_device<span class="o">=</span>/dev/xvdf
</code></pre></div></div>

<h5 id="dmthinp_percent"><code class="highlighter-rouge">dm.thinp_percent</code>オプション</h5>

<p>ストレージとして利用するためにブロックデバイスの利用率を設定します。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.thinp_percent<span class="o">=</span>95
</code></pre></div></div>

<h5 id="dmthinp_metapercent"><code class="highlighter-rouge">dm.thinp_metapercent</code>オプション</h5>

<p>メタデータストレージとして利用するためにブロックデバイスの利用率を設定します。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.thinp_metapercent<span class="o">=</span>1
</code></pre></div></div>

<h5 id="dmthinp_autoextend_threshold"><code class="highlighter-rouge">dm.thinp_autoextend_threshold</code>オプション</h5>

<p><code class="highlighter-rouge">lvm</code>が、利用容量を自動拡張するにあたっての利用容量率を設定します。
（100 は無効を意味します。）</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.thinp_autoextend_threshold<span class="o">=</span>80
</code></pre></div></div>

<h5 id="dmthinp_autoextend_percent"><code class="highlighter-rouge">dm.thinp_autoextend_percent</code>オプション</h5>

<p><code class="highlighter-rouge">lvm</code>が、利用容量を自動拡張するにあたってのシンプール増量率を設定します。
（100 は無効を意味します。）</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.thinp_autoextend_percent<span class="o">=</span>20
</code></pre></div></div>

<h5 id="dmbasesize"><code class="highlighter-rouge">dm.basesize</code>オプション</h5>

<p>ベースデバイスの生成に用いるサイズを指定します。
これはイメージやコンテナーのサイズを制限するものです。
デフォルト値は 10 G です。
なおシンデバイスは基本的に「スパース」（sparse）であるため、デバイス上の 10 G はほとんどが空となり、プール上において 10 G を占有するものではありません。
ただしデバイスが大きくなればなるほど、ファイルシステムが扱う空データはより多くなります。</p>

<p>ベースデバイスのサイズは、デーモンの再起動によって増えます。
これを行えば、今後生成されるイメージやコンテナー（その新たなイメージに基づくもの）は、新たなベースデバイスサイズに基づいて生成されます。</p>

<h6 id="examples">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.basesize<span class="o">=</span>50G
</code></pre></div></div>

<p>上のコマンドはベースデバイスサイズを 50 G に増やすものです。
ベースデバイスサイズが元から 50 G よりも大きかった場合には、Docker デーモンはエラーを出力します。
このオプションによってベースデバイスサイズを拡張することができますが、逆に縮小はできません。</p>

<p>この設定はシステム全体にわたって、「ベース」となっている空のファイルシステムに影響を与えます。
そこにはすでに初期化を済ませたものもあり、プルイメージから継承されたものも含みます。
通常この値を変更する場合には、以下のような手順を経て変更を適用します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>service docker stop

<span class="nv">$ </span><span class="nb">sudo </span>rm <span class="nt">-rf</span> /var/lib/docker

<span class="nv">$ </span><span class="nb">sudo </span>service docker start
</code></pre></div></div>

<h5 id="dmloopdatasize"><code class="highlighter-rouge">dm.loopdatasize</code>オプション</h5>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>本オプションは devicemapper のループバックを設定するものです。
これを本番環境では利用しないでください。</p>
</blockquote>

<p>ループバックファイルを「データ」デバイスとして生成する際に用いられるサイズを指定します。
「データ」デバイスはシンプールのために利用されます。
デフォルトサイズは 100G です。
ファイルはスパースであるため、それだけの容量を初めから占有するわけではありません。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.loopdatasize<span class="o">=</span>200G
</code></pre></div></div>

<h5 id="dmloopmetadatasize"><code class="highlighter-rouge">dm.loopmetadatasize</code>オプション</h5>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>本オプションは devicemapper のループバックを設定するものです。
これを本番環境では利用しないでください。</p>
</blockquote>

<p>シンプール用に用いられる「メタデータ」デバイスに対して、ループバックファイルが生成される際の利用サイズを指定します。
デフォルトサイズは 2G です。
ファイルはスパースであるため、それだけの容量を初めから占有するわけではありません。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.loopmetadatasize<span class="o">=</span>4G
</code></pre></div></div>

<h5 id="dmfs"><code class="highlighter-rouge">dm.fs</code>オプション</h5>

<p>ベースデバイスに対して利用するファイルシステムタイプを指定します。
サポートされるオプションは「ext4」と「xfs」です。
デフォルトは「xfs」です。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.fs<span class="o">=</span>ext4
</code></pre></div></div>

<h5 id="dmmkfsarg"><code class="highlighter-rouge">dm.mkfsarg</code>オプション</h5>

<p>ベースデバイス生成時に用いられる追加の mkfs 引数を指定します。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> <span class="s2">"dm.mkfsarg=-O ^has_journal"</span>
</code></pre></div></div>

<h5 id="dmmountopt"><code class="highlighter-rouge">dm.mountopt</code></h5>

<p>シンデバイスマウント時に用いられる追加のマウントオプションを指定します。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.mountopt<span class="o">=</span>nodiscard
</code></pre></div></div>

<h5 id="dmdatadev"><code class="highlighter-rouge">dm.datadev</code></h5>

<p>（廃止予定であるため、<code class="highlighter-rouge">dm.thinpooldev</code>を利用してください。）</p>

<p>シンプール用のデータとして利用するカスタムブロックデバイスを指定します。</p>

<p>device mapper ストレージにブロックデバイスを利用する場合は、原則として<code class="highlighter-rouge">datadev</code>と<code class="highlighter-rouge">metadatadev</code>を指定することによって、完全にループバックデバイスが利用されないようにしてください。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="se">\</span>
      <span class="nt">--storage-opt</span> dm.datadev<span class="o">=</span>/dev/sdb1 <span class="se">\</span>
      <span class="nt">--storage-opt</span> dm.metadatadev<span class="o">=</span>/dev/sdc1
</code></pre></div></div>

<h5 id="dmmetadatadev"><code class="highlighter-rouge">dm.metadatadev</code></h5>

<p>（廃止予定であるため、<code class="highlighter-rouge">dm.thinpooldev</code>を利用してください。）</p>

<p>シンプールとして、メタデータに利用されるカスタムなブロックデバイスを指定します。</p>

<p>性能を最大限確保するために、メタデータを通常データとは異なるディスクに配置してください。
SSD 上に置くのが、より適切です。</p>

<p>新たにメタデータプールを設定する際には、それが適正であることが必要になります。
これは空のメタデータであることを示すために、先頭の 4K をゼロで埋めることで実現できます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="nv">$metadata_dev</span> <span class="nv">bs</span><span class="o">=</span>4096 <span class="nv">count</span><span class="o">=</span>1
</code></pre></div></div>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="se">\</span>
      <span class="nt">--storage-opt</span> dm.datadev<span class="o">=</span>/dev/sdb1 <span class="se">\</span>
      <span class="nt">--storage-opt</span> dm.metadatadev<span class="o">=</span>/dev/sdc1
</code></pre></div></div>

<h5 id="dmblocksize"><code class="highlighter-rouge">dm.blocksize</code>オプション</h5>

<p>シンプールで利用するカスタムブロックサイズを指定します。
デフォルトのブロックサイズは 64K です。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.blocksize<span class="o">=</span>512K
</code></pre></div></div>

<h5 id="dmblkdiscard"><code class="highlighter-rouge">dm.blkdiscard</code>オプション</h5>

<p>devicemapper デバイスの削除時に、<code class="highlighter-rouge">blkdiscard</code>の利用を許可するかしないかを指定します。
これはループバックデバイス利用時（のみ）、デフォルトは有効です。
ループバックファイルの場合は、イメージやコンテナーの削除時に再度スパースとする必要があるからです。</p>

<p>ループバックに対してこれを無効にした場合は、コンテナーの削除時間が <strong>大きく</strong> 削減できます。
ただしコンテナーが削除されても、<code class="highlighter-rouge">/var/lib/docker</code>ディレクトリに割り当てられていた領域は、他プロセスが利用できる状態に戻されることはありません。</p>

<h6 id="examples">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.blkdiscard<span class="o">=</span><span class="nb">false</span>
</code></pre></div></div>

<h5 id="dmoverride_udev_sync_check"><code class="highlighter-rouge">dm.override_udev_sync_check</code>オプション</h5>

<p><code class="highlighter-rouge">devicemapper</code>と<code class="highlighter-rouge">udev</code>の間における<code class="highlighter-rouge">udev</code>同期確認（synchronization checks）をオーバーライドします。
<code class="highlighter-rouge">udev</code>は Linux カーネルにおける device manager です。</p>

<p><code class="highlighter-rouge">devicemapper</code>ドライバーを利用する Docker デーモンが<code class="highlighter-rouge">udev</code>同期機能をサポートしているかどうかは、以下を実行して確認できます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker info
<span class="o">[</span>...]
Udev Sync Supported: <span class="nb">true</span>
<span class="o">[</span>...]
</code></pre></div></div>

<p><code class="highlighter-rouge">udev</code>同期サポートが<code class="highlighter-rouge">true</code>である場合、<code class="highlighter-rouge">devicemapper</code>と udev は連携してコンテナーデバイスの有効化、無効化を行います。</p>

<p><code class="highlighter-rouge">udev</code>同期サポートが<code class="highlighter-rouge">false</code>である場合、コンテナーの生成や削除の際に<code class="highlighter-rouge">devicemapper</code>と<code class="highlighter-rouge">udev</code>との間で競合が発生します。
この競合状態は結果的にエラーとなって処理が失敗します。
（この処理失敗に関しては <a href="https://github.com/docker/docker/issues/4036">docker#4036</a> を参照してください。）</p>

<p><code class="highlighter-rouge">udev</code>同期がサポートされているかどうかに関係なく<code class="highlighter-rouge">docker</code>デーモンを起動するならば、<code class="highlighter-rouge">dm.override_udev_sync_check</code>を true に設定してください。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.override_udev_sync_check<span class="o">=</span><span class="nb">true</span>
</code></pre></div></div>

<p>この設定値が<code class="highlighter-rouge">true</code>である場合、<code class="highlighter-rouge">devicemapper</code>はエラーが発生したことを単に警告するだけで処理を継続します。</p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>理想的には、<code class="highlighter-rouge">udev</code>との同期をサポートする<code class="highlighter-rouge">docker</code>デーモンおよび環境を目指すべきところです。
これに関してのさらなるトピックが <a href="https://github.com/docker/docker/issues/4036">docker#4036</a> に示されています。
これができない限りは、既存の Docker デーモンが動作する環境上において、正常動作するように本フラグを設定してください。</p>
</blockquote>

<h5 id="dmuse_deferred_removal"><code class="highlighter-rouge">dm.use_deferred_removal</code>オプション</h5>

<p><code class="highlighter-rouge">libdm</code>とカーネルドライバーが遅延デバイス無効化（deferred device removal）の機能をサポートしていれば、その機能を有効にします。</p>

<p>遅延デバイス無効化とは、デバイスの無効化による削除が行われる際にそのデバイスがビジーであると、そのデバイスに対して遅延無効化がスケジュールされるものです。
その後にデバイスの最終ユーザーの利用が終了すると、自動的にデバイスが無効化されます。</p>

<p>たとえばコンテナーが処理終了すると、関連するシンデバイスは無効化されます。
このデバイスが別のマウント名前空間に割り振られていると、無効化することができません。
それでもコンテナーは正常終了します。
そして本オプションによって、システムがこのデバイスを遅延無効化の対象としてスケジュールします。
デバイスがビジーであるからといって、処理ループに入って無効化完了を待つようなことはありません。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.use_deferred_removal<span class="o">=</span><span class="nb">true</span>
</code></pre></div></div>

<h5 id="dmuse_deferred_deletion"><code class="highlighter-rouge">dm.use_deferred_deletion</code>オプション</h5>

<p>シンプールデバイスに対して、遅延デバイス削除（deferred device deletion）の利用を有効化します。
デフォルトでシンプールデバイスの削除は同期的に行われます。
コンテナーが削除される際には、Docker デーモンがあらゆる関連デバイスを同時に削除します。
ストレージドライバーがデバイスを削除できなかった場合、コンテナー削除は失敗してデーモンは処理を終えます。</p>

<pre><code class="language-none">Error deleting container: Error response from daemon: Cannot destroy container
</code></pre>

<p>この異常終了を避けるには、デーモンに対して遅延デバイス削除（deletion）と遅延デバイス無効化（removal）の両方を有効にします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="se">\</span>
      <span class="nt">--storage-opt</span> dm.use_deferred_deletion<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
      <span class="nt">--storage-opt</span> dm.use_deferred_removal<span class="o">=</span><span class="nb">true</span>
</code></pre></div></div>

<p>この 2 つのオプションが有効になっていると、ドライバーがコンテナー削除を行う際にデバイスがビジーであっても、ドライバーはそのデバイスを削除対象として印をつけておき、後にそのデバイスが使われなくなったら削除します。</p>

<p>一般的にこのオプションは、デフォルトで有効にしておいても安全です。
意図せずにマウントポイントが複数のマウント名前空間にわたって広がってしまうことが避けられます。</p>

<h5 id="dmmin_free_space"><code class="highlighter-rouge">dm.min_free_space</code>オプション</h5>

<p>新たなデバイスを新規に生成するために必要となる、シンプール内の空き領域の最小率を指定します。
これは、データとメタデータの両方の空き領域を確認します。
有効な値は 0% から 99% です。
0% を指定すると、空き領域の確認処理を無効にします。
ユーザーによってこのオプションが指定されなかった場合、Engine はデフォルト値 10% を用います。</p>

<p>新たなシンプールデバイスが生成される際（<code class="highlighter-rouge">docker pull</code>の処理中、あるいはコンテナー生成中）には、必ず Engine が最低どれだけの空き領域が利用可能かを確認します。
十分な空き領域がなかった場合、デバイス生成処理は失敗して、これに関連した<code class="highlighter-rouge">docker</code>処理もすべて失敗します。</p>

<p>上のエラーを解消するためには、シンプール内により多くの空き領域を生成しておくことが必要です。
イメージやコンテナーをいくつかシンプールから削除すれば、空き領域は確保されます。
あるいはシンプールに対して、より多くのストレージを割り当てる方法もあります。</p>

<p>LVM（logical volume management）上のシンプールに容量追加を行うなら、シンプールがあるボリュームグループに対してストレージ追加を行ないます。
そうするだけでエラーは自動解消されます。
ループデバイスを利用するように設定している場合は、いったん Engine デーモンを停止させて、ループファイルのサイズを増やした上でデーモンを再起動すれば、エラーは解消します。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.min_free_space<span class="o">=</span>10%
</code></pre></div></div>

<h5 id="dmxfs_nospace_max_retries"><code class="highlighter-rouge">dm.xfs_nospace_max_retries</code>オプション</h5>

<p>対応しているストレージドライバーから ENOSPC（スペースなし）エラーが返された際に、XFS が I/O 完了を繰り返す最大回数を指定します。</p>

<p>デフォルトで XFS は I/O が完了するまで無限に試行し続けます。
そうなってしまうと kill できないプロセスとなってしまいます。
この動作を変更するには、たとえば xfs_nospace_max_retries に 0 を指定します。
そうすると XFS は ENOSPC を受け取った後は試行を行わず、ファイルシステムをシャットダウンします。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--storage-opt</span> dm.xfs_nospace_max_retries<span class="o">=</span>0
</code></pre></div></div>

<h5 id="dmlibdm_log_level"><code class="highlighter-rouge">dm.libdm_log_level</code>オプション</h5>

<p><code class="highlighter-rouge">libdm</code>の最大ログレベルを指定します。
これは<code class="highlighter-rouge">dockerd</code>ログ（<code class="highlighter-rouge">--log-level</code>で指定される）に受け渡されます。
このオプションが主に用いられるのは、<code class="highlighter-rouge">libdm</code>に関係した問題をデバッグする場合です。
この設定をデフォルト値以外にすると、誤って警告ログが検出される場合があります。</p>

<p>指定する値は<code class="highlighter-rouge">libdm</code>ログレベルの正常値範囲でなければなりません。
現時点においては、<code class="highlighter-rouge">libdm</code>ログレベルと<code class="highlighter-rouge">dockerd</code>により出力される対応ログレベルの一覧は以下のようになります。</p>

<table>
  <thead>
    <tr>
      <th><code class="highlighter-rouge">libdm</code> レベル</th>
      <th style="text-align: right">値</th>
      <th><code class="highlighter-rouge">--log-level</code></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">_LOG_FATAL</code></td>
      <td style="text-align: right">2</td>
      <td>error</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">_LOG_ERR</code></td>
      <td style="text-align: right">3</td>
      <td>error</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">_LOG_WARN</code></td>
      <td style="text-align: right">4</td>
      <td>warn</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">_LOG_NOTICE</code></td>
      <td style="text-align: right">5</td>
      <td>info</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">_LOG_INFO</code></td>
      <td style="text-align: right">6</td>
      <td>info</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">_LOG_DEBUG</code></td>
      <td style="text-align: right">7</td>
      <td>debug</td>
    </tr>
  </tbody>
</table>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="se">\</span>
      <span class="nt">--log-level</span> debug <span class="se">\</span>
      <span class="nt">--storage-opt</span> dm.libdm_log_level<span class="o">=</span>7
</code></pre></div></div>

<h4 id="zfs-options">ZFS 用オプション</h4>

<h5 id="zfs" class="fsname"><code class="highlighter-rouge">zfs.fsname</code>オプション</h5>

<p>Docker が独自のデータセットを生成する場所となる zfs ファイルシステムを指定します。
Docker はデフォルトでは、Docker グラフ（<code class="highlighter-rouge">/var/lib/docker</code>）が置かれている zfs ファイルシステムを利用します。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">-s</span> zfs <span class="nt">--storage-opt</span> zfs.fsname<span class="o">=</span>zroot/docker
</code></pre></div></div>

<h4 id="btrfs-options">Btrfs 用オプション</h4>

<h5 id="btrfsmin_space"><code class="highlighter-rouge">btrfs.min_space</code>オプション</h5>

<p>コンテナーが利用するサブボリュームを生成するにあたっての最小サイズを指定します。
btrfs 上においてユーザーにディスククォータが利用されている場合に、コンテナーの生成および起動に <strong>--storage-opt size</strong> オプションを利用すると、Docker はその <strong>size</strong> が <strong>btrfs.min_space</strong> よりも小さくならないようにします。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">-s</span> btrfs <span class="nt">--storage-opt</span> btrfs.min_space<span class="o">=</span>10G
</code></pre></div></div>

<h4 id="overlay2-options">Overlay2 用オプション</h4>

<h5 id="overlay2override_kernel_check"><code class="highlighter-rouge">overlay2.override_kernel_check</code>オプション</h5>

<p>Linux カーネル版の overlay2 チェック機能をオーバーライドします。
overlay2 では複数の下位ディレクトリを必要としますが、この指定をサポートする機能が Linux カーネル 4.0.0 には加えられています。
ただしカーネルバージョンが古い場合に OverlayFS に対して、複数の下位ディレクトリサポートを追加するためのパッチが適用されている場合があります。
本オプションは、カーネル内にそのサポート機能が存在していることを確認した上でのみ、その機能を利用するようにします。
このサポート機能を持っていないカーネルに対して本オプションを指定すると、マウント処理時にエラーとなります。</p>

<h5 id="overlay2" class="size"><code class="highlighter-rouge">overlay2.size</code>オプション</h5>

<p>コンテナーのデフォルト最大サイズを設定します。
これはファイルシステムが<code class="highlighter-rouge">xfs</code>であって、<code class="highlighter-rouge">pquota</code>マウントオプションを使ってマウントされている場合にのみサポートされます。
この条件下であれば、ファイルシステムサイズの範囲内でどのようなサイズでも指定が可能です。</p>

<h6 id="example">利用例</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">-s</span> overlay2 <span class="nt">--storage-opt</span> overlay2.size<span class="o">=</span>1G
</code></pre></div></div>

<h4 id="windowsfilter-options">Windowsfilter 用オプション</h4>

<h5 id="size"><code class="highlighter-rouge">size</code>オプション</h5>

<p>コンテナーが利用するサンドボックスを生成するために用いるサイズを指定します。
デフォルトは 20G です。</p>

<h6 id="example">利用例</h6>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\&gt; dockerd --storage-opt <span class="nv">size</span><span class="o">=</span>40G
</code></pre></div></div>

<h4 id="lcow-linux-containers-on-windows-options">LCOW（Linux Containers on Windows）用オプション</h4>

<h5 id="lcowglobalmode"><code class="highlighter-rouge">lcow.globalmode</code>オプション</h5>

<p>デーモンが必要に応じてユーティリティー VM インスタンスを初期化するかどうか（これが推奨され、省略時のデフォルトです）、あるいは単一のグローバルユーティリティー VM を利用するか（パフォーマンスは向上しますが、セキュリティに影響があるため、本番環境へのデプロイには推奨されません）、このいずれかを指定します。</p>

<h6 id="example">利用例</h6>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\&gt; dockerd --storage-opt lcow.globalmode<span class="o">=</span><span class="nb">false</span>
</code></pre></div></div>

<h5 id="lcow" class="kirdpath"><code class="highlighter-rouge">lcow.kirdpath</code>オプション</h5>

<p>ユーティリティー VM をブートするために利用される 2 つのファイル、つまりカーネルと initrd ファイルが置かれているフォルダーパスを指定します。
デフォルトは<code class="highlighter-rouge">%ProgramFiles%\Linux Containers</code>です。</p>

<h6 id="example">利用例</h6>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\&gt; dockerd --storage-opt lcow.kirdpath<span class="o">=</span>c:\path\to\files
</code></pre></div></div>

<h5 id="lcow" class="kernel"><code class="highlighter-rouge">lcow.kernel</code>オプション</h5>

<p><code class="highlighter-rouge">lcow.kirdpath</code>で指定したパス内にあるカーネルファイル名を指定します。
デフォルトは<code class="highlighter-rouge">bootx64.efi</code>です。</p>

<h6 id="example">利用例</h6>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\&gt; dockerd --storage-opt lcow.kernel<span class="o">=</span>kernel.efi
</code></pre></div></div>

<h5 id="lcow" class="initrd"><code class="highlighter-rouge">lcow.initrd</code>オプション</h5>

<p><code class="highlighter-rouge">lcow.kirdpath</code>で指定したパス内にある initrd ファイル名を指定します。
デフォルトは<code class="highlighter-rouge">initrd.img</code>です。</p>

<h6 id="example">利用例</h6>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\&gt; dockerd --storage-opt lcow.initrd<span class="o">=</span>myinitrd.img
</code></pre></div></div>

<h5 id="lcowbootparameters"><code class="highlighter-rouge">lcow.bootparameters</code></h5>

<p>カーネル/initrd モードであるときに、ユーティリティー VM をブートするにあたっての追加のブートパラメーターを指定します。
ユーティリティー VM が VHD からブートされる場合には無視されます。
この設定はカーネル固有のものです。</p>

<h6 id="example">利用例</h6>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\&gt; dockerd --storage-opt <span class="s2">"lcow.bootparameters='option=value'"</span>
</code></pre></div></div>

<h5 id="lcowvhdx"><code class="highlighter-rouge">lcow.vhdx</code></h5>

<p>ユーティリティー VM をブートするために カーネルおよび initrd ではなく、カスタム VHDX を指定します。
デフォルトは<code class="highlighter-rouge">lcow.kirdpath</code>配下にある<code class="highlighter-rouge">uvm.vhdx</code>です。</p>

<h6 id="example">利用例</h6>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\&gt; dockerd --storage-opt lcow.vhdx<span class="o">=</span>custom.vhdx
</code></pre></div></div>

<h5 id="lcowtimeout"><code class="highlighter-rouge">lcow.timeout</code></h5>

<p>ユーティリティー VM による処理のタイムアウト時間を秒単位で指定します。
デフォルトは 300 です。</p>

<h6 id="example">利用例</h6>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\&gt; dockerd --storage-opt lcow.timeout<span class="o">=</span>240
</code></pre></div></div>

<h5 id="lcowsandboxsize"><code class="highlighter-rouge">lcow.sandboxsize</code></h5>

<p>コンテナーが利用するサンドボックスを生成するために用いるサイズを GB 単位で指定します。
デフォルトは 20 であり、20 未満を指定することはできません。</p>

<h6 id="example">利用例</h6>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\&gt; dockerd --storage-opt lcow.sandboxsize<span class="o">=</span>40
</code></pre></div></div>

<h3 id="docker-runtime-execution-options">Docker ランタイム実行オプション</h3>

<p>Docker デーモンは <a href="https://github.com/opencontainers/runtime-spec">OCI</a> 標準ランタイム（<code class="highlighter-rouge">containerd</code>デーモンを通じて実行される）に準拠し、Linux カーネルの<code class="highlighter-rouge">namespaces</code>、<code class="highlighter-rouge">cgroups</code>、<code class="highlighter-rouge">SELinux</code>へのインターフェースとして動作します。</p>

<p>デフォルトで Docker デーモンは自動的に<code class="highlighter-rouge">containerd</code>を起動します。
<code class="highlighter-rouge">containerd</code>の起動を制御したい場合は、<code class="highlighter-rouge">containerd</code>を手動で起動するようにし、<code class="highlighter-rouge">--containerd</code>フラグへは<code class="highlighter-rouge">containerd</code>ソケットへのパスを指定します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--containerd</span> /var/run/dev/docker-containerd.sock
</code></pre></div></div>

<p>ランタイムはデーモンに登録することができます。
これは設定ファイルか、あるいはコマンドライン引数<code class="highlighter-rouge">--add-runtime</code>を使って行います。</p>

<p>以下に示すのは、設定ファイルを使って 2 つのランタイムを追加する例です。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="s2">"default-runtime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"runc"</span><span class="p">,</span><span class="w">
	</span><span class="s2">"runtimes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="s2">"runc"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"runc"</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="s2">"custom"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/local/bin/my-runc-replacement"</span><span class="p">,</span><span class="w">
			</span><span class="s2">"runtimeArgs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
				</span><span class="s2">"--debug"</span><span class="w">
			</span><span class="p">]</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>以下は同じことをコマンドラインから行う例です。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--add-runtime</span> <span class="nv">runc</span><span class="o">=</span>runc <span class="nt">--add-runtime</span> <span class="nv">custom</span><span class="o">=</span>/usr/local/bin/my-runc-replacement
</code></pre></div></div>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>コマンドラインからランタイム引数を定義することはサポートされていません。</p>
</blockquote>

<h4 id="options-for-the-runtime">ランタイムに対するオプション</h4>

<p>ランタイムが利用するオプションは<code class="highlighter-rouge">--exec-opt</code>フラグを使って設定することができます。
オプションの先頭には<code class="highlighter-rouge">native</code>がつきます。
利用可能なオプションは、ただ 1 つ<code class="highlighter-rouge">native.cgroupdriver</code>オプションです。</p>

<p><code class="highlighter-rouge">native.cgroupdriver</code>オプションは、コンテナーの cgroup に対する管理方法を指定します。
指定できるのは<code class="highlighter-rouge">cgroupfs</code>または<code class="highlighter-rouge">systemd</code>のいずれかです。
<code class="highlighter-rouge">systemd</code>を指定してもそれが利用できなかった場合は、システムエラーとなります。
<code class="highlighter-rouge">native.cgroupdriver</code>オプションを省略すると<code class="highlighter-rouge">cgroupfs</code>が利用されます。</p>

<p>以下の例は<code class="highlighter-rouge">cgroupdriver</code>に<code class="highlighter-rouge">systemd</code>を設定するものです。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--exec-opt</span> native.cgroupdriver<span class="o">=</span>systemd
</code></pre></div></div>

<p>このオプションを設定すると、デーモンが起動するコンテナーすべてに適用されます。</p>

<p>また Windows コンテナーにおいては、この<code class="highlighter-rouge">--exec-opt</code>を特別な目的で利用します。
Docker ユーザーがこれを使って、デフォルトのコンテナー分離技術（isolation technology）を指定できます。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span> dockerd <span class="nt">--exec-opt</span> <span class="nv">isolation</span><span class="o">=</span>hyperv
</code></pre></div></div>

<p>上のコマンドは、Windows 上においてデフォルトの分離技術を<code class="highlighter-rouge">hyperv</code>とします。
デーモン起動時に分離技術の指定が行われなかった場合、Windows クライアントではデフォルトを<code class="highlighter-rouge">hyperv</code>とします。
また Windows Server ではデフォルトは<code class="highlighter-rouge">process</code>となります。</p>

<h3 id="daemon-dns-options">デーモンの DNS オプション</h3>

<p>Docker コンテナーすべてに対して DNS サーバーを設定するには、以下のようにします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--dns</span> 8.8.8.8
</code></pre></div></div>

<p>Docker コンテナーすべてに対して DNS 検索ドメインを設定するには、以下のようにします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--dns-search</span> example.com
</code></pre></div></div>

<h3 id="allow-push-of-nondistributable-artifacts">配布制限のある成果物のプッシュ</h3>

<p>イメージの中には（たとえば Windows ベースイメージのように）ライセンスによって配布が制限されているものがあります。
そのようなイメージをレジストリにプッシュした場合、制限された製品をレジストリに含めることはできません。</p>

<p>指定するレジストリに対して上記の動作をオーバーライドするには<code class="highlighter-rouge">--allow-nondistributable-artifacts</code>オプションを用います。
その際の書式は以下のいずれかです。</p>

<ul>
  <li><code class="highlighter-rouge">--allow-nondistributable-artifacts myregistry:5000</code>と指定すると、Docker デーモンに対して配布制限のある成果物（nondistributable artifacts）を  myregistry:5000 へプッシュする指示となります。</li>
  <li><code class="highlighter-rouge">--allow-nondistributable-artifacts 10.1.0.0/16</code>と指定すると、Docker デーモンに対して配布制限のある成果物を、IP アドレスが CIDR 記述に表現されたサブネットに含まれるレジストリにプッシュする指示となります。</li>
</ul>

<p>このオプションは複数個指定することができます。</p>

<p>このオプションが活用できるのは、エアギャップなネットワーク上のレジストリに、配布制限された成果物を含むイメージをプッシュするような場合です。
そのネットワーク上のホストからは、別のサーバーに接続することなくイメージをプルすることができます。</p>

<blockquote>
  <p><strong>警告</strong></p>

  <p>配布制限のある成果物は、これを配布し共有する方法や場所に関しての制約があります。
本機能を利用して成果物をプッシュするのはプライベートリポジトリに行うものとしてください。
また配布制限のある成果物の再配布に関しては、必ずその条件に準拠してください。</p>
</blockquote>

<h3 id="insecure-registries">セキュアでないレジストリ</h3>

<p>Docker におけるプライベートリポジトリは、セキュアとセキュアでないもののいずれも扱われます。
この節に示す <strong>レジストリ</strong> とは <strong>プライベートリポジトリ</strong> のことであるとします。
そしてプライベートリポジトリの例として<code class="highlighter-rouge">myregistry:5000</code>を用いることにします。</p>

<p>セキュアなレジストリでは TLS が用いられます。
そして CA 証明書のコピーが Docker ホスト上の<code class="highlighter-rouge">/etc/docker/certs.d/myregistry:5000/ca.crt</code>に置かれます。
一方セキュアでないレジストリとは、TLS を利用していないもの（つまり HTTP を平文でやりとりするもの）か、あるいは TLS を利用してはいるものの、デーモンがその CA 証明書を識別できない状態にあるものを指します。
後者の例は、<code class="highlighter-rouge">/etc/docker/certs.d/myregistry:5000/</code>の配下に証明書が見つからなかった場合や、証明書の照合に失敗した（証明書が誤っているなどの）場合に発生します。</p>

<p>デフォルトで Docker はローカルのレジストリであれば、それはすべてセキュアであるとみなします（ローカルレジストリについては後述を参照してください）。
Docker がセキュアでないレジストリをセキュアであるとみなしてしまうと、そのときにはそのレジストリとの通信が不能となります。
セキュアでないレジストリとの通信を行うためには、Docker デーモンに<code class="highlighter-rouge">--insecure-registry</code>の指定が必要です。
その場合、以下の 2 つの書式のいずれかを用います。</p>

<ul>
  <li><code class="highlighter-rouge">--insecure-registry myregistry:5000</code>と指定すると、Docker デーモンに対して myregistry:5000 がセキュアでないことを指示します。</li>
  <li><code class="highlighter-rouge">--insecure-registry 10.1.0.0/16</code>と指定すると、Docker デーモンに対して、レジストリのドメインの IP アドレスが CIDR 記述に表現されたサブネットに含まれるようなレジストリについて、そのすべてがセキュアでないことを指示します。</li>
</ul>

<p>このフラグは複数個指定することが可能であり、複数のレジストリをセキュアでないものとして指定できます。</p>

<p>セキュアでないレジストリをセキュアでないと指定しておかないと、<code class="highlighter-rouge">docker pull</code>、<code class="highlighter-rouge">docker push</code>、<code class="highlighter-rouge">docker search</code>がエラーになります。
その際にはセキュアなレジストリとするか、あるいは上で示したように Docker デーモンに対して<code class="highlighter-rouge">--insecure-registry</code>フラグを指定するようにします。</p>

<p>Docker 1.3.2 以降において、ローカルレジストリの IP アドレスが 127.0.0.0/8 の範囲にある場合、このレジストリはセキュアではないと扱われます。
ただしこれに期待するのは適切ではありません。
将来的にこの扱いは変更されるかもしれないからです。</p>

<p><code class="highlighter-rouge">--insecure-registry</code>を有効にするということは、つまり暗号化されていない通信、あるいは信頼できない通信を可能にするということです。
これはローカルレジストリを運用している場合には便利です。
ただしこれを利用するとセキュリティぜい弱性を生み出してしまうため、これを有効にするのはテスト目的のみとしてください。
セキュリティを向上させるためには、<code class="highlighter-rouge">--insecure-registry</code>を有効とするのではなく、システムの信頼できる CA リストに CA を加えるようにしてください。</p>

<h4 id="legacy-registries">古いレジストリ</h4>

<p>古い v1 プロトコルのみに対応するレジストリへの操作は、Docker 17.12 からはサポートされません。
特にデーモンは v1 レジストリに対しての<code class="highlighter-rouge">push</code>、<code class="highlighter-rouge">pull</code>、<code class="highlighter-rouge">login</code>を行ないません。
ただし<code class="highlighter-rouge">search</code>だけは例外であり、v1 レジストリに対してもこの操作は利用できます。</p>

<p>設定オプション<code class="highlighter-rouge">disable-legacy-registry</code>は削除されました。
したがってこれを利用した場合、デーモンの起動時にエラーが発生します。</p>

<h3 id="running-a-docker-daemon-behind-an-https_proxy">HTTPS_PROXY のもとでの Docker デーモン実行</h3>

<p><code class="highlighter-rouge">HTTPS</code>プロキシーを用いる LAN 内においてデーモンを起動している場合、Docker Hub の証明書はプロキシーの証明書に置き換えられます。
したがってその証明書を Docker ホストの設定に追加しておくことが必要になります。</p>

<ol>
  <li>利用するディストリビューションの<code class="highlighter-rouge">ca-certificates</code>パッケージをインストールします。</li>
  <li>ネットワーク管理者からプロキシーの CA 証明書の情報を得て、これを<code class="highlighter-rouge">/etc/pki/tls/certs/ca-bundle.crt</code>に追加します。</li>
  <li>そして Docker を<code class="highlighter-rouge">HTTPS_PROXY=http://username:password@proxy:port/ dockerd</code>として実行します。
<code class="highlighter-rouge">username:</code>と<code class="highlighter-rouge">password@</code>は任意です。
これはプロキシー認証を行う設定になっている場合にのみ必要となります。</li>
</ol>

<p>これは Docker デーモンのリクエストに対して、プロキシーと認証の情報を追加するだけです。
一方<code class="highlighter-rouge">docker build</code>コマンドや実行中コンテナーにとっては、プロキシーを利用するための情報がさらに必要となります。</p>

<h3 id="default-ulimit-settings">デフォルトの<code class="highlighter-rouge">ulimit</code>設定</h3>

<p><code class="highlighter-rouge">--default-ulimit</code>は、すべてのコンテナーが利用するデフォルトの<code class="highlighter-rouge">ulimit</code>オプションを指定するものです。
<code class="highlighter-rouge">docker run</code>には同じオプションとして<code class="highlighter-rouge">--ulimit</code>があります。
これらに対してデフォルトが設定されていなかった場合は、<code class="highlighter-rouge">ulimit</code>の設定が受け継がれます。
<code class="highlighter-rouge">docker run</code>において設定されていなければ Docker デーモンから引き継ぎます。
<code class="highlighter-rouge">docker run</code>において指定された<code class="highlighter-rouge">--ulimit</code>オプションは、すべてそのデフォルト値をオーバーライドします。</p>

<p><code class="highlighter-rouge">ulimit</code>フラグを使って<code class="highlighter-rouge">nproc</code>を設定する場合には注意が必要です。
<code class="highlighter-rouge">nproc</code>は利用可能なプロセスの最大数を設定するものとして Linux 上において設計されていますが、利用可能であるのはユーザーであってコンテナーではないからです。
詳しくは <a href="/docs.docker.jp.onthefly/engine/reference/commandline/run/">run</a> リファレンスを参照してください。</p>

<h3 id="node-discovery">ノード検出</h3>

<p><code class="highlighter-rouge">--cluster-advertise</code>オプションは<code class="highlighter-rouge">host:port</code>または<code class="highlighter-rouge">interface:port</code>という組み合わせにより指定されます。
これは特定のデーモンインスタンスが、自分自身をクラスターに通知（advertise）する際に用います。
リモートホストはこの値を通じてデーモンに到達します。
インターフェースを指定する場合は、実際の Docker ホストの IP アドレスを含めてください。
<code class="highlighter-rouge">docker-machine</code>を通じて設定された Engine では、通常このインターフェースは<code class="highlighter-rouge">eth1</code>となります。</p>

<p>デーモンにおいては、クラスター内部のノードを通知するために <a href="https://github.com/docker/libkv/">libkv</a> が用いられています。
キーバリューを保持するバックエンドにおいては、相互 TLS（mutual TLS）をサポートするものがあります。
デーモンにおいて用いられるクライアント側の TLS 設定を変更するには<code class="highlighter-rouge">--cluster-store-opt</code>フラグを用います。
そしてそこでは PEM エンコードファイルへのパスを指定します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="se">\</span>
    <span class="nt">--cluster-advertise</span> 192.168.1.2:2376 <span class="se">\</span>
    <span class="nt">--cluster-store</span> etcd://192.168.1.2:2379 <span class="se">\</span>
    <span class="nt">--cluster-store-opt</span> kv.cacertfile<span class="o">=</span>/path/to/ca.pem <span class="se">\</span>
    <span class="nt">--cluster-store-opt</span> kv.certfile<span class="o">=</span>/path/to/cert.pem <span class="se">\</span>
    <span class="nt">--cluster-store-opt</span> kv.keyfile<span class="o">=</span>/path/to/key.pem
</code></pre></div></div>

<p>現時点においてサポートされているクラスターストアのオプションは以下です。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">オプション</th>
      <th style="text-align: left">内容説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">discovery.heartbeat</code></td>
      <td style="text-align: left">ハートビートタイマーを秒単位で指定します。これはデーモンが<code class="highlighter-rouge">keepalive</code>メカニズムにおいて用いるものであり、ノード検出モジュールによりクラスター内のノードが生きているかどうかの確認に利用されます。設定されていない場合、デフォルト値は 20 秒です。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">discovery.ttl</code></td>
      <td style="text-align: left">TTL（time-to-live）を秒単位で指定します。これはノード検出モジュールが用いるものであり、設定されている ttl 値の範囲内で正常なハートビートが受信できなかった場合、どのノードをタイムアウトします。設定されていない場合、デフォルト値は 60 秒です。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">kv.cacertfile</code></td>
      <td style="text-align: left">PEM エンコードされた CA 証明書を使ったローカルファイルへのパスを指定します。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">kv.certfile</code></td>
      <td style="text-align: left">PEM エンコードされた証明書を使ったローカルファイルへのパスを指定します。この証明書は、クライアント証明書として、キーバリューストアを使った通信に利用されます。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">kv.keyfile</code></td>
      <td style="text-align: left">PEM エンコードされた秘密鍵を使ったローカルファイルへのパスを指定します。この秘密鍵は、クライアント鍵として、キーバリューストアを使った通信に利用されます。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">kv.path</code></td>
      <td style="text-align: left">キーバリューストア内のパスを指定します。設定されていない場合のデフォルト値は’docker/nodes’です。</td>
    </tr>
  </tbody>
</table>

<h3 id="access-authorization">アクセス認証</h3>

<p>Docker のアクセス認証は、認証プラグインによって拡張することができます。
この認証プラグインは、所属組織が購入して利用する場合や独自にビルドする場合があります。
Docker の<code class="highlighter-rouge">daemon</code>起動時には複数の認証プラグインを設定することが可能であり、その際には<code class="highlighter-rouge">--authorization-plugin=PLUGIN_ID</code>オプションを用います。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="nt">--authorization-plugin</span><span class="o">=</span>plugin1 <span class="nt">--authorization-plugin</span><span class="o">=</span>plugin2,...
</code></pre></div></div>

<p><code class="highlighter-rouge">PLUGIN_ID</code>値にはプラグイン名か、あるいはその仕様ファイルへのパスを指定します。
プラグイン名またはパスを指定できるかどうかは、そのプラグインの実装によって定まります。
プラグインが利用可能かどうかの情報は、Docker 管理者に問い合わせてください。</p>

<p>プラグインを設定しておけば、コマンドラインあるいは Docker Engine API からのリクエストによって、そのプラグイン利用を許可するかしないかを指示できます。
複数のプラグインを設定している場合、指定された順で個々のプラグインは、リクエストの完了を許可する必要があります。</p>

<p>認証プラグインの生成方法については、Docker の拡張機能を説明する項の  <a href="/docs.docker.jp.onthefly/engine/extend/plugins_authorization/">認証プラグイン</a> の節を参照してください。</p>

<h3 id="daemon-user-namespace-options">デーモンのユーザー名前空間オプション</h3>

<p>Linux カーネルの <a href="http://man7.org/linux/man-pages/man7/user_namespaces.7.html">ユーザー名前空間サポート</a> は、1 つのプロセスを有効にして追加のセキュリティ機能を提供します。
したがってコンテナーでは独自のユーザーおよびグループの ID 範囲を持つものであり、ホストシステムにおいて利用される従来のユーザーおよびグループとは切り離されます。
最も重要なセキュリティ向上となるのは、デフォルトで<code class="highlighter-rouge">root</code>ユーザーとして実行されるコンテナープロセスが、コンテナー内部において期待どおりに管理権限で動作する（一部に制約もある）という点です。
しかもこれはホストから見れば、実際には非特権ユーザーの<code class="highlighter-rouge">uid</code>にマップされるということです。</p>

<p>この機能の利用方法および制約については <a href="/docs.docker.jp.onthefly/engine/security/userns-remap/">ユーザー名前空間によるコンテナーの分離</a> を参照してください。</p>

<h3 id="miscellaneous-options">その他のオプション</h3>

<p>IP マスカレードを利用するとアドレス変換が可能となり、公開 IP アドレスを持たないコンテナーであっても、インターネット上の別マシンとやりとりができるようになります。
これは一部のネットワークトポロジーと干渉する場合があるため、<code class="highlighter-rouge">--ip-masq=false</code>によって無効化できます。</p>

<p>Docker データディレクトリ（<code class="highlighter-rouge">/var/lib/docker</code>）と一時ディレクトリ<code class="highlighter-rouge">/var/lib/docker/tmp</code>に対して Docker はソフトリンクをサポートしています。
たとえば<code class="highlighter-rouge">DOCKER_TMPDIR</code>とデータディレクトリは、以下のようにして設定することができます。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DOCKER_TMPDIR=/mnt/disk2/tmp /usr/local/bin/dockerd -D -g /var/lib/docker -H unix:// &gt; /var/lib/docker-machine/docker.log 2&gt;&amp;1
# or
export DOCKER_TMPDIR=/mnt/disk2/tmp
/usr/local/bin/dockerd -D -g /var/lib/docker -H unix:// &gt; /var/lib/docker-machine/docker.log 2&gt;&amp;1
</code></pre></div></div>

<h4 id="default-cgroup-parent">デフォルトの親 cgroup</h4>

<p><code class="highlighter-rouge">--cgroup-parent</code>オプションは、コンテナーが利用するデフォルトの親 cgroup を設定します。
このオプションが指定されていない場合、デフォルトは fs cgroup ドライバーに対しては<code class="highlighter-rouge">/docker</code>となり、systemd cgroup ドライバーに対しては<code class="highlighter-rouge">system.slice</code>となります。</p>

<p>cgroup の先頭がスラッシュ（<code class="highlighter-rouge">/</code>）で始まる場合、この cgroup はルート cgroup のもとに生成され、そうでない場合はデーモン cgroup のもとに生成されます。</p>

<p>デーモンが仮に<code class="highlighter-rouge">daemoncgroup</code>という cgroup 内で実行されているとします。
<code class="highlighter-rouge">--cgroup-parent=/foobar</code>という指定を行うと、cgroup は<code class="highlighter-rouge">/sys/fs/cgroup/memory/foobar</code>のもとに生成されます。
一方<code class="highlighter-rouge">--cgroup-parent=foobar</code>と指定すると、cgroup は<code class="highlighter-rouge">/sys/fs/cgroup/memory/daemoncgroup/foobar</code>のもとに生成されます。</p>

<p>systemd cgroup ドライバーには<code class="highlighter-rouge">--cgroup-parent</code>に対して別ルールがあります。
systemd はスライス（slice）による階層構造により表現され、そのスライス名はツリー内の場所をエンコードしています。
したがって systemd cgroups に対する<code class="highlighter-rouge">--cgroup-parent</code>の設定値はスライス名とします。
1 つの名前は、一連の名前をダッシュで区切って構成します。
これが、そのスライスに対するルートスライスからのパスを表します。
たとえば<code class="highlighter-rouge">--cgroup-parent=user-a-b.slice</code>というのは、コンテナーに対するメモリ cgroup であり、<code class="highlighter-rouge">/sys/fs/cgroup/memory/user.slice/user-a.slice/user-a-b.slice/docker-&lt;id&gt;.scope</code> に生成されます。</p>

<p>上の指定はコンテナー単位で行うこともできます。
その場合は<code class="highlighter-rouge">docker create</code>や<code class="highlighter-rouge">docker run</code>の実行時に<code class="highlighter-rouge">--cgroup-parent</code>を指定します。
この指定は、デーモンに対する<code class="highlighter-rouge">--cgroup-parent</code>オプションよりも優先して適用されます。</p>

<h4 id="daemon-metrics">デーモンのメトリックス</h4>

<p><code class="highlighter-rouge">--metrics-addr</code>オプションには tcp アドレスを指定し、これによりメトリックス API を提供します。
この機能は今も試験的なものであり、したがって本機能利用のためにはデーモンを試験的モード（experimental mode）で実行する必要があります。</p>

<p><code class="highlighter-rouge">localhost:9323</code>によってメトリックス API を提供する場合は、<code class="highlighter-rouge">--metrics-addr 127.0.0.1:9323</code>と指定します。
こうしておくことで<code class="highlighter-rouge">127.0.0.1:9323/metrics</code>という API リクエストを行って、<a href="https://prometheus.io/docs/instrumenting/exposition_formats/">prometheus</a> 書式のメトリックスを受信することができます。</p>

<p>ポート<code class="highlighter-rouge">9323</code>は <a href="https://github.com/prometheus/prometheus/wiki/Default-port-allocations">Docker メトリックスに関連づいたデフォルトポート</a> であり、他の prometheus エクスポーターやサービスとの衝突を回避するものです。</p>

<p>prometheus サーバーを実行している場合は、このアドレスを scrape 設定に追加することで、Docker 上において prometheus によるメトリックス収集を行うことができます。
prometheus の詳細は <a href="https://prometheus.io/">こちら</a> のウェブサイトを参照してください。</p>

<pre><code class="language-none">scrape_configs:
  - job_name: 'docker'
    static_configs:
      - targets: ['127.0.0.1:9323']
</code></pre>

<p>この機能はメトリックスと同様に試験的と位置づけられている点に注意してください。
またメトリックス名は、試験的機能の扱いの中で変更されるかもしれません。
API を用いてどのような情報を集めたいか、ぜひフィードバックをお寄せください。</p>

<h4 id="node-generic-resources">ノードジェネリックリソース</h4>

<p><code class="highlighter-rouge">--node-generic-resources</code>オプションはキーバリューペア（<code class="highlighter-rouge">key=value</code>）をとり、Swarm クラスター内にユーザー定義リソースを通知（advertise）します。</p>

<p>現時点において想定される利用例は NVIDIA GPU を通知するものです。
サービスが<code class="highlighter-rouge">NVIDIA-GPU=[0-16]</code>を要求すると、タスク実行に必要となる十分な GPU を持ったノードに割り振られます。</p>

<p>Example of usage:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="s2">"node-generic-resources"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"NVIDIA-GPU=UUID1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NVIDIA-GPU=UUID2"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="daemon-configuration-file">デーモン設定ファイル</h3>

<p><code class="highlighter-rouge">--config-file</code>オプションを使うと、デーモンに対するどの設定オプションでも JSON 形式のファイルから与えられます。
このファイル内では、フラグ名をそのままキーとして指定します。
ただし複数項目の指定が可能なフラグの場合は、フラグ名を複数形とします。
たとえば<code class="highlighter-rouge">label</code>フラグは<code class="highlighter-rouge">labels</code>とします。</p>

<p>設定ファイルから設定するオプションは、フラグを通じて設定するオプションと競合してはなりません。
設定ファイルとフラグとの間で重複するオプションがあった場合には、その設定値には関係なく Docker デーモンは起動に失敗します。
このようにしているのは、設定ファイルによって再設定が行われ、その変更が何も表示されずに無視されるような状況を防ぐためです。
たとえば設定ファイル内にデーモンの labels を設定し、かつ<code class="highlighter-rouge">--label</code>フラグを使ってデーモンラベルを指定した場合には、デーモンは起動に失敗します。
設定ファイル内に指定されなかったオプションは、デーモン起動時に無視されます。</p>

<h5 id="on-linux">Linux の場合</h5>

<p>設定ファイルのデフォルトは Linux の場合<code class="highlighter-rouge">/etc/docker/daemon.json</code>です。
<code class="highlighter-rouge">--config-file</code>フラグを利用すれば、デフォルト以外の場所を指定することができます。</p>

<p>以下は Linux 上での設定ファイルに記述可能なオプションの一覧です。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="s2">"authorization-plugins"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
	</span><span class="s2">"data-root"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"dns"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
	</span><span class="s2">"dns-opts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
	</span><span class="s2">"dns-search"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
	</span><span class="s2">"exec-opts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
	</span><span class="s2">"exec-root"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"experimental"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
	</span><span class="s2">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
	</span><span class="s2">"storage-driver"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"storage-opts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
	</span><span class="s2">"labels"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
	</span><span class="s2">"live-restore"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
	</span><span class="s2">"log-driver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"json-file"</span><span class="p">,</span><span class="w">
	</span><span class="s2">"log-opts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="s2">"max-size"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10m"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"max-file"</span><span class="p">:</span><span class="s2">"5"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"labels"</span><span class="p">:</span><span class="w"> </span><span class="s2">"somelabel"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"env"</span><span class="p">:</span><span class="w"> </span><span class="s2">"os,customer"</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="s2">"mtu"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="s2">"pidfile"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"cluster-store"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"cluster-store-opts"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
	</span><span class="s2">"cluster-advertise"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"max-concurrent-downloads"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
	</span><span class="s2">"max-concurrent-uploads"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
	</span><span class="s2">"default-shm-size"</span><span class="p">:</span><span class="w"> </span><span class="s2">"64M"</span><span class="p">,</span><span class="w">
	</span><span class="s2">"shutdown-timeout"</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w">
	</span><span class="s2">"debug"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
	</span><span class="s2">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
	</span><span class="s2">"log-level"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"tls"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
	</span><span class="s2">"tlsverify"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
	</span><span class="s2">"tlscacert"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"tlscert"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"tlskey"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"swarm-default-advertise-addr"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"api-cors-header"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"selinux-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
	</span><span class="s2">"userns-remap"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"group"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"cgroup-parent"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"default-ulimits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="s2">"nofile"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="s2">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nofile"</span><span class="p">,</span><span class="w">
			</span><span class="s2">"Hard"</span><span class="p">:</span><span class="w"> </span><span class="mi">64000</span><span class="p">,</span><span class="w">
			</span><span class="s2">"Soft"</span><span class="p">:</span><span class="w"> </span><span class="mi">64000</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="s2">"init"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
	</span><span class="s2">"init-path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/libexec/docker-init"</span><span class="p">,</span><span class="w">
	</span><span class="s2">"ipv6"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
	</span><span class="s2">"iptables"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
	</span><span class="s2">"ip-forward"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
	</span><span class="s2">"ip-masq"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
	</span><span class="s2">"userland-proxy"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
	</span><span class="s2">"userland-proxy-path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/libexec/docker-proxy"</span><span class="p">,</span><span class="w">
	</span><span class="s2">"ip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0.0.0"</span><span class="p">,</span><span class="w">
	</span><span class="s2">"bridge"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"bip"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"fixed-cidr"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"fixed-cidr-v6"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"default-gateway"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"default-gateway-v6"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"icc"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
	</span><span class="s2">"raw-logs"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
	</span><span class="s2">"allow-nondistributable-artifacts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
	</span><span class="s2">"registry-mirrors"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
	</span><span class="s2">"seccomp-profile"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
	</span><span class="s2">"insecure-registries"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
	</span><span class="s2">"no-new-privileges"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
	</span><span class="s2">"default-runtime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"runc"</span><span class="p">,</span><span class="w">
	</span><span class="s2">"oom-score-adjust"</span><span class="p">:</span><span class="w"> </span><span class="mi">-500</span><span class="p">,</span><span class="w">
	</span><span class="s2">"node-generic-resources"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"NVIDIA-GPU=UUID1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NVIDIA-GPU=UUID2"</span><span class="p">],</span><span class="w">
	</span><span class="s2">"runtimes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="s2">"cc-runtime"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/bin/cc-runtime"</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="s2">"custom"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/local/bin/my-runc-replacement"</span><span class="p">,</span><span class="w">
			</span><span class="s2">"runtimeArgs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
				</span><span class="s2">"--debug"</span><span class="w">
			</span><span class="p">]</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="s2">"default-address-pools"</span><span class="p">:[</span><span class="w">
		</span><span class="p">{</span><span class="s2">"base"</span><span class="p">:</span><span class="s2">"172.80.0.0/16"</span><span class="p">,</span><span class="s2">"size"</span><span class="p">:</span><span class="mi">24</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="s2">"base"</span><span class="p">:</span><span class="s2">"172.90.0.0/16"</span><span class="p">,</span><span class="s2">"size"</span><span class="p">:</span><span class="mi">24</span><span class="p">}</span><span class="w">
	</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>デーモン起動時のフラグとしてすでに設定しているオプションは、<code class="highlighter-rouge">daemon.json</code>に設定することはできません。
<code class="highlighter-rouge">systemd</code>を利用して Docker デーモンを起動しているシステムの場合<code class="highlighter-rouge">-H</code>が設定されているため、<code class="highlighter-rouge">daemon.json</code>内において、待ち受けるアドレスを追加する<code class="highlighter-rouge">hosts</code>キーを利用することはできません。
systemd のドロップインファイルを使ってこのタスクを実行する方法については <a href="/docs.docker.jp.onthefly/engine/admin/systemd/#custom-docker-daemon-options">Docker デーモンオプションのカスタマイズ</a> を参照してください。</p>
</blockquote>

<h5 id="on-windows">Windows の場合</h5>

<p>設定ファイルのデフォルトは Windows の場合<code class="highlighter-rouge">%programdata%\docker\config\daemon.json</code>です。
<code class="highlighter-rouge">--config-file</code>フラグを利用すれば、デフォルト以外の場所を指定することができます。</p>

<p>以下は Windows 上での設定ファイルに記述可能なオプションの一覧です。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"authorization-plugins"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="s2">"data-root"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="s2">"dns"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="s2">"dns-opts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="s2">"dns-search"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="s2">"exec-opts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="s2">"experimental"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="s2">"features"</span><span class="p">:{},</span><span class="w">
    </span><span class="s2">"storage-driver"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="s2">"storage-opts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="s2">"labels"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="s2">"log-driver"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="s2">"mtu"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="s2">"pidfile"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="s2">"cluster-store"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="s2">"cluster-advertise"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="s2">"max-concurrent-downloads"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="s2">"max-concurrent-uploads"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
    </span><span class="s2">"shutdown-timeout"</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w">
    </span><span class="s2">"debug"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="s2">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="s2">"log-level"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="s2">"tlsverify"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="s2">"tlscacert"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="s2">"tlscert"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="s2">"tlskey"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="s2">"swarm-default-advertise-addr"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="s2">"group"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="s2">"default-ulimits"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="s2">"bridge"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="s2">"fixed-cidr"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="s2">"raw-logs"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="s2">"allow-nondistributable-artifacts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="s2">"registry-mirrors"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="s2">"insecure-registries"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="feature-options">feature オプション</h4>
<p><code class="highlighter-rouge">daemon.json</code>内の任意設定項目である<code class="highlighter-rouge">features</code>は、デーモンの特定機能の有効無効を指定します。
たとえば<code class="highlighter-rouge">{"features":{"buildkit": true}}</code>は、デフォルトの Docker イメージビルダーとして<code class="highlighter-rouge">buildkit</code>を有効にします。</p>

<p>現時点においてサポートされている feature オプションは以下のとおりです。</p>
<ul>
  <li><code class="highlighter-rouge">buildkit</code> ＝ デフォルトのビルダーとして<code class="highlighter-rouge">buildkit</code>を有効にするには<code class="highlighter-rouge">true</code>を設定し、無効にするには<code class="highlighter-rouge">false</code>を設定します。
 なおこのオプションがデーモンの設定ファイルに明示されなかった場合は、クライアント上の CLI からどのビルダーを実行するかによって決定します。</li>
</ul>

<h4 id="configuration-reload-behavior">設定再読み込みに関する動作</h4>

<p>オプションの中には、デーモンが起動中であってもプロセス再起動をすることなく設定変更を行えるものがあります。
設定再読み込みのため、Linux では<code class="highlighter-rouge">SIGHUP</code>シグナル、Windows ではグローバルイベントのキー<code class="highlighter-rouge">Global\docker-daemon-config-$PID</code>を使います。
このオプションは設定ファイルを使って変更することもできます。
その場合はフラグ指定されたものと競合していないかがチェックされます。
競合していた場合、デーモンの再設定そのものは失敗しますが、実行停止することはありません。</p>

<p>再設定が可能なものとして、現時点でサポートされるオプションは以下のとおりです。</p>

<ul>
  <li><code class="highlighter-rouge">debug</code>: true に設定するとデーモンをデバッグモードに変更します。</li>
  <li><code class="highlighter-rouge">cluster-store</code>: 新たなアドレスを利用してディスカバリーストア（discovery store）を再読み込みします。</li>
  <li><code class="highlighter-rouge">cluster-store-opts</code>: ディスカバリーストアの再読み込みに利用する新たなオプションを指定します。</li>
  <li><code class="highlighter-rouge">cluster-advertise</code>: 再読み込み後に通知されるアドレスを変更します。</li>
  <li><code class="highlighter-rouge">labels</code>: デーモンラベルを別の新たなラベルに置き換えます。</li>
  <li><code class="highlighter-rouge">live-restore</code>: <a href="/docs.docker.jp.onthefly/config/containers/live-restore/">デーモン停止時のコンテナー継続起動</a> を有効にします。</li>
  <li><code class="highlighter-rouge">max-concurrent-downloads</code>: プルごとの最大同時ダウンロード数を変更します。</li>
  <li><code class="highlighter-rouge">max-concurrent-uploads</code>: プッシュごとの最大同時ダウンロード数を変更します。</li>
  <li><code class="highlighter-rouge">default-runtime</code>: コンテナー生成時に指定のなかったランタイムを変更します。デフォルトは「default」であり、これは公式の Docker パッケージが提供するランタイムです。</li>
  <li><code class="highlighter-rouge">runtimes</code>: コンテナー実行に用いられる利用可能な OCI ランタイムの一覧を変更します。</li>
  <li><code class="highlighter-rouge">authorization-plugin</code>: 利用する認証プラグインを指定します。</li>
  <li><code class="highlighter-rouge">allow-nondistributable-artifacts</code>: 配布制限のある成果物をデーモンがプッシュするレジストリの一覧を変更します。</li>
  <li><code class="highlighter-rouge">insecure-registries</code>: デーモンのセキュアではいレジストリ一覧を新たなものに変更します。デーモン設定に存在していたセキュアでないレジストリが、新たにロードされたレジストリ内になかった場合、そのレジストリはデーモン設定から削除されます。</li>
  <li><code class="highlighter-rouge">registry-mirrors</code>: デーモンのレジストリミラーを新たなものに変更します。デーモン設定に存在していたレジストリミラーが、新たにロードされたレジストリミラー内になかった場合、そのレジストリミラーはデーモン設定から削除されます。</li>
  <li><code class="highlighter-rouge">shutdown-timeout</code>: コンテナーすべてをシャットダウンする際のタイムアウトに関して、デーモンの設定を変更します。</li>
  <li><code class="highlighter-rouge">features</code>: 特定の機能を明示的に有効または無効にします。</li>
</ul>

<p>クラスター関連の設定、つまり<code class="highlighter-rouge">--cluster-store</code>、<code class="highlighter-rouge">--cluster-advertise</code>、<code class="highlighter-rouge">--cluster-store-opts</code>を変更および再読み込みしても、それが有効になるのは、その設定がそれまで設定されていなかった場合に限ります。
<code class="highlighter-rouge">--cluster-store</code>をフラグとして指定し<code class="highlighter-rouge">cluster-advertise</code>はフラグとして指定しなかった場合、<code class="highlighter-rouge">cluster-advertise</code>の設定は<code class="highlighter-rouge">--cluster-store</code>がなくても設定ファイルに含めることができます。
設定の再読み込みを行った際に、それまでのクラスター設定に変更があった場合には、警告メッセージがログ出力されます。</p>

<h3 id="run-multiple-daemons">複数デーモンの実行</h3>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>単一ホスト上に複数デーモンを実行することは「試験的」機能という扱いです。
ここには未解決の問題がある点に注意してください。
この機能は正しく動作しないことがあります。
これは現在も開発途上のものであり、近いうちに正式提供される予定です。</p>
</blockquote>

<p>この節では、単一ホスト上において複数の Docker デーモンを起動する方法を示します。
複数デーモンの起動にあたっては、同一ホスト上においてデーモン同士が互いに衝突することがないように設定しなければなりません。
オプション設定はフラグとして行う場合と <a href="#daemon-configuration-file">デーモン設定ファイル</a> を用いる場合のいずれでも可能です。</p>

<p>以下に示すオプションは、デーモンごとに設定する必要があります。</p>

<pre><code class="language-none">-b, --bridge=                          コンテナーにネットワークブリッジを割り当てます。
--exec-root=/var/run/docker            Docker の実行ドライバー（execdriver）のルートパス。
--data-root=/var/lib/docker            Docker の永続的データのルートパス。
-p, --pidfile=/var/run/docker.pid      デーモンの PID ファイルを配置するパス。
-H, --host=[]                          接続するデーモンソケット。
--iptables=true                        iptables ルールの追加を許可します。
--config-file=/etc/docker/daemon.json  デーモン設定ファイル。
--tlscacert="~/.docker/ca.pem"         この CA によってのみ署名された信頼できる証明局。
--tlscert="~/.docker/cert.pem"         TLS 証明書ファイルへのパス。
--tlskey="~/.docker/key.pem"           TLS 鍵ファイルへのパス。
--tlskey="~/.docker/key.pem"           TLS 鍵ファイルへのパス。
</code></pre>

<p>複数実行しているデーモンにおいてこういったフラグに別々の値を設定していても、同一ホスト上で複数デーモンは問題なく動作します。
それぞれのオプションの意味を正しく理解して、適切に利用することが重要です。</p>

<ul>
  <li><code class="highlighter-rouge">-b, --bridge=</code>フラグは、デフォルトのブリッジネットワークとして<code class="highlighter-rouge">docker0</code>が設定されています。
これは Docker をインストールしたときに自動的に生成されるものです。
デフォルトを利用しない場合には、ブリッジを生成し設定することが必要です。
あるいは不要であれば<code class="highlighter-rouge">none</code>とする、つまり<code class="highlighter-rouge">--bridge=none</code>と設定します。</li>
  <li><code class="highlighter-rouge">--exec-root</code>はコンテナー状態の保存場所を示すパスです。
デフォルトは<code class="highlighter-rouge">/var/run/docker</code>です。
起動するデーモンに合わせてパスを指定します。</li>
  <li><code class="highlighter-rouge">--data-root</code>はイメージ、ボリューム、クラスター状態といった永続的なデータを保存する場所へのパスです。
デフォルト値は<code class="highlighter-rouge">/var/lib/docker</code>です。
各デーモンでの重複を避けるため、各デーモンごとに個別に本パラメーターを設定してください。</li>
  <li><code class="highlighter-rouge">-p, --pidfile=/var/run/docker.pid</code>はデーモンのプロセス ID を保存する場所へのパスです。
pid ファイルへのパスをここに指定してください。</li>
  <li><code class="highlighter-rouge">--host=[]</code>はクライアントからの接続に対して、Docker デーモンが待ち受ける場所を指定します。
設定がない場合、そのデフォルトは<code class="highlighter-rouge">/var/run/docker.sock</code>です。</li>
  <li><code class="highlighter-rouge">--iptables=false</code>を指定すると、Docker デーモンが iptables ルールを追加しないようにします。
複数のデーモンが iptables ルールを制御すると、別のデーモンの設定によってルールがオーバーライドされることがあります。
このオプションを無効にするということは、iptables ルールを手動で追加してコンテナーポートを公開しなければならないことに注意してください。
Docker が iptables ルールを追加しないようにした場合、たとえ<code class="highlighter-rouge">--ip-masq</code>を<code class="highlighter-rouge">true</code>に設定していても Docker は IP マスカレードルールも追加しません。
IP マスカレードルールがないとしたら、デフォルトのブリッジネットワーク以外を利用している場合には、Docker コンテナーは外部ホストやインターネットには接続できません。</li>
  <li><code class="highlighter-rouge">--config-file=/etc/docker/daemon.json</code>は、設定ファイルを保存するパスです。
デーモンフラグの代わりにこれを利用することができます。
このパスはデーモンごとに設定してください。</li>
  <li><code class="highlighter-rouge">--tls*</code>は Docker デーモンが<code class="highlighter-rouge">--tlsverify</code>モードをサポートするようにします。
このモードではリモートに対して暗号化および認証された接続が求められます。
<code class="highlighter-rouge">--tls*</code>オプションはデーモンごとに、特定証明書の利用を可能にします。</li>
</ul>

<p>以下に示すのは、ネットワークを利用しない Docker デーモンの個別「ブートストラップ」インスタンスを実行するスクリプト例です。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dockerd <span class="se">\</span>
        <span class="nt">-H</span> unix:///var/run/docker-bootstrap.sock <span class="se">\</span>
        <span class="nt">-p</span> /var/run/docker-bootstrap.pid <span class="se">\</span>
        <span class="nt">--iptables</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
        <span class="nt">--ip-masq</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
        <span class="nt">--bridge</span><span class="o">=</span>none <span class="se">\</span>
        <span class="nt">--data-root</span><span class="o">=</span>/var/lib/docker-bootstrap <span class="se">\</span>
        <span class="nt">--exec-root</span><span class="o">=</span>/var/run/docker-bootstrap
</code></pre></div></div>
<span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span style="vertical-align: 2px"><a href="/docs.docker.jp.onthefly/search/?q=container">container</a>, <a href="/docs.docker.jp.onthefly/search/?q=daemon">daemon</a>, <a href="/docs.docker.jp.onthefly/search/?q=runtime">runtime</a></span><div class="ratings-div"><div id="pd_rating_holder_8453675"></div></div></section>
                    </main>
                    <nav class="col-nav">
                        <div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
                            <div id="navbar" class="nav-sidebar">
                                <ul class="nav hidden-md hidden-lg"></ul>
                                <ul class="nav" id="jsTOCLeftNav"></ul>
                            </div>
                        </div>
                    </nav>
                    <div class="col-toc">
                        <div class="sidebar hidden-xs hidden-sm">
                            <div class="toc-nav">
                                <div class="feedback-links">
                                    <ul><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/edit/master/src/engine/reference/commandline/dockerd.ch"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 本ページの編集</a></li><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/issues/new?body=File: [engine/reference/commandline/dockerd.ch](https://matsuand.github.io/docs.docker.jp.onthefly/engine/reference/commandline/dockerd/)" class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 変更リクエスト</a></li>
                                        <li><div class="toggle-mode">
  <div class="icon">
      <i class="fa fa-sun-o" aria-hidden="true"></i>
  </div>
  <div class="toggle-switch">
      <label class="switch">
          <input type="checkbox" id="switch-style">
          <span class="slider round"></span>
      </label>
  </div>
  <div class="icon">
      <i class="fa fa-moon-o" aria-hidden="true"></i>
  </div>
</div>
</li>
                                    </ul>
                                </div><div id="side-toc-title">本ページ内:</div>
<ul id="my_toc" class="inline_toc">
  <li><a href="#description" class="nomunge">内容説明</a></li>
  <li><a href="#examples" class="nomunge">利用例</a>
    <ul>
      <li><a href="#daemon-socket-option" class="nomunge">デーモンソケットオプション</a></li>
      <li><a href="#daemon-storage-driver" class="nomunge">デーモンのストレージドライバー</a></li>
      <li><a href="#options-per-storage-driver" class="nomunge">各ストレージドライバーのオプション</a></li>
      <li><a href="#docker-runtime-execution-options" class="nomunge">Docker ランタイム実行オプション</a></li>
      <li><a href="#daemon-dns-options" class="nomunge">デーモンの DNS オプション</a></li>
      <li><a href="#allow-push-of-nondistributable-artifacts" class="nomunge">配布制限のある成果物のプッシュ</a></li>
      <li><a href="#insecure-registries" class="nomunge">セキュアでないレジストリ</a></li>
      <li><a href="#running-a-docker-daemon-behind-an-https_proxy" class="nomunge">HTTPS_PROXY のもとでの Docker デーモン実行</a></li>
      <li><a href="#default-ulimit-settings" class="nomunge">デフォルトのulimit設定</a></li>
      <li><a href="#node-discovery" class="nomunge">ノード検出</a></li>
      <li><a href="#access-authorization" class="nomunge">アクセス認証</a></li>
      <li><a href="#daemon-user-namespace-options" class="nomunge">デーモンのユーザー名前空間オプション</a></li>
      <li><a href="#miscellaneous-options" class="nomunge">その他のオプション</a></li>
      <li><a href="#daemon-configuration-file" class="nomunge">デーモン設定ファイル</a></li>
      <li><a href="#run-multiple-daemons" class="nomunge">複数デーモンの実行</a></li>
    </ul>
  </li>
</ul>

</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">
          
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products" target="_blank" rel="noopener">製品ラインアップ</a></b></li>
                        <li><a href="https://www.docker.com/products/personal" target="_blank" rel="noopener">Docker Personal</a></li>
                        <li><a href="https://www.docker.com/products/pro" target="_blank" rel="noopener">Docker Pro</a></li>
                        <li><a href="https://www.docker.com/products/team" target="_blank" rel="noopener">Docker Team</a></li>
                        <li><a href="https://www.docker.com/products/business" target="_blank" rel="noopener">Docker Business</a></li>
                        <li><a href="https://www.docker.com/products" target="_blank" rel="noopener">サブスクリプション比較</a></li>
                        <li><b><a href="https://www.docker.com/" target="_blank" rel="noopener">機能</a></b></li>
                        <li><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">Docker Desktop</a></li>
                        <li><a href="https://www.docker.com/products/docker-hub" target="_blank" rel="noopener">Docker Hub</a></li>
                        <li><a href="https://www.docker.com/products/secure-software-supply-chain" target="_blank" rel="noopener">セキュアなソフトウェアサプライチェーン</a></li>
                        <li><a href="https://www.docker.com/products/container-runtime" target="_blank" rel="noopener">コンテナーランタイム</a></li>
                        <li><a href="https://www.docker.com/products/developer-tools" target="_blank" rel="noopener">開発ツール</a></li>
                        <li><a href="https://www.docker.com/partners" target="_blank" rel="noopener">信頼できるコンテント</a></li>
                        <li><a href="https://www.docker.com/roadmap" target="_blank" rel="noopener">Docker 製品ロードマップ</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">開発者</a></b></li>
                        <li><a href="https://www.docker.com/use-cases" target="_blank" rel="noopener">利用例</a></li>
                        <li><a href="https://docs.docker.com/get-started/" target="_blank" rel="noopener">はじめよう</a></li>
                        <li><a href="https://www.docker.com/blog/" target="_blank" rel="noopener">ブログ</a></li>
                        <li><a href="https://www.docker.com/docker-community" target="_blank" rel="noopener">コミュニティー</a></li>
                        <li><a href="https://www.docker.com/open-source" target="_blank" rel="noopener">オープンソース</a></li>
                        <li><a href="https://www.docker.com/community/get-involved/developer-preview" target="_blank" rel="noopener">プレビュープログラム</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">価格体系</a></b></li>
                        <li><a href="https://www.docker.com/pricing/faq" target="_blank" rel="noopener">FAQ</a></li>
                        <li><a href="https://www.docker.com/partners/programs" target="_blank" rel="noopener">Docker 認定公開者向けプログラム</a></li>
                        <li><a href="https://www.docker.com/partners" target="_blank" rel="noopener">パートナー</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/company" target="_blank" rel="noopener">会社概要</a></b></li>
                        <li><a href="https://www.docker.com/what-container" target="_blank" rel="noopener">コンテナーって何？</a></li>
                        <li><a href="https://www.docker.com/why-docker" target="_blank" rel="noopener">なぜ Docker？</a></li>
                        <li><a href="https://www.docker.com/events" target="_blank" rel="noopener">仮想イベント</a></li>
                        <li><a href="https://www.docker.com/swag" target="_blank" rel="noopener">Swag ストア
                        </a></li>
                        <li><a href="https://www.docker.com/company/newsroom" target="_blank" rel="noopener">ニュースルーム</a></li>
                        <li><a href="https://www.docker.com/careers" target="_blank" rel="noopener">採用情報</a></li>
                        <li><a href="https://www.docker.com/company/contact" target="_blank" rel="noopener">連絡先</a></li>
                        <li><a href="https://www.docker.com/customers" target="_blank" rel="noopener">顧客</a></li>
                        <li><a href="https://www.docker.com/newsletter-subscription" target="_blank" rel="noopener">ニュースレター</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="https://www.docker.com/legal/docker-terms-service" target="_blank" rel="noopener">サービス契約</a></li>
                        <li><a href="https://status.docker.com/" target="_blank" rel="noopener">ステータス</a></li>
                        <li><a href="https://www.docker.com/legal" target="_blank" rel="noopener">法的情報</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2013-2021 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="https://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="https://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-slideshare"><a href="https://www.slideshare.net/docker">Slideshare</a></li>
                    <li class="fa fa-reddit"><a href="https://www.reddit.com/r/docker">Reddit</a></li>
                </ul>
            </div>
        </div>
    </div>

    </footer>
    <script>const pageURL = "/engine/reference/commandline/dockerd/";</script></body>
</html>
