<!-- Page generated 2022-01-29 12:46:04 +0900-->
<!DOCTYPE html>
<html lang="ja"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>ストレージドライバーについて | Docker ドキュメント</title>
  <meta name="description" content="Learn the technologies that support storage drivers." />
  <meta name="keywords" content="container, storage, driver, AUFS, btrfs, devicemapper, overlayfs, vfs, zfs">
  <link rel="canonical" href="https://localhost:4000{{ site.baseurl }}/storage/storagedriver/" />

  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <link rel="apple-touch-icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta name="msapplication-TileImage" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico">
  <meta property="og:image" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
  <meta name="theme-color" content="#2496ed" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- hide elements that are only shown without JavaScript enabled -->
  <script>document.documentElement.classList.add('js')</script>
  <style>html.js .no-js { display: none !important; }</style><script defer src="/docs.docker.jp.onthefly/js/theme-switcher.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/anchorlinks.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/jquery.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/docs.js"></script><script defer src="/docs.docker.jp.onthefly/js/search.js"></script><link rel="preload" as="font" href="https://fonts.gstatic.com/s/opensans/v18/mem8YaGs126MiZpBA-UFVZ0bf8pkAg.woff2" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/geomanist/hinted-Geomanist-Book.woff2"    type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/geomanist/hinted-Geomanist-Regular.woff2" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/glyphicons-halflings-regular.woff2"       type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/fontawesome-webfont.woff2?v=4.7.0"        type="font/woff2" crossorigin="anonymous">

  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/font-awesome.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/bootstrap.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/style.css" id="pagestyle">

  <!-- SEO stuff -->
  <meta name="twitter:title" itemprop="title name" content="ストレージドライバーについて"/>
  <meta name="twitter:description" property="og:description" itemprop="description" content="" />
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:domain" content="matsuand.github.io"/>
  <meta name="twitter:site" content="@docker_docs"/>
  <meta name="twitter:url" content="https://twitter.com/docker_docs"/>
  <meta name="twitter:image:src" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:image:alt" content="Docker ドキュメント"/>
  <meta property="og:title" content="ストレージドライバーについて" />
  <meta property="og:description" content="Learn the technologies that support storage drivers." />
  <meta property="og:type" content="website"/>
  <meta property="og:updated_time" itemprop="dateUpdated" content="2022-01-29T12:46:04+09:00"/>
  <meta property="og:image" itemprop="image primaryImageOfPage" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta property="og:locale" content="ja_JP" />
  <meta property="og:url" content="https://matsuand.github.io/docs.docker.jp.onthefly/storage/storagedriver/" />
  <meta property="og:site_name" content="Docker ドキュメント" />
  <meta property="article:published_time" itemprop="datePublished" content="2022-01-29T12:46:04+09:00"/>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebPage","headline":"ストレージドライバーについて","description":"Learn the technologies that support storage drivers.","url":"https://docs.docker.com/storage/storagedriver/"}</script>
  <!-- END SEO STUFF -->
</head>
<body class="colums">
    <header>
        <nav class="nav-secondary navbar navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="/docs.docker.jp.onthefly/">
                <img class="logo" src="/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs" width="160" height="28" />
            </a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="logo-mobile">
    <a href="/docs.docker.jp.onthefly/">
        <img src="/docs.docker.jp.onthefly/images/docker-icon.svg" alt="Docker Docs" title="Docker Docs" width="30" height="30" />
    </a>
</div>
<div class="search-form" id="search-div">
    <form class="search-form form-inline" id="searchForm" action="/docs.docker.jp.onthefly/search/" method="get">
        <label for="st-search-input" class="sr-only">検索</label>
        <input class="search-field form-control ds-input" id="st-search-input" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteResults"></div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container hidden-sm hidden-xs">
    <div>
        <ul class="nav navbar-nav"><li><a href="/docs.docker.jp.onthefly/" id="home">ホーム</a></li><li><a href="/docs.docker.jp.onthefly/get-started/overview/" id="guides">ガイド</a></li><li><a href="/docs.docker.jp.onthefly/desktop/" id="manuals">マニュアル</a></li><li><a href="/docs.docker.jp.onthefly/reference/" id="reference">リファレンス</a></li><li><a href="/docs.docker.jp.onthefly/samples/" id="samples">サンプル</a></li></ul>
    </div>
    <div class="ctrl-right">
        <a href="javascript:void(0)" id="menu-toggle" aria-label="現在ページのメニュートグル"><i class="fa fa-indent" aria-hidden="true"></i></a>
    </div>
</div>
<div class="row hidden-sm hidden-xs">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li><a href="/docs.docker.jp.onthefly/" title="Docker docs homepage"><i class="fa fa-home"></i></a></li>
            <li><a href="/docs.docker.jp.onthefly/get-started/overview/">ガイド</a></li><li><a>本番環境でのアプリ運用</a></li><li><a href="/docs.docker.jp.onthefly/storage/">アプリデータの管理</a></li><li><a href="/docs.docker.jp.onthefly/storage/storagedriver/">コンテナー内へのデータ保存</a></li><li><a href="/docs.docker.jp.onthefly/storage/storagedriver/">ストレージドライバーについて</a></li></ol>
    </nav>
</div></div>
    </div>
</nav>

    </header>
    <div class="wrapper right-open">
        <div class="container-fluid">
            <div class="row">
                <div class="col-body">
                    <main class="col-content content">
                        <section class="section"><h1>ストレージドライバーについて</h1><p><em class="reading-time">読む時間の目安: 14 分</em></p><p>ストレージドライバーを効率よく利用するためには、Docker がどのようにしてイメージをビルドし保存するのか、またそのイメージをコンテナーがどのように利用するのかを理解しておくことが重要です。
これがわかっていれば、その知識に基づいた判断として、アプリケーションデータの適切な保存方法や、アプリケーション稼動中のパフォーマンス問題に対して、最良の方策をとることができます。</p>

<h2 id="storage-drivers-versus-docker-volumes">ストレージドライバー vs. Docker ボリューム</h2>

<p>Docker uses storage drivers to store image layers, and to store data in the
writable layer of a container. The container’s writable layer does not persist
after the container is deleted, but is suitable for storing ephemeral data that
is generated at runtime. Storage drivers are optimized for space efficiency, but
(depending on the storage driver) write speeds are lower than native file system
performance, especially for storage drivers that use a copy-on-write filesystem.
Write-intensive applications, such as database storage, are impacted by a
performance overhead, particularly if pre-existing data exists in the read-only
layer.</p>

<p>Use Docker volumes for write-intensive data, data that must persist beyond the
container’s lifespan, and data that must be shared between containers. Refer to
the <a href="/docs.docker.jp.onthefly/storage/volumes/">volumes section</a> to learn how to use volumes to persist data
and improve performance.</p>

<h2 id="images-and-layers">イメージとレイヤー</h2>

<p>Docker イメージは一連のレイヤーから構成されます。
個々のレイヤーは、そのイメージの Dockerfile 内にある 1 つの命令に対応づいています。
一番最後にあるレイヤーを除き、これ以外はすべて読み込み専用のレイヤーです。
たとえば以下のような Dockerfile を考えてみます。</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># syntax=docker/dockerfile:1</span>
<span class="k">FROM</span><span class="s"> ubuntu:18.04</span>
<span class="k">LABEL</span><span class="s"> org.opencontainers.image.authors="org@example.com"</span>
<span class="k">COPY</span><span class="s"> . /app</span>
<span class="k">RUN </span>make /app
<span class="k">RUN </span><span class="nb">rm</span> <span class="nt">-r</span> <span class="nv">$HOME</span>/.cache
<span class="k">CMD</span><span class="s"> python /app/app.py</span>
</code></pre></div></div>

<p>This Dockerfile contains four commands. Commands that modify the filesystem create
a layer. The<code class="language-plaintext highlighter-rouge">FROM</code> statement starts out by creating a layer from the <code class="language-plaintext highlighter-rouge">ubuntu:18.04</code>
image. The <code class="language-plaintext highlighter-rouge">LABEL</code> command only modifies the image’s metadata, and does not produce
a new layer. The <code class="language-plaintext highlighter-rouge">COPY</code> command adds some files from your Docker client’s current
directory. The first <code class="language-plaintext highlighter-rouge">RUN</code> command builds your application using the <code class="language-plaintext highlighter-rouge">make</code> command,
and writes the result to a new layer. The second <code class="language-plaintext highlighter-rouge">RUN</code> command removes a cache
directory, and writes the result to a new layer. Finally, the <code class="language-plaintext highlighter-rouge">CMD</code> instruction
specifies what command to run within the container, which only modifies the
image’s metadata, which does not produce an image layer.</p>

<p>Each layer is only a set of differences from the layer before it. Note that both
<em>adding</em>, and <em>removing</em> files will result in a new layer. In the example above,
the <code class="language-plaintext highlighter-rouge">$HOME/.cache</code> directory is removed, but will still be available in the
previous layer and add up to the image’s total size. Refer to the
<a href="/docs.docker.jp.onthefly/develop/develop-images/dockerfile_best-practices/">Best practices for writing Dockerfiles</a>
and <a href="/docs.docker.jp.onthefly/develop/develop-images/multistage-build/">use multi-stage builds</a>
sections to learn how to optimize your Dockerfiles for efficient images.</p>

<p>The layers are stacked on top of each other. When you create a new container,
you add a new writable layer on top of the underlying layers. This layer is often
called the “container layer”. All changes made to the running container, such as
writing new files, modifying existing files, and deleting files, are written to
this thin writable container layer. The diagram below shows a container based
on an <code class="language-plaintext highlighter-rouge">ubuntu:15.04</code> image.</p>

<p><img src="/docs.docker.jp.onthefly/storage/storagedriver/images/container-layers.jpg" alt="Ubuntu イメージに基づくコンテナーのレイヤー" /></p>

<p><strong>ストレージドライバー</strong> というものは、そういった各レイヤーが互いにやり取りできるようにします。
さまざまなストレージドライバーが利用可能であり、利用状況に応じて一長一短があります。</p>

<h2 id="container-and-layers">コンテナーとレイヤー</h2>

<p>コンテナーとイメージの大きな違いは、最上部に書き込みレイヤーがあるかどうかです。
コンテナーに対して新たに加えられたり修正されたりしたデータは、すべてこの書き込みレイヤーに保存されます。
コンテナーが削除されると、その書き込みレイヤーも同じく削除されます。
ただしその元にあったイメージは、変更されずに残ります。</p>

<p>複数のコンテナーを見た場合、そのコンテナーごとに個々の書き込み可能なコンテナーレイヤーがあって、データ更新結果はそのコンテナーレイヤーに保存されます。
したがって複数コンテナーでは、同一のイメージを共有しながらアクセスすることができ、しかも個々に見れば独自の状態を持つことができることになります。
以下の図は、Ubuntu 15.04 という同一のイメージを共有する複数コンテナーを示しています。</p>

<p><img src="/docs.docker.jp.onthefly/storage/storagedriver/images/sharing-layers.jpg" alt="同一のイメージを共有する複数コンテナー" /></p>

<p>Docker はストレージドライバーを利用して、イメージレイヤーと書き込み可能なコンテナーレイヤーの各内容を管理します。
さまざまなストレージドライバーでは、異なる実装によりデータを扱います。
しかしどのようなドライバーであっても、積み上げ可能な（stackable）イメージレイヤーを取り扱い、コピーオンライト（copy-on-write; CoW）方式を採用します。</p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>複数イメージを必要としていて、さらに同一のデータを共有してアクセスしたい場合は、Docker ボリュームを用いてください。
ボリュームについての詳細は <a href="/docs.docker.jp.onthefly/storage/volumes/">ボリュームの節</a> を参照してください。</p>
</blockquote>

<h2 id="container-size-on-disk">ディスク上のコンテナーサイズ</h2>

<p>稼働中コンテナーの概算サイズを確認するには<code class="language-plaintext highlighter-rouge">docker ps -s</code>コマンドを実行します。
サイズに関連した 2 つのデータがカラム表示されます。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">size</code>＝（ディスク上の）データ総量。
各コンテナーの書き込みレイヤーが利用するデータ部分です。</li>
  <li><code class="language-plaintext highlighter-rouge">virtual size</code>＝ コンテナーにおいて利用されている読み込み専用のイメージデータと、コンテナーの書き込みレイヤーの<code class="language-plaintext highlighter-rouge">size</code>を足し合わせたデータ総量。
複数コンテナーにおいては、読み込み専用イメージデータの全部または一部を共有しているかもしれません。
1 つのイメージをベースとして作った 2 つのコンテナーでは、読み込み専用データを 100% 共有します。
一方で 2 つの異なるイメージが一部に共通するレイヤーを持っていて、そこからそれぞれに 2 つのコンテナーを作ったとすると、共有するのはその共通レイヤー部分のみです。
したがって<code class="language-plaintext highlighter-rouge">virtual size</code>は単純に足し合わせで計算できるものではありません。
これはディスク総量を多く見積もってしまい、その量は無視できないほどになることがあります。</li>
</ul>

<p>起動しているコンテナーすべてが利用するディスク総量は、各コンテナーの<code class="language-plaintext highlighter-rouge">size</code>と<code class="language-plaintext highlighter-rouge">virtual size</code>を適宜組み合わせた値になります。
1 つのイメージだけに基づいた複数コンテナーの場合、そのディスク総量は、すべての<code class="language-plaintext highlighter-rouge">size</code>の合計に 1 つのイメージサイズ（<code class="language-plaintext highlighter-rouge">virtual size</code>- <code class="language-plaintext highlighter-rouge">size</code>）を加えて得られます。</p>

<p>またコンテナーがディスク領域を消費するものであっても、以下に示す状況はディスク総量の算定には含まれません。</p>

<ul>
  <li><a href="/docs.docker.jp.onthefly/config/containers/logging/">ログドライバー</a> を利用している場合に、そのログファイルが利用するディスク量。
コンテナーにおいてログ出力を大量に行っていて、ログローテーションを用いていない場合には、このディスク量は無視できないものになります。</li>
  <li>コンテナーが利用するボリュームやバインドマウント。</li>
  <li>コンテナーの設定ファイルが利用するディスク領域。
そのデータ容量は少ないのが普通です。</li>
  <li>（スワップが有効である場合に）ディスクに書き込まれるメモリデータ。</li>
  <li>試験的な checkpoint/restore 機能を利用している場合のチェックポイント。</li>
</ul>

<h2 id="the-copy-on-write-cow-strategy">コピーオンライト方式</h2>

<p>コピーオンライト（copy-on-write; CoW）は、ファイルの共有とコピーを最も効率よく行う方式です。
イメージ内の下の方にあるレイヤーに、ファイルやディレクトリが存在していた場合に、別のレイヤー（書き込みレイヤーを含む）からの読み込みアクセスが必要であるとします。
このときには、当然のことながら存在しているそのファイルを利用します。
そのファイルを修正する必要のある別のレイヤーがあったとすると、これを初めて修正するとき（イメージがビルドされたときやコンテナーが起動したときなど）、そのファイルはレイヤーにコピーされた上で修正されます。
こうすることで入出力を最小限に抑え、次に続くレイヤーの各サイズも増やさずに済みます。
この利点に関しては、さらに詳しく後述します。</p>

<h3 id="sharing-promotes-smaller-images">共有によりイメージサイズはより小さく</h3>

<p><code class="language-plaintext highlighter-rouge">docker pull</code>を実行してリポジトリからイメージをプルするとき、あるいはイメージから新たにコンテナーを生成するにあたってそのイメージがまだローカルに生成されていないとき、各レイヤーはプルによって個別に取得されて、Docker のローカル保存領域、たとえば Linux では通常<code class="language-plaintext highlighter-rouge">/var/lib/docker/</code>に保存されます。
取得された各レイヤーは、以下の例のようにして確認することができます。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>docker pull ubuntu:18.04
<span class="go">18.04: Pulling from library/ubuntu
f476d66f5408: Pull complete
8882c27f669e: Pull complete
d9af21273955: Pull complete
f5029279ec12: Pull complete
Digest: sha256:ab6cb8de3ad7bb33e2534677f865008535427390b117d7939193f8d1a6613e34
Status: Downloaded newer image for ubuntu:18.04
</span></code></pre></div></div>

<p>各レイヤーは、Docker ホストのローカル保存領域内にて、それぞれのディレクトリ配下に保存されます。
ファイルシステム上のレイヤーデータを確認するなら、<code class="language-plaintext highlighter-rouge">/var/lib/docker/&lt;storage-driver&gt;</code>の内容を一覧表示します。
以下は<code class="language-plaintext highlighter-rouge">overlay2</code>ストレージドライバーに対する例です。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">ls</span> /var/lib/docker/overlay2
<span class="go">16802227a96c24dcbeab5b37821e2b67a9f921749cd9a2e386d5a6d5bc6fc6d3
377d73dbb466e0bc7c9ee23166771b35ebdbe02ef17753d79fd3571d4ce659d7
3f02d96212b03e3383160d31d7c6aeca750d2d8a1879965b89fe8146594c453d
ec1ec45792908e90484f7e629330666e7eee599f08729c93890a7205a6ba35f5
l
</span></code></pre></div></div>

<p>ディレクトリ名はレイヤー ID に対応するものではありません。</p>

<p>ここで 2 つの異なる Dockerfile を利用している状況を考えます。
1 つめの Dockerfile からは<code class="language-plaintext highlighter-rouge">acme/my-base-image:1.0</code>というイメージが作られるものとします。</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># syntax=docker/dockerfile:1</span>
<span class="k">FROM</span><span class="s"> alpine</span>
<span class="k">RUN </span>apk add <span class="nt">--no-cache</span> bash
</code></pre></div></div>

<p>2 つめの Dockerfile は<code class="language-plaintext highlighter-rouge">acme/my-base-image:1.0</code>をベースとして、さらにレイヤーを追加するものとします。</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># syntax=docker/dockerfile:1</span>
<span class="k">FROM</span><span class="s"> acme/my-base-image:1.0</span>
<span class="k">COPY</span><span class="s"> . /app</span>
<span class="k">RUN </span><span class="nb">chmod</span> +x /app/hello.sh
<span class="k">CMD</span><span class="s"> /app/hello.sh</span>
</code></pre></div></div>

<p>2 つめのイメージには 1 つめのイメージが持つレイヤーがすべて含まれ、さらに<code class="language-plaintext highlighter-rouge">COPY</code>と<code class="language-plaintext highlighter-rouge">RUN</code>命令による新たなレイヤーと、読み書き可能なコンテナーレイヤーが加わっています。
Docker にとって 1 つめのイメージにおけるレイヤーはすべて取得済であるため、再度プルによって取得する必要がありません。
2 つのイメージにおいて共通して存在しているレイヤーは、すべて共有します。</p>

<p>この 2 つの Dockerfile からイメージをビルドした場合、<code class="language-plaintext highlighter-rouge">docker image ls</code>や<code class="language-plaintext highlighter-rouge">docker image history</code>コマンドを使ってみると、共有されているレイヤーに対する暗号化 ID は同一になっていることがわかります。</p>

<ol>
  <li>
    <p>新規に<code class="language-plaintext highlighter-rouge">cow-test/</code>というディレクトリを生成して移動します。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">cow-test/</code>ディレクトリにて、以下の内容で新規ファイル<code class="language-plaintext highlighter-rouge">hello.sh</code>を生成します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
<span class="nb">echo</span> <span class="s2">"Hello world"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>前述した 1 つめの Dockerfile の内容を、新規ファイル<code class="language-plaintext highlighter-rouge">Dockerfile.base</code>にコピーします。</p>
  </li>
  <li>
    <p>前述した 2 つめの Dockerfile の内容を、新規ファイル<code class="language-plaintext highlighter-rouge">Dockerfile</code>にコピーします。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">cow-test/</code>ディレクトリ内にて 1 つめのイメージをビルドします。
コマンドでは最後の<code class="language-plaintext highlighter-rouge">.</code>を記述するのを忘れないでください。
これは<code class="language-plaintext highlighter-rouge">PATH</code>を指定するものであり、イメージに対してファイルの追加が必要となる場合に、そのファイルを探し出す場所を Docker に指示するものです。</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>docker build <span class="nt">-t</span> acme/my-base-image:1.0 <span class="nt">-f</span> Dockerfile.base <span class="nb">.</span>
<span class="go">[+] Building 6.0s (11/11) FINISHED
</span><span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>internal] load build definition from Dockerfile.base                                      0.4s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">=&gt;</span> transferring dockerfile: 116B                                                           0.0s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>internal] load .dockerignore                                                              0.3s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">=&gt;</span> transferring context: 2B                                                                0.0s
<span class="gp">=&gt;</span><span class="w"> </span>resolve image config <span class="k">for </span>docker.io/docker/dockerfile:1                                     1.5s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>auth] docker/dockerfile:pull token <span class="k">for </span>registry-1.docker.io                               0.0s
<span class="gp">=&gt;</span><span class="w"> </span>CACHED docker-image://docker.io/docker/dockerfile:1@sha256:9e2c9eca7367393aecc68795c671... 0.0s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>internal] load .dockerignore                                                              0.0s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>internal] load build definition from Dockerfile.base                                      0.0s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>internal] load metadata <span class="k">for </span>docker.io/library/alpine:latest                               0.0s
<span class="gp">=&gt;</span><span class="w"> </span>CACHED <span class="o">[</span>1/2] FROM docker.io/library/alpine                                                 0.0s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>2/2] RUN apk add <span class="nt">--no-cache</span> bash                                                          3.1s
<span class="gp">=&gt;</span><span class="w"> </span>exporting to image                                                                         0.2s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">=&gt;</span> exporting layers                                                                        0.2s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">=&gt;</span> writing image sha256:da3cf8df55ee9777ddcd5afc40fffc3ead816bda99430bad2257de4459625eaa   0.0s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">=&gt;</span> naming to docker.io/acme/my-base-image:1.0                                              0.0s
</code></pre></div>    </div>
  </li>
  <li>
    <p>2 つめのイメージをビルドします。</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>docker build <span class="nt">-t</span> acme/my-final-image:1.0 <span class="nt">-f</span> Dockerfile <span class="nb">.</span>
<span class="go">
[+] Building 3.6s (12/12) FINISHED
</span><span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>internal] load build definition from Dockerfile                                            0.1s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">=&gt;</span> transferring dockerfile: 156B                                                            0.0s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>internal] load .dockerignore                                                               0.1s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">=&gt;</span> transferring context: 2B                                                                 0.0s
<span class="gp">=&gt;</span><span class="w"> </span>resolve image config <span class="k">for </span>docker.io/docker/dockerfile:1                                      0.5s
<span class="gp">=&gt;</span><span class="w"> </span>CACHED docker-image://docker.io/docker/dockerfile:1@sha256:9e2c9eca7367393aecc68795c671...  0.0s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>internal] load .dockerignore                                                               0.0s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>internal] load build definition from Dockerfile                                            0.0s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>internal] load metadata <span class="k">for </span>docker.io/acme/my-base-image:1.0                               0.0s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>internal] load build context                                                               0.2s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">=&gt;</span> transferring context: 340B                                                               0.0s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>1/3] FROM docker.io/acme/my-base-image:1.0                                                 0.2s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>2/3] COPY <span class="nb">.</span> /app                                                                           0.1s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">[</span>3/3] RUN <span class="nb">chmod</span> +x /app/hello.sh                                                            0.4s
<span class="gp">=&gt;</span><span class="w"> </span>exporting to image                                                                          0.1s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">=&gt;</span> exporting layers                                                                         0.1s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">=&gt;</span> writing image sha256:8bd85c42fa7ff6b33902ada7dcefaaae112bf5673873a089d73583b0074313dd    0.0s
<span class="gp">=&gt;</span><span class="w"> </span><span class="o">=&gt;</span> naming to docker.io/acme/my-final-image:1.0                                              0.0s
</code></pre></div>    </div>
  </li>
  <li>
    <p>2 つのイメージのサイズを確認します。</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>docker image <span class="nb">ls</span>
<span class="go">
REPOSITORY             TAG     IMAGE ID         CREATED               SIZE
acme/my-final-image    1.0     8bd85c42fa7f     About a minute ago    7.75MB
acme/my-base-image     1.0     da3cf8df55ee     2 minutes ago         7.75MB
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>それぞれのイメージの履歴を確認します。</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>docker image <span class="nb">history </span>acme/my-base-image:1.0
<span class="go">
IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT
</span><span class="gp">da3cf8df55ee   5 minutes ago   RUN /bin/sh -c apk add --no-cache bash #</span><span class="w"> </span>bui…   2.15MB    buildkit.dockerfile.v0
<span class="gp">&lt;missing&gt;</span><span class="w">      </span>7 weeks ago     /bin/sh <span class="nt">-c</span> <span class="c">#(nop)  CMD ["/bin/sh"]              0B</span>
<span class="gp">&lt;missing&gt;</span><span class="w">      </span>7 weeks ago     /bin/sh <span class="nt">-c</span> <span class="c">#(nop) ADD file:f278386b0cef68136…   5.6MB</span>
</code></pre></div>    </div>

    <p>処理ステップの中にはサイズを持たないもの (<code class="language-plaintext highlighter-rouge">0B</code>) があります。
メタデータだけが変更されたものであって、イメージレイヤーが生成されたものではないため、メタデータそのものを除くと、容量をまったく取っていません。
上の出力結果から、このイメージは 2 つのイメージレイヤーから構成されることがわかります。</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>docker image <span class="nb">history  </span>acme/my-final-image:1.0
<span class="go">
IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT
8bd85c42fa7f   3 minutes ago   CMD ["/bin/sh" "-c" "/app/hello.sh"]            0B        buildkit.dockerfile.v0
</span><span class="gp">&lt;missing&gt;</span><span class="w">      </span>3 minutes ago   RUN /bin/sh <span class="nt">-c</span> <span class="nb">chmod</span> +x /app/hello.sh <span class="c"># buil…   39B       buildkit.dockerfile.v0</span>
<span class="gp">&lt;missing&gt;</span><span class="w">      </span>3 minutes ago   COPY <span class="nb">.</span> /app <span class="c"># buildkit                          222B      buildkit.dockerfile.v0</span>
<span class="gp">&lt;missing&gt;</span><span class="w">      </span>4 minutes ago   RUN /bin/sh <span class="nt">-c</span> apk add <span class="nt">--no-cache</span> bash <span class="c"># bui…   2.15MB    buildkit.dockerfile.v0</span>
<span class="gp">&lt;missing&gt;</span><span class="w">      </span>7 weeks ago     /bin/sh <span class="nt">-c</span> <span class="c">#(nop)  CMD ["/bin/sh"]              0B</span>
<span class="gp">&lt;missing&gt;</span><span class="w">      </span>7 weeks ago     /bin/sh <span class="nt">-c</span> <span class="c">#(nop) ADD file:f278386b0cef68136…   5.6MB</span>
</code></pre></div>    </div>

    <p>Notice that all steps of the first image are also included in the final
image. The final image includes the two layers from the first image, and
two layers that were added in the second image.</p>

    <blockquote>
      <p>What are the <code class="language-plaintext highlighter-rouge">&lt;missing&gt;</code> steps?</p>

      <p>The <code class="language-plaintext highlighter-rouge">&lt;missing&gt;</code> lines in the <code class="language-plaintext highlighter-rouge">docker history</code> output indicate that those
steps were either built on another system and part of the <code class="language-plaintext highlighter-rouge">alpine</code> image
that was pulled from Docker Hub, or were built with BuildKit as builder.
Before BuildKit, the “classic” builder would produce a new “intermediate”
image for each step for caching purposes, and the <code class="language-plaintext highlighter-rouge">IMAGE</code> column would show
the ID of that image.
BuildKit uses its own caching mechanism, and no longer requires intermediate
images for caching. Refer to <a href="/docs.docker.jp.onthefly/develop/develop-images/build_enhancements/">build images with BuildKit</a>
to learn more about other enhancements made in BuildKit.</p>
    </blockquote>
  </li>
  <li>
    <p>Check out the layers for each image</p>

    <p>Use the <code class="language-plaintext highlighter-rouge">docker image inspect</code> command to view the cryptographic IDs of the
layers in each image:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>docker image inspect <span class="nt">--format</span> <span class="s2">"{{json .RootFS.Layers}}"</span> acme/my-base-image:1.0
<span class="go">[
  "sha256:72e830a4dff5f0d5225cdc0a320e85ab1ce06ea5673acfe8d83a7645cbd0e9cf",
  "sha256:07b4a9068b6af337e8b8f1f1dae3dd14185b2c0003a9a1f0a6fd2587495b204a"
]
</span></code></pre></div>    </div>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>docker image inspect <span class="nt">--format</span> <span class="s2">"{{json .RootFS.Layers}}"</span> acme/my-final-image:1.0
<span class="go">[
  "sha256:72e830a4dff5f0d5225cdc0a320e85ab1ce06ea5673acfe8d83a7645cbd0e9cf",
  "sha256:07b4a9068b6af337e8b8f1f1dae3dd14185b2c0003a9a1f0a6fd2587495b204a",
  "sha256:cc644054967e516db4689b5282ee98e4bc4b11ea2255c9630309f559ab96562e",
  "sha256:e84fb818852626e89a09f5143dbc31fe7f0e0a6a24cd8d2eb68062b904337af4"
]
</span></code></pre></div>    </div>

    <p>Notice that the first two layers are identical in both images. The second
image adds two additional layers. Shared image layers are only stored once
in <code class="language-plaintext highlighter-rouge">/var/lib/docker/</code> and are also shared when pushing and pulling and image
to an image registry. Shared image layers can therefore reduce network
bandwidth and storage.</p>

    <blockquote>
      <p>Tip: format output of Docker commands with the <code class="language-plaintext highlighter-rouge">--format</code> option</p>

      <p>The examples above use the <code class="language-plaintext highlighter-rouge">docker image inspect</code> command with the <code class="language-plaintext highlighter-rouge">--format</code>
option to view the layer IDs, formatted as a JSON array. The <code class="language-plaintext highlighter-rouge">--format</code>
option on Docker commands can be a powerful feature that allows you to
extract and format specific information from the output, without requiring
additional tools such as <code class="language-plaintext highlighter-rouge">awk</code> or <code class="language-plaintext highlighter-rouge">sed</code>. To learn more about formatting
the output of docker commands using the <code class="language-plaintext highlighter-rouge">--format</code> flag, refer to the
<a href="/docs.docker.jp.onthefly/config/formatting/">format command and log output section</a>.
We also pretty-printed the JSON output using the <a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener" class="_"><code class="language-plaintext highlighter-rouge">jq</code> utility</a>
for readability.</p>
    </blockquote>
  </li>
</ol>

<h3 id="copying-makes-containers-efficient">コピーによりコンテナーを効率的に</h3>

<p>コンテナーを起動すると、それまであったレイヤーの最上部に、書き込み可能な薄いコンテナーレイヤーが加えられます。
コンテナーがファイルシステムに対して行った変更は、すべてそこに保存されます。
コンテナーが変更を行っていないファイルは、その書き込みレイヤーにはコピーされません。
つまり書き込みレイヤーは、できるだけ容量が小さく抑えられることになります。</p>

<p>コンテナー内にあるファイルが修正されると、ストレージドライバーはコピーオンライト方式により動作します。
そこで実行される各処理は、ストレージドライバーによってさまざまです。
<code class="language-plaintext highlighter-rouge">overlay2</code>、<code class="language-plaintext highlighter-rouge">overlay</code>、<code class="language-plaintext highlighter-rouge">aufs</code>といったドライバーの場合、だいたい以下のような順にコピーオンライト方式による処理が行われます。</p>

<ul>
  <li>更新するべきファイルをイメージレイヤー内から探します。
この処理は最新のレイヤーから始まって、ベースレイヤーに向けて順に降りていき、一度に 1 つのレイヤーを処理していきます。
ファイルが見つかるとこれをキャッシュに加えて、次回以降の処理スピードを上げることに備えます。</li>
  <li>見つかったファイルを初めてコピーするときには<code class="language-plaintext highlighter-rouge">copy_up</code>という処理が行われます。
これによってそのファイルをコンテナーの書き込みレイヤーにコピーします。</li>
  <li>修正が発生すると、コピーを行ったそのファイルが処理されます。
つまりコンテナーは、下位のレイヤー内に存在している読み込み専用のそのファイルを見にいくことはありません。</li>
</ul>

<p>Btrfs, ZFS といったドライバーにおけるコピーオンライト方式は、これとは異なります。
そのようなドライバーが行う手法の詳細は、後述するそれぞれの詳細説明を参照してください。</p>

<p>データを大量に書き込むようなコンテナーは、そういった書き込みを行わないコンテナーに比べて、データ領域をより多く消費します。
コンテナーの最上位にある書き込み可能な薄いレイヤー上に対して、書き込み処理を行うことは、たいていが新たなデータ領域を必要とするためです。
Note that changing the metadata of files,
for example, changing file permissions or ownership of a file, can also result
in a <code class="language-plaintext highlighter-rouge">copy_up</code> operation, therefore duplicating the file to the writable layer.</p>

<blockquote>
  <p>Tip: Use volumes for write-heavy applications</p>

  <p>For write-heavy applications, you should not store the data in the container.
Applications, such as write-intensive database storage, are known to be
problematic particularly when pre-existing data exists in the read-only layer.</p>

  <p>Instead, use Docker volumes, which are independent of the running container,
and designed to be efficient for I/O. In addition, volumes can be shared among
containers and do not increase the size of your container’s writable layer.
Refer to the <a href="/docs.docker.jp.onthefly/storage/volumes/">use volumes</a> section to learn about volumes.</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">copy_up</code>処理は際立った性能のオーバーヘッドを招きます。
このオーバーヘッドは、利用しているストレージドライバーによってさまざまです。
大容量ファイル、多数のレイヤー、深いディレクトリ階層といったものが、さらに影響します。
<code class="language-plaintext highlighter-rouge">copy_up</code>処理は対象となるファイルが初めて修正されたときにだけ実行されるので、オーバーヘッドはそれでも最小限に抑えられています。</p>

<p>コピーオンライトが動作している様子を確認するため、以下の例においては、前述した<code class="language-plaintext highlighter-rouge">acme/my-final-image:1.0</code>イメージをベースとする 5 つのコンテナーを見ていきます。
そして各コンテナーがどれだけの容量を消費しているかを確認します。</p>

<ol>
  <li>
    <p>Docker ホスト上の端末画面から、以下のような<code class="language-plaintext highlighter-rouge">docker run</code>コマンドを実行します。
各行の終わりには、各コンテナーの ID を入力します。</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>docker run <span class="nt">-dit</span> <span class="nt">--name</span> my_container_1 acme/my-final-image:1.0 bash <span class="se">\</span>
  <span class="o">&amp;&amp;</span> docker run <span class="nt">-dit</span> <span class="nt">--name</span> my_container_2 acme/my-final-image:1.0 bash <span class="se">\</span>
  <span class="o">&amp;&amp;</span> docker run <span class="nt">-dit</span> <span class="nt">--name</span> my_container_3 acme/my-final-image:1.0 bash <span class="se">\</span>
  <span class="o">&amp;&amp;</span> docker run <span class="nt">-dit</span> <span class="nt">--name</span> my_container_4 acme/my-final-image:1.0 bash <span class="se">\</span>
  <span class="o">&amp;&amp;</span> docker run <span class="nt">-dit</span> <span class="nt">--name</span> my_container_5 acme/my-final-image:1.0 bash
<span class="go">
40ebdd7634162eb42bdb1ba76a395095527e9c0aa40348e6c325bd0aa289423c
a5ff32e2b551168b9498870faf16c9cd0af820edf8a5c157f7b80da59d01a107
3ed3c1a10430e09f253704116965b01ca920202d52f3bf381fbb833b8ae356bc
939b3bf9e7ece24bcffec57d974c939da2bdcc6a5077b5459c897c1e2fa37a39
cddae31c314fbab3f7eabeb9b26733838187abc9a2ed53f97bd5b04cd7984a5a
</span></code></pre></div>    </div>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--size</code>オプションを使って<code class="language-plaintext highlighter-rouge">docker ps</code>コマンドを実行し、5 つのコンテナーが実行中であることを確認します。
そして各コンテナーのサイズを見てみます。</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>docker ps <span class="nt">--size</span> <span class="nt">--format</span> <span class="s2">"table {{.ID}}</span><span class="se">\t</span><span class="s2">{{.Image}}</span><span class="se">\t</span><span class="s2">{{.Names}}</span><span class="se">\t</span><span class="s2">{{.Size}}"</span>
<span class="go">
CONTAINER ID   IMAGE                     NAMES            SIZE
cddae31c314f   acme/my-final-image:1.0   my_container_5   0B (virtual 7.75MB)
939b3bf9e7ec   acme/my-final-image:1.0   my_container_4   0B (virtual 7.75MB)
3ed3c1a10430   acme/my-final-image:1.0   my_container_3   0B (virtual 7.75MB)
a5ff32e2b551   acme/my-final-image:1.0   my_container_2   0B (virtual 7.75MB)
40ebdd763416   acme/my-final-image:1.0   my_container_1   0B (virtual 7.75MB)
</span></code></pre></div>    </div>

    <p>The output above shows that all containers share the image’s read-only layers
(7.75MB), but no data was written to the container’s filesystem, so no additional
storage is used for the containers.</p>

    <blockquote>
      <p>Advanced: metadata and logs storage used for containers</p>

      <p><strong>Note</strong>: This step requires a Linux machine, and does not work on Docker
Desktop for Mac or Docker Desktop for Windows, as it requires access to
the Docker Daemon’s file storage.</p>

      <p>While the output of <code class="language-plaintext highlighter-rouge">docker ps</code> provides you information about disk space
consumed by a container’s writable layer, it does not include information
about metadata and log-files stored for each container.</p>

      <p>More details can be obtained by exploring the Docker Daemon’s storage location
(<code class="language-plaintext highlighter-rouge">/var/lib/docker</code> by default).</p>

      <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">sudo du</span> <span class="nt">-sh</span> /var/lib/docker/containers/<span class="k">*</span>
<span class="go">
36K  /var/lib/docker/containers/3ed3c1a10430e09f253704116965b01ca920202d52f3bf381fbb833b8ae356bc
36K  /var/lib/docker/containers/40ebdd7634162eb42bdb1ba76a395095527e9c0aa40348e6c325bd0aa289423c
36K  /var/lib/docker/containers/939b3bf9e7ece24bcffec57d974c939da2bdcc6a5077b5459c897c1e2fa37a39
36K  /var/lib/docker/containers/a5ff32e2b551168b9498870faf16c9cd0af820edf8a5c157f7b80da59d01a107
36K  /var/lib/docker/containers/cddae31c314fbab3f7eabeb9b26733838187abc9a2ed53f97bd5b04cd7984a5a
</span></code></pre></div>      </div>

      <p>Each of these containers only takes up 36k of space on the filesystem.</p>
    </blockquote>
  </li>
  <li>
    <p>Per-container storage</p>

    <p>To demonstrate this, run the following command to write the word ‘hello’ to
 a file on the container’s writable layer in containers <code class="language-plaintext highlighter-rouge">my_container_1</code>,
 <code class="language-plaintext highlighter-rouge">my_container_2</code>, and <code class="language-plaintext highlighter-rouge">my_container_3</code>:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp"> $</span><span class="w"> </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..3<span class="o">}</span><span class="p">;</span> <span class="k">do </span>docker <span class="nb">exec </span>my_container_<span class="nv">$i</span> sh <span class="nt">-c</span> <span class="s1">'printf hello &gt; /out.txt'</span><span class="p">;</span> <span class="k">done</span>
</code></pre></div>    </div>

    <p>Running the <code class="language-plaintext highlighter-rouge">docker ps</code> command again afterward shows that those containers
 now consume 5 bytes each. This data is unique to each container, and not
 shared. The read-only layers of the containers are not affected, and are still
 shared by all containers.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp"> $</span><span class="w"> </span>docker ps <span class="nt">--size</span> <span class="nt">--format</span> <span class="s2">"table {{.ID}}</span><span class="se">\t</span><span class="s2">{{.Image}}</span><span class="se">\t</span><span class="s2">{{.Names}}</span><span class="se">\t</span><span class="s2">{{.Size}}"</span>
<span class="go">
 CONTAINER ID   IMAGE                     NAMES            SIZE
 cddae31c314f   acme/my-final-image:1.0   my_container_5   0B (virtual 7.75MB)
 939b3bf9e7ec   acme/my-final-image:1.0   my_container_4   0B (virtual 7.75MB)
 3ed3c1a10430   acme/my-final-image:1.0   my_container_3   5B (virtual 7.75MB)
 a5ff32e2b551   acme/my-final-image:1.0   my_container_2   5B (virtual 7.75MB)
 40ebdd763416   acme/my-final-image:1.0   my_container_1   5B (virtual 7.75MB)
</span></code></pre></div>    </div>
  </li>
</ol>

<p>The examples above illustrate how copy-on-write filesystems help making containers
efficient. Not only does copy-on-write save space, but it also reduces container
start-up time. When you create a container (or multiple containers from the same
image), Docker only needs to create the thin writable container layer.</p>

<p>If Docker had to make an entire copy of the underlying image stack each time it
created a new container, container create times and disk space used would be
significantly increased. This would be similar to the way that virtual machines
work, with one or more virtual disks per virtual machine. The <a href="/docs.docker.jp.onthefly/storage/storagedriver/vfs-driver/"><code class="language-plaintext highlighter-rouge">vfs</code> storage</a>
does not provide a CoW filesystem or other optimizations. When using this storage
driver, a full copy of the image’s data is created for each container.</p>

<h2 id="related-information">関連情報</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/storage/volumes/">ボリューム</a></li>
  <li><a href="/docs.docker.jp.onthefly/storage/storagedriver/select-storage-driver/">ストレージドライバーの選定</a></li>
</ul>
<span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span style="vertical-align: 2px"><a href="/docs.docker.jp.onthefly/search/?q=container">container</a>, <a href="/docs.docker.jp.onthefly/search/?q=storage">storage</a>, <a href="/docs.docker.jp.onthefly/search/?q=driver">driver</a>, <a href="/docs.docker.jp.onthefly/search/?q=AUFS">AUFS</a>, <a href="/docs.docker.jp.onthefly/search/?q=btrfs">btrfs</a>, <a href="/docs.docker.jp.onthefly/search/?q=devicemapper">devicemapper</a>, <a href="/docs.docker.jp.onthefly/search/?q=overlayfs">overlayfs</a>, <a href="/docs.docker.jp.onthefly/search/?q=vfs">vfs</a>, <a href="/docs.docker.jp.onthefly/search/?q=zfs">zfs</a></span><div class="ratings-div"><div id="pd_rating_holder_8453675"></div></div></section>
                    </main>
                    <nav class="col-nav">
                        <div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
                            <div id="navbar" class="nav-sidebar">
                                <ul class="nav hidden-md hidden-lg"></ul>
                                <ul class="nav" id="jsTOCLeftNav"></ul>
                            </div>
                        </div>
                    </nav>
                    <div class="col-toc">
                        <div class="sidebar hidden-xs hidden-sm">
                            <div class="toc-nav">
                                <div class="feedback-links">
                                    <ul><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/edit/master/src/storage/storagedriver/index.ch"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 本ページの編集</a></li><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/issues/new?body=File: [storage/storagedriver/index.ch](https://matsuand.github.io/docs.docker.jp.onthefly/storage/storagedriver/)" class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 変更リクエスト</a></li>
                                        <li><div class="toggle-mode">
  <div class="icon">
      <i class="fa fa-sun-o" aria-hidden="true"></i>
  </div>
  <div class="toggle-switch">
      <label class="switch">
          <input type="checkbox" id="switch-style">
          <span class="slider round"></span>
      </label>
  </div>
  <div class="icon">
      <i class="fa fa-moon-o" aria-hidden="true"></i>
  </div>
</div>
</li>
                                    </ul>
                                </div><div id="side-toc-title">本ページ内:</div>
<ul id="my_toc" class="inline_toc">
  <li><a href="#storage-drivers-versus-docker-volumes" class="nomunge">ストレージドライバー vs. Docker ボリューム</a></li>
  <li><a href="#images-and-layers" class="nomunge">イメージとレイヤー</a></li>
  <li><a href="#container-and-layers" class="nomunge">コンテナーとレイヤー</a></li>
  <li><a href="#container-size-on-disk" class="nomunge">ディスク上のコンテナーサイズ</a></li>
  <li><a href="#the-copy-on-write-cow-strategy" class="nomunge">コピーオンライト方式</a>
    <ul>
      <li><a href="#sharing-promotes-smaller-images" class="nomunge">共有によりイメージサイズはより小さく</a></li>
      <li><a href="#copying-makes-containers-efficient" class="nomunge">コピーによりコンテナーを効率的に</a></li>
    </ul>
  </li>
  <li><a href="#related-information" class="nomunge">関連情報</a></li>
</ul>

</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">
          
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products" target="_blank" rel="noopener">製品ラインアップ</a></b></li>
                        <li><a href="https://www.docker.com/products/personal" target="_blank" rel="noopener">Docker Personal</a></li>
                        <li><a href="https://www.docker.com/products/pro" target="_blank" rel="noopener">Docker Pro</a></li>
                        <li><a href="https://www.docker.com/products/team" target="_blank" rel="noopener">Docker Team</a></li>
                        <li><a href="https://www.docker.com/products/business" target="_blank" rel="noopener">Docker Business</a></li>
                        <li><a href="https://www.docker.com/products" target="_blank" rel="noopener">サブスクリプション比較</a></li>
                        <li><b><a href="https://www.docker.com/" target="_blank" rel="noopener">機能</a></b></li>
                        <li><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">Docker Desktop</a></li>
                        <li><a href="https://www.docker.com/products/docker-hub" target="_blank" rel="noopener">Docker Hub</a></li>
                        <li><a href="https://www.docker.com/products/secure-software-supply-chain" target="_blank" rel="noopener">セキュアなソフトウェアサプライチェーン</a></li>
                        <li><a href="https://www.docker.com/products/container-runtime" target="_blank" rel="noopener">コンテナーランタイム</a></li>
                        <li><a href="https://www.docker.com/products/developer-tools" target="_blank" rel="noopener">開発ツール</a></li>
                        <li><a href="https://www.docker.com/partners" target="_blank" rel="noopener">信頼できるコンテント</a></li>
                        <li><a href="https://www.docker.com/roadmap" target="_blank" rel="noopener">Docker 製品ロードマップ</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">開発者</a></b></li>
                        <li><a href="https://www.docker.com/use-cases" target="_blank" rel="noopener">利用例</a></li>
                        <li><a href="https://docs.docker.com/get-started/" target="_blank" rel="noopener">はじめよう</a></li>
                        <li><a href="https://www.docker.com/blog/" target="_blank" rel="noopener">ブログ</a></li>
                        <li><a href="https://www.docker.com/docker-community" target="_blank" rel="noopener">コミュニティー</a></li>
                        <li><a href="https://www.docker.com/open-source" target="_blank" rel="noopener">オープンソース</a></li>
                        <li><a href="https://www.docker.com/community/get-involved/developer-preview" target="_blank" rel="noopener">プレビュープログラム</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">価格体系</a></b></li>
                        <li><a href="https://www.docker.com/pricing/faq" target="_blank" rel="noopener">FAQ</a></li>
                        <li><a href="https://www.docker.com/partners/programs" target="_blank" rel="noopener">Docker 認定公開者向けプログラム</a></li>
                        <li><a href="https://www.docker.com/partners" target="_blank" rel="noopener">パートナー</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/company" target="_blank" rel="noopener">会社概要</a></b></li>
                        <li><a href="https://www.docker.com/what-container" target="_blank" rel="noopener">コンテナーって何？</a></li>
                        <li><a href="https://www.docker.com/why-docker" target="_blank" rel="noopener">なぜ Docker？</a></li>
                        <li><a href="https://www.docker.com/events" target="_blank" rel="noopener">仮想イベント</a></li>
                        <li><a href="https://www.docker.com/swag" target="_blank" rel="noopener">Swag ストア
                        </a></li>
                        <li><a href="https://www.docker.com/company/newsroom" target="_blank" rel="noopener">ニュースルーム</a></li>
                        <li><a href="https://www.docker.com/careers" target="_blank" rel="noopener">採用情報</a></li>
                        <li><a href="https://www.docker.com/company/contact" target="_blank" rel="noopener">連絡先</a></li>
                        <li><a href="https://www.docker.com/customers" target="_blank" rel="noopener">顧客</a></li>
                        <li><a href="https://www.docker.com/newsletter-subscription" target="_blank" rel="noopener">ニュースレター</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="https://www.docker.com/legal/docker-terms-service" target="_blank" rel="noopener">サービス契約</a></li>
                        <li><a href="https://status.docker.com/" target="_blank" rel="noopener">ステータス</a></li>
                        <li><a href="https://www.docker.com/legal" target="_blank" rel="noopener">法的情報</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2013-2021 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="https://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="https://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-slideshare"><a href="https://www.slideshare.net/docker">Slideshare</a></li>
                    <li class="fa fa-reddit"><a href="https://www.reddit.com/r/docker">Reddit</a></li>
                </ul>
            </div>
        </div>
    </div>

    </footer>
    <script>const pageURL = "/storage/storagedriver/";</script></body>
</html>
