<!DOCTYPE html>
<!-- Page generated 2022-04-25 09:39:05 +0900-->
<html lang="ja"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Use the Device Mapper storage driver | Docker ドキュメント</title>
  <meta name="description" content="Learn how to optimize your use of device mapper driver." />
  <meta name="keywords" content="container, storage, driver, device mapper">
  <link rel="canonical" href="https://localhost:4000{{ site.baseurl }}/storage/storagedriver/device-mapper-driver/" />

  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <link rel="apple-touch-icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta name="msapplication-TileImage" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico">
  <meta property="og:image" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
  <meta name="theme-color" content="#2496ed" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- hide elements that are only shown without JavaScript enabled -->
  <script>document.documentElement.classList.add('js')</script>
  <style>html.js .no-js { display: none !important; }</style><script defer src="/docs.docker.jp.onthefly/js/theme-switcher.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/anchorlinks.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/jquery.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/docs.js"></script><script defer src="/docs.docker.jp.onthefly/js/search.js"></script><link rel="preload" as="font" href="https://fonts.gstatic.com/s/opensans/v18/mem8YaGs126MiZpBA-UFVZ0bf8pkAg.woff2" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/geomanist/hinted-Geomanist-Book.woff2"    type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/geomanist/hinted-Geomanist-Regular.woff2" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/glyphicons-halflings-regular.woff2"       type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/fontawesome-webfont.woff2?v=4.7.0"        type="font/woff2" crossorigin="anonymous">

  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/font-awesome.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/bootstrap.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/style.css" id="pagestyle">

  <!-- SEO stuff -->
  <meta name="twitter:title" itemprop="title name" content="Use the Device Mapper storage driver"/>
  <meta name="twitter:description" property="og:description" itemprop="description" content="" />
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:domain" content="matsuand.github.io"/>
  <meta name="twitter:site" content="@docker_docs"/>
  <meta name="twitter:url" content="https://twitter.com/docker_docs"/>
  <meta name="twitter:image:src" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:image:alt" content="Docker ドキュメント"/>
  <meta property="og:title" content="Use the Device Mapper storage driver" />
  <meta property="og:description" content="Learn how to optimize your use of device mapper driver." />
  <meta property="og:type" content="website"/>
  <meta property="og:updated_time" itemprop="dateUpdated" content="2022-04-25T09:39:05+09:00"/>
  <meta property="og:image" itemprop="image primaryImageOfPage" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta property="og:locale" content="ja_JP" />
  <meta property="og:url" content="https://matsuand.github.io/docs.docker.jp.onthefly/storage/storagedriver/device-mapper-driver/" />
  <meta property="og:site_name" content="Docker ドキュメント" />
  <meta property="article:published_time" itemprop="datePublished" content="2022-04-25T09:39:05+09:00"/>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebPage","headline":"Use the Device Mapper storage driver","description":"Learn how to optimize your use of device mapper driver.","url":"https://docs.docker.com/storage/storagedriver/device-mapper-driver/"}</script>
  <!-- END SEO STUFF -->
</head>
<body class="colums">
    <header>
        <nav class="nav-secondary navbar navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="/docs.docker.jp.onthefly/">
                <img class="logo" src="/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs" width="160" height="28" />
            </a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="logo-mobile">
    <a href="/docs.docker.jp.onthefly/">
        <img src="/docs.docker.jp.onthefly/images/docker-icon.svg" alt="Docker Docs" title="Docker Docs" width="30" height="30" />
    </a>
</div>
<div class="search-form" id="search-div">
    <form class="search-form form-inline" id="searchForm" action="/docs.docker.jp.onthefly/search/" method="get">
        <label for="st-search-input" class="sr-only">検索</label>
        <input class="search-field form-control ds-input" id="st-search-input" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteResults"></div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container hidden-sm hidden-xs">
    <div>
        <ul class="nav navbar-nav"><li><a href="/docs.docker.jp.onthefly/" id="home">ホーム</a></li><li><a href="/docs.docker.jp.onthefly/get-started/overview/" id="guides">ガイド</a></li><li><a href="/docs.docker.jp.onthefly/desktop/" id="manuals">マニュアル</a></li><li><a href="/docs.docker.jp.onthefly/reference/" id="reference">リファレンス</a></li><li><a href="/docs.docker.jp.onthefly/samples/" id="samples">サンプル</a></li></ul>
    </div>
    <div class="ctrl-right">
        <a href="javascript:void(0)" id="menu-toggle" aria-label="現在ページのメニュートグル"><i class="fa fa-indent" aria-hidden="true"></i></a>
    </div>
</div>
<div class="row hidden-sm hidden-xs">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li><a href="/docs.docker.jp.onthefly/" title="Docker docs homepage"><i class="fa fa-home"></i></a></li>
            <li><a href="/docs.docker.jp.onthefly/get-started/overview/">ガイド</a></li><li><a>本番環境でのアプリ運用</a></li><li><a href="/docs.docker.jp.onthefly/storage/">アプリデータの管理</a></li><li><a href="/docs.docker.jp.onthefly/storage/storagedriver/">コンテナー内へのデータ保存</a></li><li><a href="/docs.docker.jp.onthefly/storage/storagedriver/device-mapper-driver/">Device mapper ストレージドライバーの利用</a></li></ol>
    </nav>
</div></div>
    </div>
</nav>

    </header>
    <div class="wrapper right-open">
        <div class="container-fluid">
            <div class="row">
                <div class="col-body">
                    <main class="col-content content">
                        <section class="section"><h1>Use the Device Mapper storage driver</h1><p><em class="reading-time">読む時間の目安: 28 分</em></p><p>Device Mapper is a kernel-based framework that underpins many advanced
volume management technologies on Linux. Docker’s <code class="highlighter-rouge">devicemapper</code> storage driver
leverages the thin provisioning and snapshotting capabilities of this framework
for image and container management. This article refers to the Device Mapper
storage driver as <code class="highlighter-rouge">devicemapper</code>, and the kernel framework as <em>Device Mapper</em>.</p>

<p>For the systems where it is supported, <code class="highlighter-rouge">devicemapper</code> support is included in
the Linux kernel. However, specific configuration is required to use it with
Docker.</p>

<p>The <code class="highlighter-rouge">devicemapper</code> driver uses block devices dedicated to Docker and operates at
the block level, rather than the file level. These devices can be extended by
adding physical storage to your Docker host, and they perform better than using
a filesystem at the operating system (OS) level.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li><code class="highlighter-rouge">devicemapper</code> is supported on Docker Engine - Community running on CentOS, Fedora,
SLES 15, Ubuntu, Debian, or RHEL.</li>
  <li><code class="highlighter-rouge">devicemapper</code> requires the <code class="highlighter-rouge">lvm2</code> and <code class="highlighter-rouge">device-mapper-persistent-data</code> packages
to be installed.</li>
  <li>Changing the storage driver makes any containers you have already
created inaccessible on the local system. Use <code class="highlighter-rouge">docker save</code> to save containers,
and push existing images to Docker Hub or a private repository, so you do
not need to recreate them later.</li>
</ul>

<h2 id="configure-docker-with-the-devicemapper-storage-driver">Configure Docker with the <code class="highlighter-rouge">devicemapper</code> storage driver</h2>

<p>Before following these procedures, you must first meet all the
<a href="#prerequisites">prerequisites</a>.</p>

<h3 id="configure-loop-lvm-mode-for-testing">Configure <code class="highlighter-rouge">loop-lvm</code> mode for testing</h3>

<p>This configuration is only appropriate for testing. The <code class="highlighter-rouge">loop-lvm</code> mode makes
use of a ‘loopback’ mechanism that allows files on the local disk to be
read from and written to as if they were an actual physical disk or block
device.
However, the addition of the loopback mechanism, and interaction with the OS
filesystem layer, means that IO operations can be slow and resource-intensive.
Use of loopback devices can also introduce race conditions.
However, setting up <code class="highlighter-rouge">loop-lvm</code> mode can help identify basic issues (such as
missing user space packages, kernel drivers, etc.) ahead of attempting the more
complex set up required to enable <code class="highlighter-rouge">direct-lvm</code> mode. <code class="highlighter-rouge">loop-lvm</code> mode should
therefore only be used to perform rudimentary testing prior to configuring
<code class="highlighter-rouge">direct-lvm</code>.</p>

<p>For production systems, see
<a href="#configure-direct-lvm-mode-for-production">Configure direct-lvm mode for production</a>.</p>

<ol>
  <li>
    <p>Stop Docker.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>systemctl stop docker
</code></pre></div>    </div>
  </li>
  <li>
    <p>Edit <code class="highlighter-rouge">/etc/docker/daemon.json</code>. If it does not yet exist, create it. Assuming
that the file was empty, add the following contents.</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"storage-driver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"devicemapper"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>

    <p>See all storage options for each storage driver in the
<a href="/engine/reference/commandline/dockerd/#options-per-storage-driver">daemon reference documentation</a></p>

    <p>Docker does not start if the <code class="highlighter-rouge">daemon.json</code> file contains badly-formed JSON.</p>
  </li>
  <li>
    <p>Start Docker.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>systemctl start docker
</code></pre></div>    </div>
  </li>
  <li>
    <p>Verify that the daemon is using the <code class="highlighter-rouge">devicemapper</code> storage driver. Use the
<code class="highlighter-rouge">docker info</code> command and look for <code class="highlighter-rouge">Storage Driver</code>.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker info
<span class="go">
  Containers: 0
    Running: 0
    Paused: 0
    Stopped: 0
  Images: 0
  Server Version: 17.03.1-ce
  Storage Driver: devicemapper
  Pool Name: docker-202:1-8413957-pool
  Pool Blocksize: 65.54 kB
  Base Device Size: 10.74 GB
  Backing Filesystem: xfs
  Data file: /dev/loop0
  Metadata file: /dev/loop1
  Data Space Used: 11.8 MB
  Data Space Total: 107.4 GB
  Data Space Available: 7.44 GB
  Metadata Space Used: 581.6 KB
  Metadata Space Total: 2.147 GB
  Metadata Space Available: 2.147 GB
  Thin Pool Minimum Free Space: 10.74 GB
  Udev Sync Supported: true
  Deferred Removal Enabled: false
  Deferred Deletion Enabled: false
  Deferred Deleted Device Count: 0
  Data loop file: /var/lib/docker/devicemapper/data
  Metadata loop file: /var/lib/docker/devicemapper/metadata
  Library Version: 1.02.135-RHEL7 (2016-11-16)
</span><span class="c">&lt;...&gt;
</span></code></pre></div>    </div>
  </li>
</ol>

<p>This host is running in <code class="highlighter-rouge">loop-lvm</code> mode, which is <strong>not</strong> supported on
  production systems. This is indicated by the fact that the <code class="highlighter-rouge">Data loop file</code>
  and a <code class="highlighter-rouge">Metadata loop file</code> are on files under
  <code class="highlighter-rouge">/var/lib/docker/devicemapper</code>. These are loopback-mounted
  sparse files. For production systems, see
  <a href="#configure-direct-lvm-mode-for-production">Configure direct-lvm mode for production</a>.</p>

<h3 id="configure-direct-lvm-mode-for-production">Configure direct-lvm mode for production</h3>

<p>Production hosts using the <code class="highlighter-rouge">devicemapper</code> storage driver must use <code class="highlighter-rouge">direct-lvm</code>
mode. This mode uses block devices to create the thin pool. This is faster than
using loopback devices, uses system resources more efficiently, and block
devices can grow as needed. However, more setup is required than in <code class="highlighter-rouge">loop-lvm</code>
mode.</p>

<p>After you have satisfied the <a href="#prerequisites">prerequisites</a>, follow the steps
below to configure Docker to use the <code class="highlighter-rouge">devicemapper</code> storage driver in
<code class="highlighter-rouge">direct-lvm</code> mode.</p>

<blockquote>
  <p><strong>Warning</strong>: Changing the storage driver makes any containers you have already
  created inaccessible on the local system. Use <code class="highlighter-rouge">docker save</code> to save containers,
  and push existing images to Docker Hub or a private repository, so you do not
  need to recreate them later.</p>
</blockquote>

<h4 id="allow-docker-to-configure-direct-lvm-mode">Allow Docker to configure direct-lvm mode</h4>

<p>Docker can manage the block device for you, simplifying configuration of <code class="highlighter-rouge">direct-lvm</code>
mode. <strong>This is appropriate for fresh Docker setups only.</strong> You can only use a
single block device. If you need to use multiple block devices,
<a href="#configure-direct-lvm-mode-manually">configure direct-lvm mode manually</a> instead.
The following new configuration options are available:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Option</th>
      <th style="text-align: left">Description</th>
      <th style="text-align: left">Required?</th>
      <th style="text-align: left">Default</th>
      <th style="text-align: left">Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">dm.directlvm_device</code></td>
      <td style="text-align: left">The path to the block device to configure for <code class="highlighter-rouge">direct-lvm</code>.</td>
      <td style="text-align: left">Yes</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"><code class="highlighter-rouge">dm.directlvm_device="/dev/xvdf"</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">dm.thinp_percent</code></td>
      <td style="text-align: left">The percentage of space to use for storage from the passed in block device.</td>
      <td style="text-align: left">No</td>
      <td style="text-align: left">95</td>
      <td style="text-align: left"><code class="highlighter-rouge">dm.thinp_percent=95</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">dm.thinp_metapercent</code></td>
      <td style="text-align: left">The percentage of space to use for metadata storage from the passed-in block device.</td>
      <td style="text-align: left">No</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left"><code class="highlighter-rouge">dm.thinp_metapercent=1</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">dm.thinp_autoextend_threshold</code></td>
      <td style="text-align: left">The threshold for when lvm should automatically extend the thin pool as a percentage of the total storage space.</td>
      <td style="text-align: left">No</td>
      <td style="text-align: left">80</td>
      <td style="text-align: left"><code class="highlighter-rouge">dm.thinp_autoextend_threshold=80</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">dm.thinp_autoextend_percent</code></td>
      <td style="text-align: left">The percentage to increase the thin pool by when an autoextend is triggered.</td>
      <td style="text-align: left">No</td>
      <td style="text-align: left">20</td>
      <td style="text-align: left"><code class="highlighter-rouge">dm.thinp_autoextend_percent=20</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">dm.directlvm_device_force</code></td>
      <td style="text-align: left">Whether to format the block device even if a filesystem already exists on it. If set to <code class="highlighter-rouge">false</code> and a filesystem is present, an error is logged and the filesystem is left intact.</td>
      <td style="text-align: left">No</td>
      <td style="text-align: left">false</td>
      <td style="text-align: left"><code class="highlighter-rouge">dm.directlvm_device_force=true</code></td>
    </tr>
  </tbody>
</table>

<p>Edit the <code class="highlighter-rouge">daemon.json</code> file and set the appropriate options, then restart Docker
for the changes to take effect. The following <code class="highlighter-rouge">daemon.json</code> configuration sets all of the
options in the table above.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"storage-driver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"devicemapper"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"storage-opts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"dm.directlvm_device=/dev/xdf"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"dm.thinp_percent=95"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"dm.thinp_metapercent=1"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"dm.thinp_autoextend_threshold=80"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"dm.thinp_autoextend_percent=20"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"dm.directlvm_device_force=false"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>See all storage options for each storage driver in the
<a href="/engine/reference/commandline/dockerd/#options-per-storage-driver">daemon reference documentation</a></p>

<p>Restart Docker for the changes to take effect. Docker invokes the commands to
configure the block device for you.</p>

<blockquote>
  <p><strong>Warning</strong>: Changing these values after Docker has prepared the block device
for you is not supported and causes an error.</p>
</blockquote>

<p>You still need to <a href="#manage-devicemapper">perform periodic maintenance tasks</a>.</p>

<h4 id="configure-direct-lvm-mode-manually">Configure direct-lvm mode manually</h4>

<p>The procedure below creates a logical volume configured as a thin pool to
use as backing for the storage pool. It assumes that you have a spare block
device at <code class="highlighter-rouge">/dev/xvdf</code> with enough free space to complete the task. The device
identifier and volume sizes may be different in your environment and you
should substitute your own values throughout the procedure. The procedure also
assumes that the Docker daemon is in the <code class="highlighter-rouge">stopped</code> state.</p>

<ol>
  <li>
    <p>Identify the block device you want to use. The device is located under
<code class="highlighter-rouge">/dev/</code> (such as <code class="highlighter-rouge">/dev/xvdf</code>) and needs enough free space to store the
images and container layers for the workloads that host runs.
A solid state drive is ideal.</p>
  </li>
  <li>
    <p>Stop Docker.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>systemctl stop docker
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install the following packages:</p>

    <ul>
      <li>
        <p><strong>RHEL / CentOS</strong>: <code class="highlighter-rouge">device-mapper-persistent-data</code>, <code class="highlighter-rouge">lvm2</code>, and all
dependencies</p>
      </li>
      <li>
        <p><strong>Ubuntu / Debian / SLES 15</strong>: <code class="highlighter-rouge">thin-provisioning-tools</code>, <code class="highlighter-rouge">lvm2</code>, and all
dependencies</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Create a physical volume on your block device from step 1, using the
<code class="highlighter-rouge">pvcreate</code> command. Substitute your device name for <code class="highlighter-rouge">/dev/xvdf</code>.</p>

    <blockquote>
      <p><strong>Warning</strong>: The next few steps are destructive, so be sure that you have
specified the correct device!</p>
    </blockquote>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>pvcreate /dev/xvdf
<span class="go">
Physical volume "/dev/xvdf" successfully created.
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Create a <code class="highlighter-rouge">docker</code> volume group on the same device, using the <code class="highlighter-rouge">vgcreate</code>
command.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>vgcreate docker /dev/xvdf
<span class="go">
Volume group "docker" successfully created
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Create two logical volumes named <code class="highlighter-rouge">thinpool</code> and <code class="highlighter-rouge">thinpoolmeta</code> using the
<code class="highlighter-rouge">lvcreate</code> command. The last parameter specifies the amount of free space
to allow for automatic expanding of the data or metadata if space runs low,
as a temporary stop-gap. These are the recommended values.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>lvcreate <span class="nt">--wipesignatures</span> y <span class="nt">-n</span> thinpool docker <span class="nt">-l</span> 95%VG
<span class="go">
Logical volume "thinpool" created.

</span><span class="gp">$</span> <span class="nb">sudo </span>lvcreate <span class="nt">--wipesignatures</span> y <span class="nt">-n</span> thinpoolmeta docker <span class="nt">-l</span> 1%VG
<span class="go">
Logical volume "thinpoolmeta" created.
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Convert the volumes to a thin pool and a storage location for metadata for
the thin pool, using the <code class="highlighter-rouge">lvconvert</code> command.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>lvconvert <span class="nt">-y</span> <span class="se">\</span>
<span class="nt">--zero</span> n <span class="se">\</span>
<span class="nt">-c</span> 512K <span class="se">\</span>
<span class="nt">--thinpool</span> docker/thinpool <span class="se">\</span>
<span class="nt">--poolmetadata</span> docker/thinpoolmeta
<span class="go">
WARNING: Converting logical volume docker/thinpool and docker/thinpoolmeta to
thin pool's data and metadata volumes with metadata wiping.
THIS WILL DESTROY CONTENT OF LOGICAL VOLUME (filesystem etc.)
Converted docker/thinpool to thin pool.
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Configure autoextension of thin pools via an <code class="highlighter-rouge">lvm</code> profile.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>vi /etc/lvm/profile/docker-thinpool.profile
</code></pre></div>    </div>
  </li>
  <li>
    <p>Specify <code class="highlighter-rouge">thin_pool_autoextend_threshold</code> and <code class="highlighter-rouge">thin_pool_autoextend_percent</code>
values.</p>

    <p><code class="highlighter-rouge">thin_pool_autoextend_threshold</code> is the percentage of space used before <code class="highlighter-rouge">lvm</code>
attempts to autoextend the available space (100 = disabled, not recommended).</p>

    <p><code class="highlighter-rouge">thin_pool_autoextend_percent</code> is the amount of space to add to the device
when automatically extending (0 = disabled).</p>

    <p>The example below adds 20% more capacity when the disk usage reaches
80%.</p>

    <pre><code class="language-none">activation {
  thin_pool_autoextend_threshold=80
  thin_pool_autoextend_percent=20
}
</code></pre>

    <p>Save the file.</p>
  </li>
  <li>
    <p>Apply the LVM profile, using the <code class="highlighter-rouge">lvchange</code> command.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>lvchange <span class="nt">--metadataprofile</span> docker-thinpool docker/thinpool
<span class="go">
Logical volume docker/thinpool changed.
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Ensure monitoring of the logical volume is enabled.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>lvs <span class="nt">-o</span>+seg_monitor
<span class="go">
LV       VG     Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert Monitor
thinpool docker twi-a-t--- 95.00g             0.00   0.01                             not monitored
</span></code></pre></div>    </div>

    <p>If the output in the <code class="highlighter-rouge">Monitor</code> column reports, as above, that the volume is
<code class="highlighter-rouge">not monitored</code>, then monitoring needs to be explicitly enabled. Without
this step, automatic extension of the logical volume will not occur,
regardless of any settings in the applied profile.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>lvchange <span class="nt">--monitor</span> y docker/thinpool
</code></pre></div>    </div>

    <p>Double check that monitoring is now enabled by running the
<code class="highlighter-rouge">sudo lvs -o+seg_monitor</code> command a second time. The <code class="highlighter-rouge">Monitor</code> column
should now report the logical volume is being <code class="highlighter-rouge">monitored</code>.</p>
  </li>
  <li>
    <p>If you have ever run Docker on this host before, or if <code class="highlighter-rouge">/var/lib/docker/</code>
exists, move it out of the way so that Docker can use the new LVM pool to
store the contents of image and containers.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>su -
<span class="gp">#</span> mkdir /var/lib/docker.bk
<span class="gp">#</span> mv /var/lib/docker/<span class="k">*</span> /var/lib/docker.bk
<span class="gp">#</span> <span class="nb">exit</span>
</code></pre></div>    </div>

    <p>If any of the following steps fail and you need to restore, you can remove
<code class="highlighter-rouge">/var/lib/docker</code> and replace it with <code class="highlighter-rouge">/var/lib/docker.bk</code>.</p>
  </li>
  <li>
    <p>Edit <code class="highlighter-rouge">/etc/docker/daemon.json</code> and configure the options needed for the
<code class="highlighter-rouge">devicemapper</code> storage driver. If the file was previously empty, it should
now contain the following contents:</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"storage-driver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"devicemapper"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"storage-opts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"dm.thinpooldev=/dev/mapper/docker-thinpool"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"dm.use_deferred_removal=true"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"dm.use_deferred_deletion=true"</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Start Docker.</p>

    <p><strong>systemd</strong>:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>systemctl start docker
</code></pre></div>    </div>

    <p><strong>service</strong>:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>service docker start
</code></pre></div>    </div>
  </li>
  <li>
    <p>Verify that Docker is using the new configuration using <code class="highlighter-rouge">docker info</code>.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker info
<span class="go">
Containers: 0
 Running: 0
 Paused: 0
 Stopped: 0
Images: 0
Server Version: 17.03.1-ce
Storage Driver: devicemapper
 Pool Name: docker-thinpool
 Pool Blocksize: 524.3 kB
 Base Device Size: 10.74 GB
 Backing Filesystem: xfs
 Data file:
 Metadata file:
 Data Space Used: 19.92 MB
 Data Space Total: 102 GB
 Data Space Available: 102 GB
 Metadata Space Used: 147.5 kB
 Metadata Space Total: 1.07 GB
 Metadata Space Available: 1.069 GB
 Thin Pool Minimum Free Space: 10.2 GB
 Udev Sync Supported: true
 Deferred Removal Enabled: true
 Deferred Deletion Enabled: true
 Deferred Deleted Device Count: 0
 Library Version: 1.02.135-RHEL7 (2016-11-16)
</span><span class="c">&lt;...&gt;
</span></code></pre></div>    </div>

    <p>If Docker is configured correctly, the <code class="highlighter-rouge">Data file</code> and <code class="highlighter-rouge">Metadata file</code> is
blank, and the pool name is <code class="highlighter-rouge">docker-thinpool</code>.</p>
  </li>
  <li>
    <p>After you have verified that the configuration is correct, you can remove the
<code class="highlighter-rouge">/var/lib/docker.bk</code> directory which contains the previous configuration.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>rm <span class="nt">-rf</span> /var/lib/docker.bk
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="manage-devicemapper">Manage devicemapper</h2>

<h3 id="monitor-the-thin-pool">Monitor the thin pool</h3>

<p>Do not rely on LVM auto-extension alone. The volume group
automatically extends, but the volume can still fill up. You can monitor
free space on the volume using <code class="highlighter-rouge">lvs</code> or <code class="highlighter-rouge">lvs -a</code>. Consider using a monitoring
tool at the OS level, such as Nagios.</p>

<p>To view the LVM logs, you can use <code class="highlighter-rouge">journalctl</code>:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>journalctl <span class="nt">-fu</span> dm-event.service
</code></pre></div></div>

<p>If you run into repeated problems with thin pool, you can set the storage option
<code class="highlighter-rouge">dm.min_free_space</code> to a value (representing a percentage) in
<code class="highlighter-rouge">/etc/docker/daemon.json</code>. For instance, setting it to <code class="highlighter-rouge">10</code> ensures
that operations fail with a warning when the free space is at or near 10%.
See the
<a href="/engine/reference/commandline/dockerd/#daemon-storage-driver" target="_blank" rel="noopener" class="_">storage driver options in the Engine daemon reference</a>.</p>

<h3 id="increase-capacity-on-a-running-device">Increase capacity on a running device</h3>

<p>You can increase the capacity of the pool on a running thin-pool device. This is
useful if the data’s logical volume is full and the volume group is at full
capacity. The specific procedure depends on whether you are using a
<a href="#resize-a-loop-lvm-thin-pool">loop-lvm thin pool</a> or a
<a href="#resize-a-direct-lvm-thin-pool">direct-lvm thin pool</a>.</p>

<h4 id="resize-a-loop-lvm-thin-pool">Resize a loop-lvm thin pool</h4>

<p>The easiest way to resize a <code class="highlighter-rouge">loop-lvm</code> thin pool is to
<a href="#use-the-device_tool-utility">use the device_tool utility</a>,
but you can <a href="#use-operating-system-utilities">use operating system utilities</a>
instead.</p>

<h5 id="use-the-device_tool-utility">Use the device_tool utility</h5>

<p>A community-contributed script called <code class="highlighter-rouge">device_tool.go</code> is available in the
<a href="https://github.com/moby/moby/tree/master/contrib/docker-device-tool">moby/moby</a>
Github repository. You can use this tool to resize a <code class="highlighter-rouge">loop-lvm</code> thin pool,
avoiding the long process above. This tool is not guaranteed to work, but you
should only be using <code class="highlighter-rouge">loop-lvm</code> on non-production systems.</p>

<p>If you do not want to use <code class="highlighter-rouge">device_tool</code>, you can <a href="#use-operating-system-utilities">resize the thin pool manually</a> instead.</p>

<ol>
  <li>
    <p>To use the tool, clone the Github repository, change to the
<code class="highlighter-rouge">contrib/docker-device-tool</code>, and follow the instructions in the <code class="highlighter-rouge">README.md</code>
to compile the tool.</p>
  </li>
  <li>
    <p>Use the tool. The following example resizes the thin pool to 200GB.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> ./device_tool resize 200GB
</code></pre></div>    </div>
  </li>
</ol>

<h5 id="use-operating-system-utilities">Use operating system utilities</h5>

<p>If you do not want to <a href="#use-the-device_tool-utility">use the device-tool utility</a>,
you can resize a <code class="highlighter-rouge">loop-lvm</code> thin pool manually using the following procedure.</p>

<p>In <code class="highlighter-rouge">loop-lvm</code> mode, a loopback device is used to store the data, and another
to store the metadata. <code class="highlighter-rouge">loop-lvm</code> mode is only supported for testing, because
it has significant performance and stability drawbacks.</p>

<p>If you are using <code class="highlighter-rouge">loop-lvm</code> mode, the output of <code class="highlighter-rouge">docker info</code> shows file
paths for <code class="highlighter-rouge">Data loop file</code> and <code class="highlighter-rouge">Metadata loop file</code>:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker info |grep <span class="s1">'loop file'</span>
<span class="go">
 Data loop file: /var/lib/docker/devicemapper/data
 Metadata loop file: /var/lib/docker/devicemapper/metadata
</span></code></pre></div></div>

<p>Follow these steps to increase the size of the thin pool. In this example, the
thin pool is 100 GB, and is increased to 200 GB.</p>

<ol>
  <li>
    <p>List the sizes of the devices.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo ls</span> <span class="nt">-lh</span> /var/lib/docker/devicemapper/
<span class="go">
total 1175492
-rw------- 1 root root 100G Mar 30 05:22 data
-rw------- 1 root root 2.0G Mar 31 11:17 metadata
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Increase the size of the <code class="highlighter-rouge">data</code> file to 200 G using the <code class="highlighter-rouge">truncate</code> command,
which is used to increase <strong>or</strong> decrease the size of a file. Note that
decreasing the size is a destructive operation.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>truncate <span class="nt">-s</span> 200G /var/lib/docker/devicemapper/data
</code></pre></div>    </div>
  </li>
  <li>
    <p>Verify the file size changed.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo ls</span> <span class="nt">-lh</span> /var/lib/docker/devicemapper/
<span class="go">
total 1.2G
-rw------- 1 root root 200G Apr 14 08:47 data
-rw------- 1 root root 2.0G Apr 19 13:27 metadata
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>The loopback file has changed on disk but not in memory. List the size of
the loopback device in memory, in GB. Reload it, then list the size again.
After the reload, the size is 200 GB.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">echo</span> <span class="nv">$[</span> <span class="k">$(</span><span class="nb">sudo </span>blockdev <span class="nt">--getsize64</span> /dev/loop0<span class="k">)</span> / 1024 / 1024 / 1024 <span class="o">]</span>
<span class="go">
100

</span><span class="gp">$</span> <span class="nb">sudo </span>losetup <span class="nt">-c</span> /dev/loop0
<span class="go">
</span><span class="gp">$</span> <span class="nb">echo</span> <span class="nv">$[</span> <span class="k">$(</span><span class="nb">sudo </span>blockdev <span class="nt">--getsize64</span> /dev/loop0<span class="k">)</span> / 1024 / 1024 / 1024 <span class="o">]</span>
<span class="go">
200
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Reload the devicemapper thin pool.</p>

    <p>a.  Get the pool name first. The pool name is the first field, delimited by
    ` :`. This command extracts it.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ sudo dmsetup status | grep ' thin-pool ' | awk -F ': ' {'print $1'}

    docker-8:1-123141-pool
</code></pre></div>    </div>

    <p>b.  Dump the device mapper table for the thin pool.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ sudo dmsetup table docker-8:1-123141-pool

    0 209715200 thin-pool 7:1 7:0 128 32768 1 skip_block_zeroing
</code></pre></div>    </div>

    <p>c.  Calculate the total sectors of the thin pool using the second field
    of the output. The number is expressed in 512-k sectors. A 100G file has
    209715200 512-k sectors. If you double this number to 200G, you get
    419430400 512-k sectors.</p>

    <p>d.  Reload the thin pool with the new sector number, using the following
    three <code class="highlighter-rouge">dmsetup</code>  commands.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ sudo dmsetup suspend docker-8:1-123141-pool

    $ sudo dmsetup reload docker-8:1-123141-pool --table '0 419430400 thin-pool 7:1 7:0 128 32768 1 skip_block_zeroing'

    $ sudo dmsetup resume docker-8:1-123141-pool
</code></pre></div>    </div>
  </li>
</ol>

<h4 id="resize-a-direct-lvm-thin-pool">Resize a direct-lvm thin pool</h4>

<p>To extend a <code class="highlighter-rouge">direct-lvm</code> thin pool, you need to first attach a new block device
to the Docker host, and make note of the name assigned to it by the kernel. In
this example, the new block device is <code class="highlighter-rouge">/dev/xvdg</code>.</p>

<p>Follow this procedure to extend a <code class="highlighter-rouge">direct-lvm</code> thin pool, substituting your
block device and other parameters to suit your situation.</p>

<ol>
  <li>
    <p>Gather information about your volume group.</p>

    <p>Use the <code class="highlighter-rouge">pvdisplay</code> command to find the physical block devices currently in
use by your thin pool, and the volume group’s name.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>pvdisplay |grep <span class="s1">'VG Name'</span>
<span class="go">
PV Name               /dev/xvdf
VG Name               docker
</span></code></pre></div>    </div>

    <p>In the following steps, substitute your block device or volume group name as
appropriate.</p>
  </li>
  <li>
    <p>Extend the volume group, using the <code class="highlighter-rouge">vgextend</code> command with the <code class="highlighter-rouge">VG Name</code>
from the previous step, and the name of your <strong>new</strong> block device.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>vgextend docker /dev/xvdg
<span class="go">
Physical volume "/dev/xvdg" successfully created.
Volume group "docker" successfully extended
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Extend the <code class="highlighter-rouge">docker/thinpool</code> logical volume. This command uses 100% of the
volume right away, without auto-extend. To extend the metadata thinpool
instead, use <code class="highlighter-rouge">docker/thinpool_tmeta</code>.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>lvextend <span class="nt">-l</span>+100%FREE <span class="nt">-n</span> docker/thinpool
<span class="go">
Size of logical volume docker/thinpool_tdata changed from 95.00 GiB (24319 extents) to 198.00 GiB (50688 extents).
Logical volume docker/thinpool_tdata successfully resized.
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Verify the new thin pool size using the <code class="highlighter-rouge">Data Space Available</code> field in the
output of <code class="highlighter-rouge">docker info</code>. If you extended the <code class="highlighter-rouge">docker/thinpool_tmeta</code> logical
volume instead, look for <code class="highlighter-rouge">Metadata Space Available</code>.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Storage Driver: devicemapper
 Pool Name: docker-thinpool
 Pool Blocksize: 524.3 kB
 Base Device Size: 10.74 GB
 Backing Filesystem: xfs
 Data file:
 Metadata file:
 Data Space Used: 212.3 MB
 Data Space Total: 212.6 GB
 Data Space Available: 212.4 GB
 Metadata Space Used: 286.7 kB
 Metadata Space Total: 1.07 GB
 Metadata Space Available: 1.069 GB
&lt;...&gt;
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="activate-the-devicemapper-after-reboot">Activate the <code class="highlighter-rouge">devicemapper</code> after reboot</h3>

<p>If you reboot the host and find that the <code class="highlighter-rouge">docker</code> service failed to start,
look for the error, “Non existing device”. You need to re-activate the
logical volumes with this command:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>lvchange <span class="nt">-ay</span> docker/thinpool
</code></pre></div></div>

<h2 id="how-the-devicemapper-storage-driver-works">How the <code class="highlighter-rouge">devicemapper</code> storage driver works</h2>

<blockquote>
  <p><strong>Warning</strong>: Do not directly manipulate any files or directories within
<code class="highlighter-rouge">/var/lib/docker/</code>. These files and directories are managed by Docker.</p>
</blockquote>

<p>Use the <code class="highlighter-rouge">lsblk</code> command to see the devices and their pools, from the operating
system’s point of view:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>lsblk
<span class="go">
NAME                    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
xvda                    202:0    0    8G  0 disk
└─xvda1                 202:1    0    8G  0 part /
xvdf                    202:80   0  100G  0 disk
├─docker-thinpool_tmeta 253:0    0 1020M  0 lvm
│ └─docker-thinpool     253:2    0   95G  0 lvm
└─docker-thinpool_tdata 253:1    0   95G  0 lvm
  └─docker-thinpool     253:2    0   95G  0 lvm
</span></code></pre></div></div>

<p>Use the <code class="highlighter-rouge">mount</code> command to see the mount-point Docker is using:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> mount |grep devicemapper
<span class="go">/dev/xvda1 on /var/lib/docker/devicemapper type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
</span></code></pre></div></div>

<p>When you use <code class="highlighter-rouge">devicemapper</code>, Docker stores image and layer contents in the
thinpool, and exposes them to containers by mounting them under
subdirectories of <code class="highlighter-rouge">/var/lib/docker/devicemapper/</code>.</p>

<h3 id="image-and-container-layers-on-disk">Image and container layers on-disk</h3>

<p>The <code class="highlighter-rouge">/var/lib/docker/devicemapper/metadata/</code> directory contains metadata about
the Devicemapper configuration itself and about each image and container layer
that exist. The <code class="highlighter-rouge">devicemapper</code> storage driver uses snapshots, and this metadata
include information about those snapshots. These files are in JSON format.</p>

<p>The <code class="highlighter-rouge">/var/lib/docker/devicemapper/mnt/</code> directory contains a mount point for each image
and container layer that exists. Image layer mount points are empty, but a
container’s mount point shows the container’s filesystem as it appears from
within the container.</p>

<h3 id="image-layering-and-sharing">Image layering and sharing</h3>

<p>The <code class="highlighter-rouge">devicemapper</code> storage driver uses dedicated block devices rather than
formatted filesystems, and operates on files at the block level for maximum
performance during copy-on-write (CoW) operations.</p>

<h4 id="snapshots">Snapshots</h4>

<p>Another feature of <code class="highlighter-rouge">devicemapper</code> is its use of snapshots (also sometimes called
<em>thin devices</em> or <em>virtual devices</em>), which store the differences introduced in
each layer as very small, lightweight thin pools. Snapshots provide many
benefits:</p>

<ul>
  <li>
    <p>Layers which are shared in common between containers are only stored on disk
once, unless they are writable. For instance, if you have 10 different
images which are all based on <code class="highlighter-rouge">alpine</code>, the <code class="highlighter-rouge">alpine</code> image and all its
parent images are only stored once each on disk.</p>
  </li>
  <li>
    <p>Snapshots are an implementation of a copy-on-write (CoW) strategy. This means
that a given file or directory is only copied to the container’s writable
layer when it is modified or deleted by that container.</p>
  </li>
  <li>
    <p>Because <code class="highlighter-rouge">devicemapper</code> operates at the block level, multiple blocks in a
writable layer can be modified simultaneously.</p>
  </li>
  <li>
    <p>Snapshots can be backed up using standard OS-level backup utilities. Just
make a copy of <code class="highlighter-rouge">/var/lib/docker/devicemapper/</code>.</p>
  </li>
</ul>

<h4 id="devicemapper-workflow">Devicemapper workflow</h4>

<p>When you start Docker with the <code class="highlighter-rouge">devicemapper</code> storage driver, all objects
related to image and container layers are stored in
<code class="highlighter-rouge">/var/lib/docker/devicemapper/</code>, which is backed by one or more block-level
devices, either loopback devices (testing only) or physical disks.</p>

<ul>
  <li>
    <p>The <em>base device</em> is the lowest-level object. This is the thin pool itself.
You can examine it using <code class="highlighter-rouge">docker info</code>. It contains a filesystem. This base
device is the starting point for every image and container layer. The base
device is a Device Mapper implementation detail, rather than a Docker layer.</p>
  </li>
  <li>
    <p>Metadata about the base device and each image or container layer is stored in
<code class="highlighter-rouge">/var/lib/docker/devicemapper/metadata/</code> in JSON format. These layers are
copy-on-write snapshots, which means that they are empty until they diverge
from their parent layers.</p>
  </li>
  <li>
    <p>Each container’s writable layer is mounted on a mountpoint in
<code class="highlighter-rouge">/var/lib/docker/devicemapper/mnt/</code>. An empty directory exists for each
read-only image layer and each stopped container.</p>
  </li>
</ul>

<p>Each image layer is a snapshot of the layer below it. The lowest layer of each
image is a snapshot of the base device that exists in the pool. When you run a
container, it is a snapshot of the image the container is based on. The following
example shows a Docker host with two running containers. The first is a <code class="highlighter-rouge">ubuntu</code>
container and the second is a <code class="highlighter-rouge">busybox</code> container.</p>

<p><img src="/docs.docker.jp.onthefly/storage/storagedriver/images/two_dm_container.jpg" alt="ubuntu and busybox image layers" /></p>

<h2 id="how-container-reads-and-writes-work-with-devicemapper">How container reads and writes work with <code class="highlighter-rouge">devicemapper</code></h2>

<h3 id="reading-files">Reading files</h3>

<p>With <code class="highlighter-rouge">devicemapper</code>, reads happen at the block level. The diagram below shows
the high level process for reading a single block (<code class="highlighter-rouge">0x44f</code>) in an example
container.</p>

<p><img src="/docs.docker.jp.onthefly/storage/storagedriver/images/dm_container.jpg" alt="reading a block with devicemapper" /></p>

<p>An application makes a read request for block <code class="highlighter-rouge">0x44f</code> in the container. Because
the container is a thin snapshot of an image, it doesn’t have the block, but it
has a pointer to the block on the nearest parent image where it does exist, and
it reads the block from there. The block now exists in the container’s memory.</p>

<h3 id="writing-files">Writing files</h3>

<p><strong>Writing a new file</strong>: With the <code class="highlighter-rouge">devicemapper</code> driver, writing new data to a
container is accomplished by an <em>allocate-on-demand</em> operation. Each block of
the new file is allocated in the container’s writable layer and the block is
written there.</p>

<p><strong>Updating an existing file</strong>: The relevant block of the file is read from the
nearest layer where it exists. When the container writes the file, only the
modified blocks are written to the container’s writable layer.</p>

<p><strong>Deleting a file or directory</strong>: When you delete a file or directory in a
container’s writable layer, or when an image layer deletes a file that exists
in its parent layer, the <code class="highlighter-rouge">devicemapper</code> storage driver intercepts further read
attempts on that file or directory and responds that the file or directory does
not exist.</p>

<p><strong>Writing and then deleting a file</strong>: If a container writes to a file and later
deletes the file, all of those operations happen in the container’s writable
layer. In that case, if you are using <code class="highlighter-rouge">direct-lvm</code>, the blocks are freed. If you
use <code class="highlighter-rouge">loop-lvm</code>, the blocks may not be freed. This is another reason not to use
<code class="highlighter-rouge">loop-lvm</code> in production.</p>

<h2 id="device-mapper-and-docker-performance">Device Mapper and Docker performance</h2>

<ul>
  <li>
    <p><strong><code class="highlighter-rouge">allocate-on demand</code> performance impact</strong>:</p>

    <p>The <code class="highlighter-rouge">devicemapper</code> storage driver uses an <code class="highlighter-rouge">allocate-on-demand</code> operation to
allocate new blocks from the thin pool into a container’s writable layer.
Each block is 64KB, so this is the minimum amount of space that is used
for a write.</p>
  </li>
  <li>
    <p><strong>Copy-on-write performance impact</strong>: The first time a container modifies a
specific block, that block is written to the container’s writable layer.
Because these writes happen at the level of the block rather than the file,
performance impact is minimized. However, writing a large number of blocks can
still negatively impact performance, and the <code class="highlighter-rouge">devicemapper</code> storage driver may
actually perform worse than other storage drivers in this scenario. For
write-heavy workloads, you should use data volumes, which bypass the storage
driver completely.</p>
  </li>
</ul>

<h3 id="performance-best-practices">Performance best practices</h3>

<p>Keep these things in mind to maximize performance when using the <code class="highlighter-rouge">devicemapper</code>
storage driver.</p>

<ul>
  <li>
    <p><strong>Use <code class="highlighter-rouge">direct-lvm</code></strong>: The <code class="highlighter-rouge">loop-lvm</code> mode is not performant and should never
be used in production.</p>
  </li>
  <li>
    <p><strong>Use fast storage</strong>:  Solid-state drives (SSDs) provide faster reads and
writes than spinning disks.</p>
  </li>
  <li>
    <p><strong>Memory usage</strong>: the <code class="highlighter-rouge">devicemapper</code> uses more memory than some other storage
drivers. Each launched container loads one or more copies of its files into
memory, depending on how many blocks of the same file are being modified at
the same time. Due to the memory pressure, the <code class="highlighter-rouge">devicemapper</code> storage driver
may not be the right choice for certain workloads in high-density use cases.</p>
  </li>
  <li>
    <p><strong>Use volumes for write-heavy workloads</strong>: Volumes provide the best and most
predictable performance for write-heavy workloads. This is because they bypass
the storage driver and do not incur any of the potential overheads introduced
by thin provisioning and copy-on-write. Volumes have other benefits, such as
allowing you to share data among containers and persisting even when no
running container is using them.</p>
  </li>
  <li>
    <p><strong>Note</strong>: when using <code class="highlighter-rouge">devicemapper</code> and the <code class="highlighter-rouge">json-file</code> log driver, the log
files generated by a container are still stored in Docker’s dataroot directory,
by default <code class="highlighter-rouge">/var/lib/docker</code>.  If your containers generate lots of log messages,
this may lead to increased disk usage or the inability to manage your system due
to a full disk.  You can configure a
<a href="/docs.docker.jp.onthefly/config/containers/logging/configure/">log driver</a> to store your container
logs externally.</p>
  </li>
</ul>

<h2 id="related-information">Related Information</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/storage/volumes/">Volumes</a></li>
  <li><a href="/docs.docker.jp.onthefly/storage/storagedriver/">Understand images, containers, and storage drivers</a></li>
  <li><a href="/docs.docker.jp.onthefly/storage/storagedriver/select-storage-driver/">Select a storage driver</a></li>
</ul>
<span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span style="vertical-align: 2px"><a href="/docs.docker.jp.onthefly/search/?q=container">container</a>, <a href="/docs.docker.jp.onthefly/search/?q=storage">storage</a>, <a href="/docs.docker.jp.onthefly/search/?q=driver">driver</a>, <a href="/docs.docker.jp.onthefly/search/?q=device mapper">device mapper</a></span><div class="ratings-div"><div id="pd_rating_holder_8453675"></div></div></section>
                    </main>
                    <nav class="col-nav">
                        <div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
                            <div id="navbar" class="nav-sidebar">
                                <ul class="nav hidden-md hidden-lg"></ul>
                                <ul class="nav" id="jsTOCLeftNav"></ul>
                            </div>
                        </div>
                    </nav>
                    <div class="col-toc">
                        <div class="sidebar hidden-xs hidden-sm">
                            <div class="toc-nav">
                                <div class="feedback-links">
                                    <ul><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/edit/master/src/storage/storagedriver/device-mapper-driver.ch"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 本ページの編集</a></li><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/issues/new?body=File: [storage/storagedriver/device-mapper-driver.ch](https://matsuand.github.io/docs.docker.jp.onthefly/storage/storagedriver/device-mapper-driver/)" class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 変更リクエスト</a></li>
                                        <li><div class="toggle-mode">
  <div class="icon">
      <i class="fa fa-sun-o" aria-hidden="true"></i>
  </div>
  <div class="toggle-switch">
      <label class="switch">
          <input type="checkbox" id="switch-style">
          <span class="slider round"></span>
      </label>
  </div>
  <div class="icon">
      <i class="fa fa-moon-o" aria-hidden="true"></i>
  </div>
</div>
</li>
                                    </ul>
                                </div><div id="side-toc-title">本ページ内:</div>
<ul id="my_toc" class="inline_toc">
  <li><a href="#prerequisites" class="nomunge">Prerequisites</a></li>
  <li><a href="#configure-docker-with-the-devicemapper-storage-driver" class="nomunge">Configure Docker with the devicemapper storage driver</a>
    <ul>
      <li><a href="#configure-loop-lvm-mode-for-testing" class="nomunge">Configure loop-lvm mode for testing</a></li>
      <li><a href="#configure-direct-lvm-mode-for-production" class="nomunge">Configure direct-lvm mode for production</a></li>
    </ul>
  </li>
  <li><a href="#manage-devicemapper" class="nomunge">Manage devicemapper</a>
    <ul>
      <li><a href="#monitor-the-thin-pool" class="nomunge">Monitor the thin pool</a></li>
      <li><a href="#increase-capacity-on-a-running-device" class="nomunge">Increase capacity on a running device</a></li>
      <li><a href="#activate-the-devicemapper-after-reboot" class="nomunge">Activate the devicemapper after reboot</a></li>
    </ul>
  </li>
  <li><a href="#how-the-devicemapper-storage-driver-works" class="nomunge">How the devicemapper storage driver works</a>
    <ul>
      <li><a href="#image-and-container-layers-on-disk" class="nomunge">Image and container layers on-disk</a></li>
      <li><a href="#image-layering-and-sharing" class="nomunge">Image layering and sharing</a></li>
    </ul>
  </li>
  <li><a href="#how-container-reads-and-writes-work-with-devicemapper" class="nomunge">How container reads and writes work with devicemapper</a>
    <ul>
      <li><a href="#reading-files" class="nomunge">Reading files</a></li>
      <li><a href="#writing-files" class="nomunge">Writing files</a></li>
    </ul>
  </li>
  <li><a href="#device-mapper-and-docker-performance" class="nomunge">Device Mapper and Docker performance</a>
    <ul>
      <li><a href="#performance-best-practices" class="nomunge">Performance best practices</a></li>
    </ul>
  </li>
  <li><a href="#related-information" class="nomunge">Related Information</a></li>
</ul>

</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">
          
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products" target="_blank" rel="noopener">製品ラインアップ</a></b></li>
                        <li><a href="https://www.docker.com/products/personal" target="_blank" rel="noopener">Docker Personal</a></li>
                        <li><a href="https://www.docker.com/products/pro" target="_blank" rel="noopener">Docker Pro</a></li>
                        <li><a href="https://www.docker.com/products/team" target="_blank" rel="noopener">Docker Team</a></li>
                        <li><a href="https://www.docker.com/products/business" target="_blank" rel="noopener">Docker Business</a></li>
                        <li><a href="https://www.docker.com/products" target="_blank" rel="noopener">サブスクリプション比較</a></li>
                        <li><b><a href="https://www.docker.com/" target="_blank" rel="noopener">機能</a></b></li>
                        <li><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">Docker Desktop</a></li>
                        <li><a href="https://www.docker.com/products/docker-hub" target="_blank" rel="noopener">Docker Hub</a></li>
                        <li><a href="https://www.docker.com/products/secure-software-supply-chain" target="_blank" rel="noopener">セキュアなソフトウェアサプライチェーン</a></li>
                        <li><a href="https://www.docker.com/products/container-runtime" target="_blank" rel="noopener">コンテナーランタイム</a></li>
                        <li><a href="https://www.docker.com/products/developer-tools" target="_blank" rel="noopener">開発ツール</a></li>
                        <li><a href="https://www.docker.com/partners" target="_blank" rel="noopener">信頼できるコンテント</a></li>
                        <li><a href="https://www.docker.com/roadmap" target="_blank" rel="noopener">Docker 製品ロードマップ</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">開発者</a></b></li>
                        <li><a href="https://www.docker.com/use-cases" target="_blank" rel="noopener">利用例</a></li>
                        <li><a href="https://docs.docker.com/get-started/" target="_blank" rel="noopener">はじめよう</a></li>
                        <li><a href="https://www.docker.com/blog/" target="_blank" rel="noopener">ブログ</a></li>
                        <li><a href="https://www.docker.com/docker-community" target="_blank" rel="noopener">コミュニティー</a></li>
                        <li><a href="https://www.docker.com/open-source" target="_blank" rel="noopener">オープンソース</a></li>
                        <li><a href="https://www.docker.com/community/get-involved/developer-preview" target="_blank" rel="noopener">プレビュープログラム</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">価格体系</a></b></li>
                        <li><a href="https://www.docker.com/pricing/faq" target="_blank" rel="noopener">FAQ</a></li>
                        <li><a href="https://www.docker.com/partners/programs" target="_blank" rel="noopener">Docker 認定公開者向けプログラム</a></li>
                        <li><a href="https://www.docker.com/partners" target="_blank" rel="noopener">パートナー</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/company" target="_blank" rel="noopener">会社概要</a></b></li>
                        <li><a href="https://www.docker.com/what-container" target="_blank" rel="noopener">コンテナーって何？</a></li>
                        <li><a href="https://www.docker.com/why-docker" target="_blank" rel="noopener">なぜ Docker？</a></li>
                        <li><a href="https://www.docker.com/events" target="_blank" rel="noopener">仮想イベント</a></li>
                        <li><a href="https://www.docker.com/swag" target="_blank" rel="noopener">Swag ストア
                        </a></li>
                        <li><a href="https://www.docker.com/company/newsroom" target="_blank" rel="noopener">ニュースルーム</a></li>
                        <li><a href="https://www.docker.com/careers" target="_blank" rel="noopener">採用情報</a></li>
                        <li><a href="https://www.docker.com/company/contact" target="_blank" rel="noopener">連絡先</a></li>
                        <li><a href="https://www.docker.com/customers" target="_blank" rel="noopener">顧客</a></li>
                        <li><a href="https://www.docker.com/newsletter-subscription" target="_blank" rel="noopener">ニュースレター</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="https://www.docker.com/legal/docker-terms-service" target="_blank" rel="noopener">サービス契約</a></li>
                        <li><a href="https://status.docker.com/" target="_blank" rel="noopener">ステータス</a></li>
                        <li><a href="https://www.docker.com/legal" target="_blank" rel="noopener">法的情報</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2013-2021 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="https://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="https://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-slideshare"><a href="https://www.slideshare.net/docker">Slideshare</a></li>
                    <li class="fa fa-reddit"><a href="https://www.reddit.com/r/docker">Reddit</a></li>
                </ul>
            </div>
        </div>
    </div>

    </footer>
    <script>const pageURL = "/storage/storagedriver/device-mapper-driver/";</script></body>
</html>
