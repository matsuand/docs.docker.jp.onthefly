<!DOCTYPE html>
<!-- Page generated 2022-04-25 09:39:05 +0900-->
<html lang="ja"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>オーバーレイネットワークの利用 | Docker ドキュメント</title>
  <meta name="description" content="All about using overlay networks" />
  <meta name="keywords" content="network, overlay, user-defined, swarm, service">
  <link rel="canonical" href="https://localhost:4000{{ site.baseurl }}/network/overlay/" />

  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <link rel="apple-touch-icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta name="msapplication-TileImage" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico">
  <meta property="og:image" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
  <meta name="theme-color" content="#2496ed" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- hide elements that are only shown without JavaScript enabled -->
  <script>document.documentElement.classList.add('js')</script>
  <style>html.js .no-js { display: none !important; }</style><script defer src="/docs.docker.jp.onthefly/js/theme-switcher.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/anchorlinks.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/jquery.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/docs.js"></script><script defer src="/docs.docker.jp.onthefly/js/search.js"></script><link rel="preload" as="font" href="https://fonts.gstatic.com/s/opensans/v18/mem8YaGs126MiZpBA-UFVZ0bf8pkAg.woff2" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/geomanist/hinted-Geomanist-Book.woff2"    type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/geomanist/hinted-Geomanist-Regular.woff2" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/glyphicons-halflings-regular.woff2"       type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/fontawesome-webfont.woff2?v=4.7.0"        type="font/woff2" crossorigin="anonymous">

  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/font-awesome.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/bootstrap.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/style.css" id="pagestyle">

  <!-- SEO stuff -->
  <meta name="twitter:title" itemprop="title name" content="オーバーレイネットワークの利用"/>
  <meta name="twitter:description" property="og:description" itemprop="description" content="" />
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:domain" content="matsuand.github.io"/>
  <meta name="twitter:site" content="@docker_docs"/>
  <meta name="twitter:url" content="https://twitter.com/docker_docs"/>
  <meta name="twitter:image:src" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:image:alt" content="Docker ドキュメント"/>
  <meta property="og:title" content="オーバーレイネットワークの利用" />
  <meta property="og:description" content="All about using overlay networks" />
  <meta property="og:type" content="website"/>
  <meta property="og:updated_time" itemprop="dateUpdated" content="2022-04-25T09:39:05+09:00"/>
  <meta property="og:image" itemprop="image primaryImageOfPage" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta property="og:locale" content="ja_JP" />
  <meta property="og:url" content="https://matsuand.github.io/docs.docker.jp.onthefly/network/overlay/" />
  <meta property="og:site_name" content="Docker ドキュメント" />
  <meta property="article:published_time" itemprop="datePublished" content="2022-04-25T09:39:05+09:00"/>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebPage","headline":"オーバーレイネットワークの利用","description":"All about using overlay networks","url":"https://docs.docker.com/network/overlay/"}</script>
  <!-- END SEO STUFF -->
</head>
<body class="colums">
    <header>
        <nav class="nav-secondary navbar navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="/docs.docker.jp.onthefly/">
                <img class="logo" src="/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs" width="160" height="28" />
            </a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="logo-mobile">
    <a href="/docs.docker.jp.onthefly/">
        <img src="/docs.docker.jp.onthefly/images/docker-icon.svg" alt="Docker Docs" title="Docker Docs" width="30" height="30" />
    </a>
</div>
<div class="search-form" id="search-div">
    <form class="search-form form-inline" id="searchForm" action="/docs.docker.jp.onthefly/search/" method="get">
        <label for="st-search-input" class="sr-only">検索</label>
        <input class="search-field form-control ds-input" id="st-search-input" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteResults"></div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container hidden-sm hidden-xs">
    <div>
        <ul class="nav navbar-nav"><li><a href="/docs.docker.jp.onthefly/" id="home">ホーム</a></li><li><a href="/docs.docker.jp.onthefly/get-started/overview/" id="guides">ガイド</a></li><li><a href="/docs.docker.jp.onthefly/desktop/" id="manuals">マニュアル</a></li><li><a href="/docs.docker.jp.onthefly/reference/" id="reference">リファレンス</a></li><li><a href="/docs.docker.jp.onthefly/samples/" id="samples">サンプル</a></li></ul>
    </div>
    <div class="ctrl-right">
        <a href="javascript:void(0)" id="menu-toggle" aria-label="現在ページのメニュートグル"><i class="fa fa-indent" aria-hidden="true"></i></a>
    </div>
</div>
<div class="row hidden-sm hidden-xs">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li><a href="/docs.docker.jp.onthefly/" title="Docker docs homepage"><i class="fa fa-home"></i></a></li>
            <li><a href="/docs.docker.jp.onthefly/get-started/overview/">ガイド</a></li><li><a>本番環境でのアプリ運用</a></li><li><a href="/docs.docker.jp.onthefly/network/">ネットワーク設定</a></li><li><a href="/docs.docker.jp.onthefly/network/overlay/">オーバーレイネットワークの利用</a></li></ol>
    </nav>
</div></div>
    </div>
</nav>

    </header>
    <div class="wrapper right-open">
        <div class="container-fluid">
            <div class="row">
                <div class="col-body">
                    <main class="col-content content">
                        <section class="section"><h1>オーバーレイネットワークの利用</h1><p><em class="reading-time">読む時間の目安: 4 分</em></p><p><code class="highlighter-rouge">overlay</code>ネットワークドライバーは、複数の Docker デーモンホスト間での分散ネットワークを生成します。
このネットワークは、ホストに固有のものとして構築されたネットワークの最上位に位置（overlay）するものです。
このネットワークに対しては、コンテナー（Swarm サービスコンテナーを含む）が接続可能です。
暗号化が有効になっていれば、安全な通信を行うことができます。
Docker は、各パケットの送受信経路を透過的に取り扱い、その送受信先となる Docker ホストデーモンやコンテナーを適切に認識します。</p>

<p>Swarm の初期化を行うとき、あるいは Docker ホストを既存の Swarm に参加させるときには、そのホスト上に 2 つのネットワークが生成されます。</p>

<ul>
  <li>1 つは<code class="highlighter-rouge">ingress</code>と呼ばれるオーバーレイネットワークです。
これは Swarm サービスに関する制御とデータトラフィックを取り扱います。
Swarm サービスを生成する際に、ユーザー定義のオーバーレイネットワークへの接続を指定しない限り、デフォルトでは<code class="highlighter-rouge">ingress</code>ネットワークに接続されます。</li>
  <li>もう 1 つは<code class="highlighter-rouge">docker_gwbridge</code>と呼ばれるブリッジネットワークです。
これは、個々の Docker デーモンを、Swarm 内に参加している別のデーモンに接続するものです。</li>
</ul>

<p>ユーザー定義の<code class="highlighter-rouge">overlay</code>ネットワークは<code class="highlighter-rouge">docker network create</code>を使って生成することができます。
ユーザー定義の<code class="highlighter-rouge">bridge</code>ネットワークを生成する方法と同じです。
サービスやコンテナーは、一度に複数のネットワークに接続できます。
サービスやコンテナーがネットワーク通信を行うことができるのは、互いに接続されている場合だけです。</p>

<p>Swarm サービスとスタンドアロンコンテナーは、どちらもオーバーレイネットワークに接続することができます。
ただしデフォルトの動作や設定が目指しているものは、まったく異なります。
そこで、これ以降のトピックでは操作説明を以下のように分けます。
オーバーレイネットワークに対する全般的な操作、Swarm サービスネットワークに対する操作、スタンドアロンコンテナーにおいて利用されるオーバーレイネットワークに対する操作です。</p>

<h2 id="operations-for-all-overlay-networks">オーバーレイネットワークに対する全般的な操作</h2>

<h3 id="create-an-overlay-network">オーバーレイネットワークの生成</h3>

<blockquote>
  <p><strong>前提条件</strong></p>

  <ul>
    <li>
      <p>オーバーレイネットワークを使った Docker デーモン用のファイアーウォールルール</p>

      <p>オーバーレイネットワーク上に参加する Docker ホスト間でのトラフィックのやりとりのため、以下のポートを公開する必要があります。</p>

      <ul>
        <li>TCP ポート 2377、クラスター管理に関する通信用。</li>
        <li>TCP と UDP のポート 7946、ノード間の通信用。</li>
        <li>UDP ポート 4789、オーバーレイネットワークトラフィック用。</li>
      </ul>
    </li>
    <li>
      <p>オーバーレイネットワークを生成する前には、<code class="highlighter-rouge">docker swarm init</code>を使って Docker デーモンを Swarm マネージャーとして初期化するか、あるいは<code class="highlighter-rouge">docker swarm join</code>を使って既存の Swarm にホストを追加しておく必要があります。
どちらの場合でも、デフォルトの<code class="highlighter-rouge">ingress</code>オーバーレイネットワークが生成されます。
このネットワークは、デフォルトで Swarm サービスが利用するものです。
Swarm サービスを利用するつもりがなくても、これを行っておくことが必要です。
この後には、ユーザー定義のオーバーレイネットワークを追加生成することができます。</p>
    </li>
  </ul>
</blockquote>

<p>Swarm サービスに対して利用するオーバーレイネットワークを生成するには、以下のようなコマンドを実行します。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker network create <span class="nt">-d</span> overlay my-overlay
</code></pre></div></div>

<p>オーバーレイネットワークを生成する目的が、Swarm サービスにおいて利用するだけでなく、スタンドアロンコンテナー <strong>においても</strong> 利用することが必要な場合で、他の Docker デーモン上で動作する他のスタンドアロンコンテナーとも通信を行う必要がある場合は、<code class="highlighter-rouge">--attachable</code>フラグを加えます。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker network create <span class="nt">-d</span> overlay <span class="nt">--attachable</span> my-attachable-overlay
</code></pre></div></div>

<p>IP アドレス範囲、サブネット、ゲートウェイ、その他のオプションを指定することができます。
詳しくは<code class="highlighter-rouge">docker network create --help</code>を確認してください。</p>

<h3 id="encrypt-traffic-on-an-overlay-network">オーバーレイネットワーク上のトラフィック暗号化</h3>

<p>Swarm サービスの管理トラフィックは、デフォルトにおいて、GCM モードの <a href="https://en.wikipedia.org/wiki/Galois/Counter_Mode">AES アルゴリズム</a> を使ってすべて暗号化されます。
Swarm 内のマネージャーノードは、ゴシップデータ（gossip data）の暗号化に利用する鍵を 12 時間ごとにローテートして利用します。</p>

<p>アプリケーションデータを暗号化するには、オーバーレイネットワークの生成時に<code class="highlighter-rouge">--opt encrypted</code>を指定します。
これにより vxlan レベルの IPSEC 暗号化が実現します。
この暗号化を利用すると、性能劣化が無視できない程度に発生します。
したがって本番環境での利用を行うには、あらかじめ十分にテストを行っておく必要があります。</p>

<p>オーバーレイにおいて暗号化を有効にすると、Docker はノード間のすべてに IPSEC トンネルを生成して、
オーバーレイネットワークにアタッチされたサービスに応じて、タスクをスケジューリングします。
このトンネルは GCM モードでの AES アルゴリズムを利用するので、マネージャーノードは 12 時間ごとに鍵のローテートを自動的に行います。</p>

<blockquote class="warning">
  <p><strong>Windows ノードは暗号化されたオーバーレイネットワークにアタッチしないでください。</strong></p>

  <p>オーバーレイネットワークの暗号化は Windows 上においてはサポートされていません。
暗号化されたオーバーレイネットワークに Windows ノードを接続しようとすると、エラーは発生しませんが、ただしそのノードは通信することができません。</p>
</blockquote>

<h4 id="swarm-mode-overlay-networks-and-standalone-containers">Swarm モードのオーバーレイネットワークとスタンドアロンコンテナー</h4>

<p>オーバーレイネットワーク機能を利用する際に<code class="highlighter-rouge">--opt encrypted --attachable</code>を同時に指定すれば、このネットワークに対して、管理外にあったコンテナーをアタッチさせることができます。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker network create <span class="nt">--opt</span> encrypted <span class="nt">--driver</span> overlay <span class="nt">--attachable</span> my-attachable-multi-host-network
</code></pre></div></div>

<h3 id="customize-the-default-ingress-network">デフォルトの ingress ネットワークのカスタマイズ</h3>

<p>ほとんどのユーザーにとって<code class="highlighter-rouge">ingress</code>ネットワークをカスタマイズする必要はありません。
ただし設定を変更することは可能です。
たとえば自動的に設定されるサブネットが、ネットワーク上にすでにあるものとコンフリクトした場合には、設定が必要になります。
また MTU のような低レベルのネットワーク設定を行う場合にも必要です。</p>

<p><code class="highlighter-rouge">ingress</code>ネットワークをカスタマイズするには、いったん削除して再生成することが必要です。
通常は Swarm 上にサービスを生成する前に、これを行います。
ポートを公開しているサービスがある場合は、<code class="highlighter-rouge">ingress</code>ネットワークを削除する前に、そのサービスを削除しておく必要があります。</p>

<p><code class="highlighter-rouge">ingress</code>ネットワークが存在していない間、ポートを公開していないサービスであれば機能しますが、ただし負荷分散は行われません。
この状況は、WordPress サービスのようにポート 80 を公開しているサービスに影響を及ぼします。</p>

<ol>
  <li>
    <p><code class="highlighter-rouge">docker network inspect ingress</code>を実行して<code class="highlighter-rouge">ingress</code>ネットワークを調べます。
そして、これに接続しているコンテナーのサービスをすべて削除します。
このサービスとは WordPress サービスにように、ポートを公開しているものです。
こういったサービスを停止し忘れていると、次の作業が失敗します。</p>
  </li>
  <li>
    <p>既存の<code class="highlighter-rouge">ingress</code>ネットワークを削除します。</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker network rm ingress
<span class="go">
WARNING! Before removing the routing-mesh network, make sure all the nodes
in your swarm run the same docker engine version. Otherwise, removal may not
be effective and functionality of newly created ingress networks will be
impaired.
Are you sure you want to continue? [y/N]
</span></code></pre></div>    </div>
  </li>
  <li>
    <p><code class="highlighter-rouge">--ingress</code>フラグを使って、新たなオーバーレイネットワークを生成します。
カスタマイズしたいオプションがあれば設定しておきます。
以下の例では MTU を 1200、サブネットを<code class="highlighter-rouge">10.11.0.0/16</code>、ゲートウェイを <code class="highlighter-rouge">10.11.0.2</code>にそれぞれ指定しています。</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker network create <span class="se">\</span>
  <span class="nt">--driver</span> overlay <span class="se">\</span>
  <span class="nt">--ingress</span> <span class="se">\</span>
  <span class="nt">--subnet</span><span class="o">=</span>10.11.0.0/16 <span class="se">\</span>
  <span class="nt">--gateway</span><span class="o">=</span>10.11.0.2 <span class="se">\</span>
  <span class="nt">--opt</span> com.docker.network.driver.mtu<span class="o">=</span>1200 <span class="se">\</span>
  my-ingress
</code></pre></div>    </div>

    <blockquote>
      <p><strong>メモ</strong></p>

      <p>生成する<code class="highlighter-rouge">ingress</code>ネットワークの名前は<code class="highlighter-rouge">ingress</code>以外にすることも可能です。
ただし生成できるのは 1 つだけであり、2 つめを生成しようとしても失敗します。</p>
    </blockquote>
  </li>
  <li>
    <p>1 つめの手順で停止させていたサービスを再起動します。</p>
  </li>
</ol>

<h3 id="customize-the-docker_gwbridge-interface">docker_gwbridge インターフェースのカスタマイズ</h3>

<p><code class="highlighter-rouge">docker_gwbridge</code>は仮想ブリッジであり、（<code class="highlighter-rouge">ingress</code>ネットワークを含む）オーバーレイネットワークを、個々の Docker デーモンにおいて稼動する物理ネットワークに接続します。
Docker では、Swarm を初期化するとき、あるいは Docker ホストを Swarm に参加させるときに、この仮想ブリッジを自動生成します。
ただしこれは Docker のデバイスではありません。
Docker ホストのカーネル内に存在するものです。
これに対する設定が必要な場合は、Docker ホストを Swarm に参加させる前、あるいはホストを一時的に Swarm から削除してから設定を行う必要があります。</p>

<ol>
  <li>
    <p>Docker を停止します。</p>
  </li>
  <li>
    <p>既存の<code class="highlighter-rouge">docker_gwbridge</code>インターフェースを削除します。</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>ip link <span class="nb">set </span>docker_gwbridge down
<span class="go">
</span><span class="gp">$</span> <span class="nb">sudo </span>ip link del dev docker_gwbridge
</code></pre></div>    </div>
  </li>
  <li>
    <p>Docker を起動します。
Swarm への参加、あるいは初期化は行いません。</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">docker_gwbridge</code>ブリッジへのカスタマイズを行った上で、これを手動で再生成します。
これは<code class="highlighter-rouge">docker network create</code>コマンドを使って行います。
以下の例では、サブネットを<code class="highlighter-rouge">10.11.0.0/16</code>に指定しています。
カスタマイズ可能なオプションについては、<a href="/docs.docker.jp.onthefly/engine/reference/commandline/network_create/#bridge-driver-options">ブリッジドライバーのオプション</a> を参照してください。</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker network create <span class="se">\</span>
<span class="nt">--subnet</span> 10.11.0.0/16 <span class="se">\</span>
<span class="nt">--opt</span> com.docker.network.bridge.name<span class="o">=</span>docker_gwbridge <span class="se">\</span>
<span class="nt">--opt</span> com.docker.network.bridge.enable_icc<span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nt">--opt</span> com.docker.network.bridge.enable_ip_masquerade<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
docker_gwbridge
</code></pre></div>    </div>
  </li>
  <li>
    <p>Swarm の初期化、あるいは Swarm への参加を行います。
ブリッジが存在するので、Docker は自動設定にもとづくブリッジの生成は行いません。</p>
  </li>
</ol>

<h2 id="operations-for-swarm-services">Swarm サービスに対する操作</h2>

<h3 id="publish-ports-on-an-overlay-network">オーバーレイネットワーク上でのポート公開</h3>

<p>同一のオーバーレイネットワークに接続された Swarm サービスは、全ポートを互いに公開します。
外部のサービスからアクセス可能な 1 つのポートがあるなら、そのポートは<code class="highlighter-rouge">docker service create</code>や<code class="highlighter-rouge">docker service update</code>を実行するときの<code class="highlighter-rouge">-p</code>または<code class="highlighter-rouge">--publish</code>フラグを使って、<strong>公開に</strong> しておかなければなりません。
指定の際には、かつてのコロン区切りの文法と、最新のカンマ区切りによる文法がともにサポートされます。
わかりやすくするために、長い文法を用いることが好まれています。</p>

<table>
<thead>
<tr>
<th>フラグ値</th>
<th>内容説明</th>
</tr>
</thead>
<tr>
<td><tt>-p 8080:80</tt> または<br /><tt>-p published=8080,target=80</tt></td>
<td>サービス上の TCP ポート 80 をルーティングメッシュ上のポート 8080 にマッピングします。</td>
</tr>
<tr>
<td><tt>-p 8080:80/udp</tt> または<br /><tt>-p published=8080,target=80,protocol=udp</tt></td>
<td>サービス上の UDP ポート 80 をルーティングメッシュ上のポート 8080 にマッピングします。</td>
</tr>
<tr>
<td><tt>-p 8080:80/tcp -p 8080:80/udp</tt> または<br /><tt>-p published=8080,target=80,protocol=tcp -p published=8080,target=80,protocol=udp</tt></td>
<td>サービス上の TCP ポート 80 をルーティングメッシュ上のポート 8080 にマッピングします。
またサービス上の UDP ポート 80 をルーティングメッシュ上のポート 8080 にマッピングします。</td>
</tr>
</table>

<h3 id="bypass-the-routing-mesh-for-a-swarm-service">Swarm サービスにおけるルーティングメッシュの停止</h3>

<p>ポートを公開している Swarm サービスは、デフォルトでルーティングメッシュ（routing mesh）を利用します。
Swarm ノードのいずれかの公開ポートに接続すると（指定のサービスが動作しているかどうかには関係なく）、そのサービスが動作しているワーカーノードにリダイレクトされます。
Swarm サービスに対して、Docker が効率よくロードバランサーのように動作します。
ルーティングメッシュを利用するサービスは、<strong>仮想 IP モード</strong>（virtual IP mode）として稼動します。
各ノード上に稼動する別サービスであっても（<code class="highlighter-rouge">--mode global</code>フラグにより）ルーティングメッシュを利用します。
ルーティングメッシュを利用した場合、クライアントが要求するノードサービスがどれになるかは保証されません。</p>

<p>ルーティングメッシュを停止するには、サービスを <strong>DNS ラウンドロビン</strong>（DNS Round Robin; DNSRR）モードで起動します。
これは <code class="highlighter-rouge">--endpoint-mode</code>に<code class="highlighter-rouge">dnsrr</code>を設定することで実現します。
サービスに対しては独自にロードバランサーを稼動させる必要があります。
Docker ホスト上のサービス名に対する DNS 問い合わせは、サービスを実行しているノードの IP アドレス一覧を返します。
ロードバランサーがこの一覧を解釈し、ノード間のトラフィックを調整するように設定を行ってください。</p>

<h3 id="separate-control-and-data-traffic">制御情報とデータのトラフィック分離</h3>

<p>Swarm の管理に関連する制御情報のトラフィックと、アプリケーションの動作において発生するトラフィックは、同じネットワーク上でやりとりされます。
なお Swarm の制御情報トラフィックは暗号化されています。
Docker では、この異なる種類のトラフィックを、別々のネットワークインターフェースに分けて取り扱う設定が可能です。
Swarm の初期化時あるいは Swarm への参加時に<code class="highlighter-rouge">--advertise-addr</code>、<code class="highlighter-rouge">--datapath-addr</code>をそれぞれ指定します。
Swarm に参加させるノードに対しては、必ずこれを行わなければなりません。</p>

<h2 id="operations-for-standalone-containers-on-overlay-networks">オーバーレイネットワーク上のスタンドアロンコンテナーに対する操作</h2>

<h3 id="attach-a-standalone-container-to-an-overlay-network">オーバーレイネットワークへのスタンドアロンコンテナーのアタッチ</h3>

<p><code class="highlighter-rouge">ingress</code>ネットワークを<code class="highlighter-rouge">--attachable</code>フラグの指定をせずに生成すると、Swarm サービスだけがこれを利用できるようになり、スタンドアロンコンテナーは利用できません。
スタンドアロンコンテナーの場合は、ユーザー定義のオーバーレイネットワークを<code class="highlighter-rouge">--attachable</code>フラグにより生成すれば、接続ができます。
このようにすれば、スタンドアロンコンテナーを、さまざまな Docker デーモン上に起動させることが可能であり、
個別のデーモンホスト上にルーティングを設定することなく、通信が行えるようになります。</p>

<h3 id="publish-ports">公開ポート</h3>

<table>
  <thead>
    <tr>
      <th>フラグ値</th>
      <th>内容説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">-p 8080:80</code></td>
      <td>コンテナー上の TCP ポート 80 をオーバーレイネットワーク上のポート 8080 にマッピングします。</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">-p 8080:80/udp</code></td>
      <td>コンテナー上の UDP ポート 80 をオーバーレイネットワーク上のポート 8080 にマッピングします。</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">-p 8080:80/sctp</code></td>
      <td>コンテナー上の SCTP ポート 80 をオーバーレイネットワーク上のポート 8080 にマッピングします。</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">-p 8080:80/tcp -p 8080:80/udp</code></td>
      <td>コンテナー上の TCP ポート 80 をオーバーレイネットワーク上のポート 8080 にマッピングします。またコンテナー上の UDP ポート 80 をオーバーレイネットワーク上のポート 8080 にマッピングします。</td>
    </tr>
  </tbody>
</table>

<h3 id="container-discovery">コンテナーの検出</h3>

<p>接続先を指定するには、たいていの場合サービス名を用います。
サービスが負荷分散されていたり、サービスのもとにあるコンテナー（「タスク」）のすべてによって取り扱われていたりするからです。
サービスのもとにあるタスク全一覧を取得するには、<code class="highlighter-rouge">tasks.&lt;サービス名&gt;</code>に対して DNS 問い合わせを行ってください。</p>

<h2 id="next-steps">次のステップ</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/network/network-tutorial-overlay/">オーバーレイネットワークのチュートリアル</a> をひととおり読んでください。</li>
  <li><a href="/docs.docker.jp.onthefly/config/containers/container-networking/">コンテナーから見たネットワーク</a> について。</li>
  <li><a href="/docs.docker.jp.onthefly/network/bridge/">スタンドアロンブリッジネットワーク</a> について。</li>
  <li><a href="/docs.docker.jp.onthefly/network/macvlan/">Macvlan ネットワーク</a> について。</li>
</ul>
<span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span style="vertical-align: 2px"><a href="/docs.docker.jp.onthefly/search/?q=network">network</a>, <a href="/docs.docker.jp.onthefly/search/?q=overlay">overlay</a>, <a href="/docs.docker.jp.onthefly/search/?q=user-defined">user-defined</a>, <a href="/docs.docker.jp.onthefly/search/?q=swarm">swarm</a>, <a href="/docs.docker.jp.onthefly/search/?q=service">service</a></span><div class="ratings-div"><div id="pd_rating_holder_8453675"></div></div></section>
                    </main>
                    <nav class="col-nav">
                        <div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
                            <div id="navbar" class="nav-sidebar">
                                <ul class="nav hidden-md hidden-lg"></ul>
                                <ul class="nav" id="jsTOCLeftNav"></ul>
                            </div>
                        </div>
                    </nav>
                    <div class="col-toc">
                        <div class="sidebar hidden-xs hidden-sm">
                            <div class="toc-nav">
                                <div class="feedback-links">
                                    <ul><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/edit/master/src/network/overlay.ch"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 本ページの編集</a></li><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/issues/new?body=File: [network/overlay.ch](https://matsuand.github.io/docs.docker.jp.onthefly/network/overlay/)" class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 変更リクエスト</a></li>
                                        <li><div class="toggle-mode">
  <div class="icon">
      <i class="fa fa-sun-o" aria-hidden="true"></i>
  </div>
  <div class="toggle-switch">
      <label class="switch">
          <input type="checkbox" id="switch-style">
          <span class="slider round"></span>
      </label>
  </div>
  <div class="icon">
      <i class="fa fa-moon-o" aria-hidden="true"></i>
  </div>
</div>
</li>
                                    </ul>
                                </div><div id="side-toc-title">本ページ内:</div>
<ul id="my_toc" class="inline_toc">
  <li><a href="#operations-for-all-overlay-networks" class="nomunge">オーバーレイネットワークに対する全般的な操作</a>
    <ul>
      <li><a href="#create-an-overlay-network" class="nomunge">オーバーレイネットワークの生成</a></li>
      <li><a href="#encrypt-traffic-on-an-overlay-network" class="nomunge">オーバーレイネットワーク上のトラフィック暗号化</a></li>
      <li><a href="#customize-the-default-ingress-network" class="nomunge">デフォルトの ingress ネットワークのカスタマイズ</a></li>
      <li><a href="#customize-the-docker_gwbridge-interface" class="nomunge">docker_gwbridge インターフェースのカスタマイズ</a></li>
    </ul>
  </li>
  <li><a href="#operations-for-swarm-services" class="nomunge">Swarm サービスに対する操作</a>
    <ul>
      <li><a href="#publish-ports-on-an-overlay-network" class="nomunge">オーバーレイネットワーク上でのポート公開</a></li>
      <li><a href="#bypass-the-routing-mesh-for-a-swarm-service" class="nomunge">Swarm サービスにおけるルーティングメッシュの停止</a></li>
      <li><a href="#separate-control-and-data-traffic" class="nomunge">制御情報とデータのトラフィック分離</a></li>
    </ul>
  </li>
  <li><a href="#operations-for-standalone-containers-on-overlay-networks" class="nomunge">オーバーレイネットワーク上のスタンドアロンコンテナーに対する操作</a>
    <ul>
      <li><a href="#attach-a-standalone-container-to-an-overlay-network" class="nomunge">オーバーレイネットワークへのスタンドアロンコンテナーのアタッチ</a></li>
      <li><a href="#publish-ports" class="nomunge">公開ポート</a></li>
      <li><a href="#container-discovery" class="nomunge">コンテナーの検出</a></li>
    </ul>
  </li>
  <li><a href="#next-steps" class="nomunge">次のステップ</a></li>
</ul>

</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">
          
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products" target="_blank" rel="noopener">製品ラインアップ</a></b></li>
                        <li><a href="https://www.docker.com/products/personal" target="_blank" rel="noopener">Docker Personal</a></li>
                        <li><a href="https://www.docker.com/products/pro" target="_blank" rel="noopener">Docker Pro</a></li>
                        <li><a href="https://www.docker.com/products/team" target="_blank" rel="noopener">Docker Team</a></li>
                        <li><a href="https://www.docker.com/products/business" target="_blank" rel="noopener">Docker Business</a></li>
                        <li><a href="https://www.docker.com/products" target="_blank" rel="noopener">サブスクリプション比較</a></li>
                        <li><b><a href="https://www.docker.com/" target="_blank" rel="noopener">機能</a></b></li>
                        <li><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">Docker Desktop</a></li>
                        <li><a href="https://www.docker.com/products/docker-hub" target="_blank" rel="noopener">Docker Hub</a></li>
                        <li><a href="https://www.docker.com/products/secure-software-supply-chain" target="_blank" rel="noopener">セキュアなソフトウェアサプライチェーン</a></li>
                        <li><a href="https://www.docker.com/products/container-runtime" target="_blank" rel="noopener">コンテナーランタイム</a></li>
                        <li><a href="https://www.docker.com/products/developer-tools" target="_blank" rel="noopener">開発ツール</a></li>
                        <li><a href="https://www.docker.com/partners" target="_blank" rel="noopener">信頼できるコンテント</a></li>
                        <li><a href="https://www.docker.com/roadmap" target="_blank" rel="noopener">Docker 製品ロードマップ</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">開発者</a></b></li>
                        <li><a href="https://www.docker.com/use-cases" target="_blank" rel="noopener">利用例</a></li>
                        <li><a href="https://docs.docker.com/get-started/" target="_blank" rel="noopener">はじめよう</a></li>
                        <li><a href="https://www.docker.com/blog/" target="_blank" rel="noopener">ブログ</a></li>
                        <li><a href="https://www.docker.com/docker-community" target="_blank" rel="noopener">コミュニティー</a></li>
                        <li><a href="https://www.docker.com/open-source" target="_blank" rel="noopener">オープンソース</a></li>
                        <li><a href="https://www.docker.com/community/get-involved/developer-preview" target="_blank" rel="noopener">プレビュープログラム</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">価格体系</a></b></li>
                        <li><a href="https://www.docker.com/pricing/faq" target="_blank" rel="noopener">FAQ</a></li>
                        <li><a href="https://www.docker.com/partners/programs" target="_blank" rel="noopener">Docker 認定公開者向けプログラム</a></li>
                        <li><a href="https://www.docker.com/partners" target="_blank" rel="noopener">パートナー</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/company" target="_blank" rel="noopener">会社概要</a></b></li>
                        <li><a href="https://www.docker.com/what-container" target="_blank" rel="noopener">コンテナーって何？</a></li>
                        <li><a href="https://www.docker.com/why-docker" target="_blank" rel="noopener">なぜ Docker？</a></li>
                        <li><a href="https://www.docker.com/events" target="_blank" rel="noopener">仮想イベント</a></li>
                        <li><a href="https://www.docker.com/swag" target="_blank" rel="noopener">Swag ストア
                        </a></li>
                        <li><a href="https://www.docker.com/company/newsroom" target="_blank" rel="noopener">ニュースルーム</a></li>
                        <li><a href="https://www.docker.com/careers" target="_blank" rel="noopener">採用情報</a></li>
                        <li><a href="https://www.docker.com/company/contact" target="_blank" rel="noopener">連絡先</a></li>
                        <li><a href="https://www.docker.com/customers" target="_blank" rel="noopener">顧客</a></li>
                        <li><a href="https://www.docker.com/newsletter-subscription" target="_blank" rel="noopener">ニュースレター</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="https://www.docker.com/legal/docker-terms-service" target="_blank" rel="noopener">サービス契約</a></li>
                        <li><a href="https://status.docker.com/" target="_blank" rel="noopener">ステータス</a></li>
                        <li><a href="https://www.docker.com/legal" target="_blank" rel="noopener">法的情報</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2013-2021 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="https://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="https://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-slideshare"><a href="https://www.slideshare.net/docker">Slideshare</a></li>
                    <li class="fa fa-reddit"><a href="https://www.reddit.com/r/docker">Reddit</a></li>
                </ul>
            </div>
        </div>
    </div>

    </footer>
    <script>const pageURL = "/network/overlay/";</script></body>
</html>
