<!-- Page generated 2021-10-14 19:29:01 +0900-->
<!DOCTYPE html>
<html lang="ja"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>自動ビルドの設定 | Docker ドキュメント</title>
  <meta name="description" content="自動ビルドを設定します。" />
  <meta name="keywords" content="automated, build, images, Docker Hub">
  <link rel="canonical" href="https://localhost:4000{{ site.baseurl }}/docker-hub/builds/" />

  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <link rel="apple-touch-icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta name="msapplication-TileImage" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico">
  <meta property="og:image" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
  <meta name="theme-color" content="#2496ed" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- hide elements that are only shown without JavaScript enabled -->
  <script>document.documentElement.classList.add('js')</script>
  <style>html.js .no-js { display: none !important; }</style><script defer src="/docs.docker.jp.onthefly/js/theme-switcher.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/anchorlinks.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/jquery.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/docs.js"></script><script defer src="/docs.docker.jp.onthefly/js/search.js"></script><link rel="preload" as="font" href="https://fonts.gstatic.com/s/opensans/v18/mem8YaGs126MiZpBA-UFVZ0bf8pkAg.woff2" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/geomanist/hinted-Geomanist-Book.woff2"    type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/geomanist/hinted-Geomanist-Regular.woff2" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/glyphicons-halflings-regular.woff2"       type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/fontawesome-webfont.woff2?v=4.7.0"        type="font/woff2" crossorigin="anonymous">

  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/font-awesome.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/bootstrap.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/style.css" id="pagestyle">

  <!-- SEO stuff -->
  <meta name="twitter:title" itemprop="title name" content="自動ビルドの設定"/>
  <meta name="twitter:description" property="og:description" itemprop="description" content="" />
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:domain" content="matsuand.github.io"/>
  <meta name="twitter:site" content="@docker_docs"/>
  <meta name="twitter:url" content="https://twitter.com/docker_docs"/>
  <meta name="twitter:image:src" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:image:alt" content="Docker ドキュメント"/>
  <meta property="og:title" content="自動ビルドの設定" />
  <meta property="og:description" content="自動ビルドを設定します。" />
  <meta property="og:type" content="website"/>
  <meta property="og:updated_time" itemprop="dateUpdated" content="2021-10-14T19:29:01+09:00"/>
  <meta property="og:image" itemprop="image primaryImageOfPage" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta property="og:locale" content="ja_JP" />
  <meta property="og:url" content="https://matsuand.github.io/docs.docker.jp.onthefly/docker-hub/builds/" />
  <meta property="og:site_name" content="Docker ドキュメント" />
  <meta property="article:published_time" itemprop="datePublished" content="2021-10-14T19:29:01+09:00"/>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebPage","headline":"自動ビルドの設定","description":"自動ビルドを設定します。","url":"https://docs.docker.com/docker-hub/builds/"}</script>
  <!-- END SEO STUFF -->
</head>
<body class="colums">
    <header>
        <nav class="nav-secondary navbar navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="/docs.docker.jp.onthefly/">
                <img class="logo" src="/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs" width="160" height="28" />
            </a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="logo-mobile">
    <a href="/docs.docker.jp.onthefly/">
        <img src="/docs.docker.jp.onthefly/images/docker-icon.svg" alt="Docker Docs" title="Docker Docs" width="30" height="30" />
    </a>
</div>
<div class="search-form" id="search-div">
    <form class="search-form form-inline" id="searchForm" action="/docs.docker.jp.onthefly/search/" method="get">
        <label for="st-search-input" class="sr-only">検索</label>
        <input class="search-field form-control ds-input" id="st-search-input" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteResults"></div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container hidden-sm hidden-xs">
    <div>
        <ul class="nav navbar-nav"><li><a href="/docs.docker.jp.onthefly/" id="home">ホーム</a></li><li><a href="/docs.docker.jp.onthefly/get-started/overview/" id="guides">ガイド</a></li><li><a href="/docs.docker.jp.onthefly/desktop/" id="manuals">マニュアル</a></li><li><a href="/docs.docker.jp.onthefly/reference/" id="reference">リファレンス</a></li><li><a href="/docs.docker.jp.onthefly/samples/" id="samples">サンプル</a></li></ul>
    </div>
    <div class="ctrl-right">
        <a href="javascript:void(0)" id="menu-toggle" aria-label="現在ページのメニュートグル"><i class="fa fa-indent" aria-hidden="true"></i></a>
    </div>
</div>
<div class="row hidden-sm hidden-xs">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li><a href="/docs.docker.jp.onthefly/" title="Docker docs homepage"><i class="fa fa-home"></i></a></li>
            <li><a href="/docs.docker.jp.onthefly/desktop/">マニュアル</a></li><li><a href="/docs.docker.jp.onthefly/docker-hub/">Docker Hub</a></li><li><a href="/docs.docker.jp.onthefly/docker-hub/builds/">自動ビルド</a></li><li><a href="/docs.docker.jp.onthefly/docker-hub/builds/">自動ビルドの設定</a></li></ol>
    </nav>
</div></div>
    </div>
</nav>

    </header>
    <div class="wrapper right-open">
        <div class="container-fluid">
            <div class="row">
                <div class="col-body">
                    <main class="col-content content">
                        <section class="section"><h1>自動ビルドの設定</h1><p><em class="reading-time">読む時間の目安: 4 分</em></p><div class="docker-upgrade-cta" role="alert">
  <div class="docker-upgrade-cta__heading">
この機能を利用するには、有償の Docker サブスクリプションが必要です。
  </div>
  <p>自動ビルド機能は Pro、Team、Business ユーザーが利用可能です。既存のプランをアップデートして、最新のイメージビルドおよびプッシュの自動化を始めてください。</p>
 <a class="btn btn-primary" role="button" href="https://www.docker.com/pricing?utm_source=docker&amp;utm_medium=webreferral&amp;utm_campaign=docs_driven_upgrade_auto_builds" target="_blank"> 今すぐアップデート </a>
</div>

<h2 id="how-automated-builds-work">自動ビルドはどのように動くか</h2>

<p>Docker Hub においては、外部リポジトリ内のソースコードから自動的にイメージをビルドして、出来上がったイメージをリポジトリに自動プッシュすることができます。</p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>自動ビルド機能をオープンソースプロジェクトに利用している場合は、私たちの <a href="https://www.docker.com/community/open-source/application" target="_blank" rel="noopener" class="_">オープンソースコミュニティ</a> プログラムに参加していただき、Docker Hub 上にて Docker がどのようにプロジェクトをサポートするのかを学んでください。</p>
</blockquote>

<p>自動ビルド（automated builds または autobuilds）を設定する際には、Docker イメージとしてビルドしたいブランチとタグの一覧を生成します。
その一覧に示されたイメージタグに対してのソースコードブランチ（たとえば GitHub 上）にソースをプッシュすると、このプッシュによって新たなビルドを起動するウェブフックが用いられます。
これによって Docker イメージが作り出されます。
そしてビルドされたイメージは Docker Hub レジストリにプッシュされます。</p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>自動ビルドの設定が行われているリポジトリであっても<code class="language-plaintext highlighter-rouge">docker push</code>を使えば、それまでと変わらずにビルド済イメージをプッシュすることができます。</p>
</blockquote>

<p>自動テストを設定すれば、自動ビルドが行われた直後、そしてレジストリへのプッシュが行われる前に、そのテストが実行されます。
このようなテストを利用すれば CI ワークフローにおいて、テストに失敗したビルドイメージはプッシュを行わないといったことが可能になります。
自動テスト自体は、レジストリに対してイメージをプッシュするものではありません。
<a href="/docs.docker.jp.onthefly/docker-hub/builds/automated-testing/">イメージの自動テストに関する詳細はこちらを参照してください</a>。</p>

<p>購入している <a href="https://www.docker.com/pricing" target="_blank" rel="noopener" class="_">プラン</a> によっては、同時ビルドを行うこともできます。
つまり<code class="language-plaintext highlighter-rouge">N</code>個の自動ビルドを同時に実行します。
<code class="language-plaintext highlighter-rouge">N</code>という数値は、購入しているプランにおいて設定します。
<code class="language-plaintext highlighter-rouge">N+1</code>個めのビルドが実行されると、これに続くビルドはキューに入り、後に実行されます。</p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>キューに待機されるビルドの総数は 30 個に制限されていて、それ以上のビルド要求は破棄されます。
同時ビルド数は Pro プランでは 5、Team プランでは 15 です。</p>
</blockquote>

<p><img src="/docs.docker.jp.onthefly/docker-hub/builds/images/index-dashboard.png" alt="自動ビルドダッシュボード" /></p>

<h2 id="configure-automated-build-settings">自動ビルドの設定</h2>

<p>Docker Hub 上のリポジトリにおいては、ソースプロバイダーに対して新たなソースコードをプッシュした際に、イメージを自動的にビルドするように設定することができます。
<a href="/docs.docker.jp.onthefly/docker-hub/builds/automated-testing/">自動テスト</a> を設定している場合は、テストに成功したイメージのみがプッシュされます。</p>

<p>自動ビルドは既存のリポジトリに追加することができ、新規にリポジトリ生成を行った際に追加することもできます。</p>

<ol>
  <li>
    <p><strong>Repositories</strong> セクションからリポジトリの詳細画面を開きます。</p>
  </li>
  <li>
    <p><strong>Builds</strong> タブをクリックします。</p>
  </li>
  <li>
    <p>自動ビルドの設定を初めて行う場合は、イメージのソースコードを保存しているコードリポジトリサービス（GitHub または Bitbucket）を選択します。
これを行うと、コードリポジトリサービスに <a href="/docs.docker.jp.onthefly/docker-hub/builds/link-source/">リンク</a> するための設定画面にリダイレクトされます。</p>

    <p>別の方法として、既存の自動ビルドに対するビルド設定を行っている場合は、<strong>Configure automated builds</strong>（自動ビルドの設定）をクリックします。</p>
  </li>
  <li>
    <p>Docker イメージを作り出す <strong>source repository</strong>（ソースリポジトリ）を選択します。</p>

    <p>ソースコードプロバイダーにおいては、組織やユーザー（その <strong>名前空間</strong>）の指定が必要になるときもあります。
 名前空間を選択しておけば、そのソースコードリポジトリが <strong>Select repository</strong> のドロップダウンリストに表示されるようになります。</p>
  </li>
  <li>
    <p>任意の作業として <a href="/docs.docker.jp.onthefly/docker-hub/builds/automated-testing/#enable-automated-tests-on-a-repository">autotests</a>（自動テスト）を有効にします。</p>
  </li>
  <li>
    <p>デフォルトの <strong>Build Rules</strong>（ビルドルール）を確認し、必要に応じて <strong>プラス記号</strong> をクリックして追加のビルドルールを設定します。</p>

    <p><strong>ビルドルール</strong> とは、ソースコードリポジトリの内容に基づいて Docker Hub が何をイメージとしてビルドするのか、またビルドしたイメージを Docker リポジトリ内にてどのようにタグづけを行うかを制御します。</p>

    <p>デフォルトのビルドルールがすでに準備されています。
このルールは編集したり削除したりすることができます。
デフォルトのルールでは、ソースコードリポジトリ内の<code class="language-plaintext highlighter-rouge">master</code>ブランチからビルドを行うものとして設定されています。
そして生成する Docker イメージには<code class="language-plaintext highlighter-rouge">latest</code>というタグをつけます。</p>
  </li>
  <li>
    <p>各ブランチやタグに対して <strong>Autobuild</strong> トグルを使って、自動ビルドの有効、無効を設定します。</p>

    <p>自動ビルドが有効として設定されたブランチやタグだけがビルド、テストされ、<strong>さらに</strong> そこから生成されたイメージだけがリポジトリにプッシュされます。
自動ビルドを無効に設定したブランチは（リポジトリレベルで有効になっている場合）テスト目的でビルドされますが、ビルドされた Docker イメージはリポジトリにプッシュされません。</p>
  </li>
  <li>
    <p>各ブランチやタグに対して <strong>Build Caching</strong> トグルを使って、ビルドキャッシュの有効、無効を設定します。</p>

    <p><a href="/docs.docker.jp.onthefly/develop/develop-images/dockerfile_best-practices/#leverage-build-cache">ビルドキャッシュ</a> は、大きなイメージを頻繁に生成したり、多くの依存パッケージを有するイメージを生成したりする際に、ビルド時間の短縮に役立ちます。
 ビルド時に依存関係をすべて解決したい場合や、ローカルでビルドする方が早いくらいの大規模レイヤーがある場合などでは、ビルドキャッシュを無効にしておきたい場合があるかもしれません。</p>
  </li>
  <li>
    <p><strong>Save</strong> をクリックして設定を保存します。
または <strong>Save and build</strong> をクリックして、保存とともに初回のテストを実施します。</p>

    <p>ソースコードリポジトリにはウェブフックが自動的に追加されます。
 これによって Docker Hub 上へのプッシュがすべて通知されるようになります。
 1 つまたは複数のタグに対するソースとして一覧にあげられているブランチに対してのみ、プッシュからビルドが起動されます。</p>
  </li>
</ol>

<h3 id="set-up-build-rules">ビルドルールの設定</h3>

<p>自動ビルドを設定すると、デフォルトで基本的なビルドルールが生成されます。
このデフォルトルールは、ソースコードリポジトリ内の<code class="language-plaintext highlighter-rouge">master</code>ブランチへの変更を監視するものです。 そして<code class="language-plaintext highlighter-rouge">master</code>ブランチのソースをビルドして Docker イメージに<code class="language-plaintext highlighter-rouge">latest</code>というタグづけを行います。</p>

<p><strong>Build Rules</strong>（ビルドルール）のセクションにおいて、ビルドするソースを必要な分だけ入力します。</p>

<p>各ソースに対して以下を行います。</p>

<ul>
  <li>
    <p><strong>Source type</strong>（ソースタイプ）として <strong>tag</strong>（タグ）または <strong>branch</strong>（ブランチ）のいずれをビルドするかを選びます。
ビルドシステムがソースコードリポジトリ内のどちらを見にいくかを指示するものです。</p>
  </li>
  <li>
    <p>ビルドを行う <strong>Source</strong>（ソース）ブランチまたはタグの名前を入力します。</p>

    <p>自動ビルドの設定を初めて行う場合は、デフォルトのビルドルールが設定されます。
このデフォルトルールは、ソースコード内の<code class="language-plaintext highlighter-rouge">master</code>ブランチからビルドを行うものとしています。
そして生成される Docker イメージに<code class="language-plaintext highlighter-rouge">latest</code>というタグをつけます。</p>

    <p>ビルド対象とするソースのブランチやタグの指定において、正規表現を用いることもできます。
詳しくは <a href="/docs.docker.jp.onthefly/docker-hub/builds/#regexes-and-automated-builds">正規表現</a> を参照してください。</p>
  </li>
  <li>
    <p>そのソースからビルドされる Docker イメージにおいて、適用するタグ名を入力します。</p>

    <p>ソース指定にあたって正規表現を用いた場合、マッチしたグループを用いて、タグ名の一部分に利用することができます。
詳しくは <a href="/docs.docker.jp.onthefly/docker-hub/builds/#regexes-and-automated-builds">正規表現</a> を参照してください。</p>
  </li>
  <li>
    <p><strong>Dockerfile location</strong>（Dockerfile の場所）として、ソースコードリポジトリのルートからの相対パスを指定します。
（Dockerfile がリポジトリのルートにあるのであれば、このパス設定は<code class="language-plaintext highlighter-rouge">/</code>のままとしてください。）</p>
  </li>
</ul>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>Docker Hub がソースコードリポジトリからブランチをプルする際には、shallow クローン（指定ブランチの最新履歴のみのクローン）を行います。
詳しくは <a href="/docs.docker.jp.onthefly/docker-hub/builds/advanced/">自動ビルドや自動テストに対する高度なオプション</a> を参照してください。</p>
</blockquote>

<h3 id="environment-variables-for-builds">ビルドにおける環境変数</h3>

<p>自動ビルドの設定の際には、環境変数の値をビルド時に利用するように設定できます。
ビルド時の環境変数は <strong>Build environment variables</strong> セクションの横にあるプラス記号をクリックして追加します。
そして変数名と値を入力します。</p>

<p>Docker Hub の UI 画面から変数値を設定すると、<code class="language-plaintext highlighter-rouge">hooks</code>ファイル内に設定したコマンドからこれを利用することができます。
ただしこの情報は保存されるため、Docker Hub リポジトリに対する<code class="language-plaintext highlighter-rouge">admin</code>権限を有するユーザーしか、その値を参照することはできません。
つまりこれを利用すれば、アクセストークンや機密にしておきたい各種情報を安全に保存しておくことができることになります。</p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>ビルド設定画面上から設定した変数は、ビルド処理において <strong>のみ</strong> 利用されます。
したがってサービスにおいて利用している環境変数（たとえばサービスリンクの生成時に利用するもの）とは混同しないようにしてください。</p>
</blockquote>

<h2 id="check-your-active-builds">アクティブなビルドの確認</h2>

<p>リポジトリにおけるビルド概要は、リポジトリの <strong>General</strong>（一般）タブおよび <strong>Builds</strong>（ビルド）タブにおいて見ることができます。
また <strong>Builds</strong> タブでは、色づけされたバーチャートによってビルドのキュー時間や間隔を見ることもできます。
いずれの画面においてもリポジトリの各タブごとに、ビルドが中断しているもの、実行中のもの、成功したもの、失敗したものが確認できます。</p>

<p><img src="/docs.docker.jp.onthefly/docker-hub/builds/images/index-active.png" alt="アクティブなビルド" /></p>

<p>いずれの画面からでもビルドジョブをクリックすれば、ビルド結果を見ることができます。
ビルド結果にはビルドジョブに関する情報として、ソースリポジトリとブランチ（あるいはタグ）、ビルド時間、生成時刻、生成場所、ビルド処理を行ったユーザー名前空間が示されます。</p>

<p><img src="/docs.docker.jp.onthefly/docker-hub/builds/images/index-report.png" alt="ビルド報告" /></p>

<h2 id="cancel-or-retry-a-build">ビルドのキャンセルまたは再実行</h2>

<p>ビルド要求がキューに入っている、あるいは実行されている場合に、General タブや Builds タブにおけるビルド報告リンクの横には <strong>Cancel</strong> アイコンが表示されます。
ビルド結果のページから、あるいは Timeline タブのログ表示から <strong>Cancel</strong> ボタンをクリックすることもできます。</p>

<p><img src="/docs.docker.jp.onthefly/docker-hub/builds/images/build-cancelicon.png" alt="キャンセルアイコンが表示されているビルドの一覧" /></p>

<p>ビルドが失敗した場合、General タブあるいは Builds タブのビルド報告の行の横に <strong>Retry</strong>（再実行）アイコンが表示されます。
またビルド報告のページや Timeline ログにおいても <strong>Retry</strong> ボタンが表示されます。</p>

<p><img src="/docs.docker.jp.onthefly/docker-hub/builds/images/retry-build.png" alt="Retry ボタンが表示されている Timeline 画面" /></p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>ビルド詳細を確認しているリポジトリが組織に属したものである場合、Cancel ボタンや Retry ボタンは、そのリポジトリに対して<code class="language-plaintext highlighter-rouge">Read &amp; Write</code>（読み書き）の権限がある場合にのみ表示されます。</p>
</blockquote>

<h2 id="disable-an-automated-build">自動ビルドの無効化</h2>

<p>自動ビルドはブランチごと、タグごとに有効化されます。
無効化したり再び有効化することは簡単です。
たとえばコードに対して大々的にリファクタリングを行うような場合に、ビルドを手動で行う必要があり、そういった場合に無効化を行いたくなります。</p>

<p>自動ビルドを無効化するには以下を行います。</p>

<ol>
  <li>
    <p><strong>Repositories</strong> ページにおいて、1 つのリポジトリをクリックして <strong>Builds</strong> タブを選びます。</p>
  </li>
  <li>
    <p>リポジトリのビルド設定を編集するために <strong>Configure automated builds</strong>（自動ビルドの設定）をクリックします。</p>
  </li>
  <li>
    <p><strong>Build Rules</strong>（ビルドルール）セクションにおいて、自動ビルドを無効にしたいブランチまたはタグを選択します。</p>
  </li>
  <li>
    <p>設定行の横にある <strong>autobuild</strong>（自動ビルド）トグルをクリックします。</p>

    <p>無効を指定するとトグルボタンは灰色に変わります。</p>
  </li>
  <li>
    <p><strong>Save</strong>（保存）をクリックして変更を保存します。</p>
  </li>
</ol>

<h2 id="advanced-automated-build-options">高度な自動ビルドオプション</h2>

<p>自動ビルドを設定するにはビルドルールにおいて、最低でもソースブランチ（またはタグ）と目的の Docker タグの指定が必要です。
これ以外に指定可能な内容として、ビルドを行う Dockerfile の場所、ビルドに利用するファイルへのパス（ビルドコンテキスト）設定、複数ブランチやタグの指定、正規表現（regex）利用によるソースコードの動的指定やタグの動的生成などがあります。</p>

<p>このオプションは、各リポジトリにおける <strong>Build configuration</strong>（ビルド設定）画面から利用することができます。
左側のナビゲーションから <strong>Repositories</strong> をクリックし、編集対象とするリポジトリをクリックします。
そして <strong>Builds</strong> タブを選んで、<strong>Configure Automated builds</strong>（自動ビルドの設定）をクリックします。</p>

<h3 id="tag-and-branch-builds">タグビルドやブランチビルド</h3>

<p>自動ビルドの設定においては、特定のブランチまたはタグへのプッシュからビルドが実行されるように設定することができます。</p>

<ol>
  <li>
    <p><strong>Build Rules</strong>（ビルドルール）セクションにおいてプラス記号をクリックして、ビルド対象のソースを追加します。</p>
  </li>
  <li>
    <p>ビルド対象とする <strong>Source type</strong>（ソースタイプ）を選択します。
<strong>tag</strong>（タグ）または <strong>branch</strong>（ブランチ）のいずれかです。</p>

    <p>これはビルドシステムがソースコードリポジトリ内のどちらを見にいくかを指示するものです。</p>
  </li>
  <li>
    <p>ビルドを行う <strong>Source</strong>（ソース）ブランチまたはタグの名前を入力します。</p>

    <p>名前をそのまま入力します。
 あるいは正規表現を用いて、ビルド対象とするソースブランチまたはタグを表現することもできます。
 詳しくは <a href="/docs.docker.jp.onthefly/docker-hub/builds/#regexes-and-automated-builds">正規表現</a> を参照してください。</p>
  </li>
  <li>
    <p>そのソースからビルドされる Docker イメージにおいて、適用するタグ名を入力します。</p>

    <p>ソース指定にあたって正規表現を用いた場合、マッチしたグループを用いて、タグ名の一部分に利用することができます。
 詳しくは <a href="/docs.docker.jp.onthefly/docker-hub/builds/#regexes-and-automated-builds">正規表現</a> を参照してください。</p>
  </li>
  <li>
    <p>新たに設定するビルドに対して、上の手順 2 から 4 を繰り返します。</p>
  </li>
</ol>

<h3 id="set-the-build-context-and-dockerfile-location">ビルドコンテキストと Dockerfile の場所指定</h3>

<p>ソースコードリポジトリ内でのファイル構成がさまざまであるため、イメージビルドに必要なファイルがリポジトリのルートに存在していないこともあります。
そのような場合は、ビルド処理において対象ファイルを探しにいくパスを指定します。</p>

<p><strong>ビルドコンテキスト</strong> は、ビルドに必要となるファイルへのパスのことであり、リポジトリのルートからの相対パスとして表わされます。
そのようなファイルパスを <strong>Build context</strong>（ビルドコンテキスト）欄に入力します。
ビルドコンテキストとしてソースコードリポジトリのルートを設定する場合には<code class="language-plaintext highlighter-rouge">/</code>を入力します。</p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p><strong>Build context</strong> 欄のデフォルトパス<code class="language-plaintext highlighter-rouge">/</code>を削除して、そのまま空欄にすると、ビルド処理では Dockerfile へのパスをビルドコンテキストとして用います。
ただし混乱を避けるため、完全なパス指定を行うことをお勧めします。</p>
</blockquote>

<p><strong>Dockerfile location</strong>（Dockerfile の場所）では、ビルドコンテキストへの相対パスを指定します。
Dockerfile がビルドコンテキストパスのルートに存在する場合は、Dockerfile のパスは<code class="language-plaintext highlighter-rouge">/</code>のままとします。
（ビルドコンテキストが空欄であった場合 Dockerfile は、ソースリポジトリのルートからのパスを指定してください。）</p>

<h3 id="regexes-and-automated-builds">正規表現と自動ビルド</h3>

<p>ビルド指定においては正規表現（regex）を用いて、合致したブランチまたはタグのみをビルドすることができます。
また正規表現で得られた結果を使って、ビルドイメージに適用される Docker タグを生成することもできます。</p>

<p>ビルドソースを指定する際の正規表現において、グループ指定（カッコでくくった表現）は 9 個まで利用することができます。
そのグループに対する参照方法は、<strong>Docker Tag</strong>（Docker タグ）欄において<code class="language-plaintext highlighter-rouge">{\1}</code>から<code class="language-plaintext highlighter-rouge">{\9}</code>を使って行います。</p>

<!-- Capture groups Not a priority
#### Regex example: build from version number branch and tag with version number

You could also use capture groups to build and label images that come from various sources. For example, you might have

`/(alice|bob)-v([0-9.]+)/` -->

<h3 id="build-images-with-buildKit">BuildKit を用いたイメージビルド</h3>

<p>自動ビルドは、デフォルトで BuildKit ビルドシステムを利用します。
かつての Docker ビルドシステムを利用したい場合は、<a href="/docs.docker.jp.onthefly/docker-hub/builds/#environment-variables-for-builds" target="_blank" rel="noopener" class="_">環境変数</a> <code class="language-plaintext highlighter-rouge">DOCKER_BUILDKIT=0</code> を設定します。
BuildKit に関する詳細は <a href="/docs.docker.jp.onthefly/develop/develop-images/build_enhancements/">BuildKit を使ったイメージビルド</a> を参照してください。</p>

<h2 id="プライベートサブモジュールをリンクしているリポジトリのビルド">プライベートサブモジュールをリンクしているリポジトリのビルド</h2>

<p>Docker Hub ではデプロイ鍵をソースコードリポジトリ内において設定することが可能であり、リポジトリのクローンやそのビルドを可能にしています。
ただしこの鍵は、単一の特定コードリポジトリに対してしか動作しません。
ソースコードリポジトリにおいてプライベート Git サブモジュールを利用している場合（あるいはビルドにあたっては別のプライベートリポジトリをクローンする必要がある場合）、Docker Hub はそのような追加のリポジトリにアクセスすることができません。
そのためビルドが成功せず、ビルドタイムラインにエラーログが出力されます。</p>

<p>これを回避するには、自動ビルドにおいて環境変数<code class="language-plaintext highlighter-rouge">SSH_PRIVATE</code>を利用します。
これによってデプロイ鍵をオーバーライドして Docker Hub によるビルド処理が他のリポジトリにアクセスできるようにします。</p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>自動ビルドをチーム内で利用している場合は、代わりに <a href="/docs.docker.jp.onthefly/docker-hub/builds/#service-users-for-team-autobuilds">以下の手順</a> に従って、ソースコードプロバイダーに対するサービスユーザーを設定してください。
これは個々のアカウントに対して Docker Hub からソースリポジトリに対するアクセスを制限することでも実現することができます。</p>
</blockquote>

<ol>
  <li>
    <p>ビルド目的でのみ利用する SSH 鍵ペアを生成します。
そしてその公開鍵をソースコードプロバイダーのアカウントに追加します。</p>

    <p>この手順は任意です。
 ただしこれを行っておけば、ビルド専用の鍵を削除しても、別のアクセスまで削除する必要がなくなります。</p>
  </li>
  <li>プライベート鍵をクリップボードにコピーします。</li>
  <li>Docker Hub において、プライベートサブモジュールへのリンクを持つリポジトリのビルドページにアクセスします。
（必要であれば <a href="/docs.docker.jp.onthefly/docker-hub/builds/#configure-automated-build-settings">ここ</a> に示す手順に従って自動ビルドの設定を行います。）</li>
  <li>画面下段にある <strong>Build Environment variables</strong>（環境変数のビルド）の横のプラス記号（<strong>+</strong>）をクリックします。</li>
  <li>新たな環境変数の名前として<code class="language-plaintext highlighter-rouge">SSH_PRIVATE</code>を入力します。</li>
  <li>プライベート鍵を <strong>Value</strong>（値）欄に貼り付けます。</li>
  <li><strong>Save</strong> をクリックします。
または <strong>Save and build</strong> をクリックして、ビルドが成功することを確認します。</li>
</ol>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>git clone を使ってプライベートサブモジュールを設定する際には、HTTPS 経由ではなく SSH 経由（<code class="language-plaintext highlighter-rouge">git@submodule.tld:some-submodule.git</code>）としなければなりません。</p>
</blockquote>

<h2 id="autobuild-for-teams">チーム向けの自動ビルド</h2>

<p>自分のアカウント名前空間内において自動ビルドリポジトリを生成すれば、そのリポジトリ内での自動ビルドの起動、キャンセル、再ビルド、編集、削除は思いのままです。</p>

<p>Docker Hub のチームリポジトリに対しての同じ操作は、組織の<code class="language-plaintext highlighter-rouge">Owners</code>（所有者）チームのメンバーであれば可能になります。
<code class="language-plaintext highlighter-rouge">write</code>（書き込み）権限を持つチームメンバーであれば、チームリポジトリにおいてビルドの起動、キャンセル、再ビルドが可能になります。
しかしチームリポジトリ設定を書き換えたり、チームリポジトリそのものを削除したりすることはできません。
<code class="language-plaintext highlighter-rouge">read</code>（読み込み）権限を持つユーザーアカウントである、あるいは<code class="language-plaintext highlighter-rouge">read</code>権限を持つチームメンバーである場合は、ビルド設定やテスト設定の内容を参照することができます。</p>

<table>
  <thead>
    <tr>
      <th>操作/パーミッション</th>
      <th>読み</th>
      <th>書き</th>
      <th>管理者</th>
      <th>所有者</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ビルド結果の参照</td>
      <td>x</td>
      <td>x</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>起動,キャンセル,再起動</td>
      <td> </td>
      <td>x</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>ビルド設定の編集</td>
      <td> </td>
      <td> </td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>ビルドの削除</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>x</td>
    </tr>
  </tbody>
</table>

<h3 id="service-users-for-team-autobuilds">チーム自動ビルドに対するサービスユーザー</h3>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>チームに対する自動ビルドの設定は、<code class="language-plaintext highlighter-rouge">Owners</code>（所有者）チームのメンバーのみが行うことができます。</p>
</blockquote>

<p>チームに対して自動ビルドの設定を行う際には、Docker Hub からソースコードリポジトリへのアクセスを許可するために、特定のユーザーアカウントに紐づいた OAuth を利用します。
これによって Docker Hub からは、リンクされたソースプロバイダーのアカウントがアクセス可能なものすべてにアクセスできるようになります。</p>

<p>組織やチームにおいては、ソースプロバイダーへのアクセスを許可するために、専用のサービスアカウント（言い換えると「マシンユーザー」）を生成することをお勧めします。
これを行っておけば、個別ユーザーのアクセス権限が変更されても、ビルドが失敗することがなくなります。
しかもそのユーザーの個人的なプロジェクトは、組織全体に公開せずに済みます。</p>

<p>このサービスアカウントは、ビルドするリポジトリすべてに対してアクセス可能でなければなりません。
そしてソースコードリポジトリに対して管理権限を有していて、そのデプロイ鍵を管理できることが必要です。
必要であればこのアカウントの権限を制限して、特定のビルドに対して必要となる特定のリポジトリのみにアクセスするようにすることもできます。</p>

<p>プライベートサブモジュール（プライベート依存パッケージ）にリンクされたリポジトリをビルドしている際には、環境変数<code class="language-plaintext highlighter-rouge">SSH_PRIVATE</code>をオーバーライドして、そのアカウントに関連づいた自動ビルドを行う必要があります。</p>

<ol>
  <li>ソースプロバイダー上においてサービスユーザーを生成します。
そしてこれに対する SSH 鍵を生成します。</li>
  <li>組織内に「ビルド」チームを生成します。</li>
  <li>
    <p>ビルド対象とするリポジトリやサブモジュールに対して、この新たな「ビルド」チームがアクセスできるようにします。</p>

    <p>リポジトリの <strong>Settings</strong>（設定）ページにアクセスします。
 GitHub では <strong>Collaborators and Teams</strong>（協力者とチーム）の一覧に新たな「ビルド」チームを追加します。
 Bitbucket では <strong>Access management</strong>（アクセス管理）画面において、承認ｓれたユーザーの一覧に「ビルド」チームを追加します。</p>
  </li>
  <li>
    <p>ソースプロバイダーの「ビルド」チームに対してサービスユーザーを追加します。</p>
  </li>
  <li>
    <p>Docker Hub に対して<code class="language-plaintext highlighter-rouge">Owners</code>（所有者）チームのメンバーとしてログインします。
そして組織に切り替えて、サービスアカウントを使った <a href="/docs.docker.jp.onthefly/docker-hub/builds/link-source/">ソースコードリポジトリへのリンク</a> の手順を行います。</p>

    <blockquote>
      <p><strong>メモ</strong></p>

      <p>サービスアカウントへのリンクを生成するためには、ソースコードプロバイダー上の個人アカウントからログアウトすることが必要かもしれません。</p>
    </blockquote>
  </li>
  <li>任意の作業として、生成した SSH 鍵を使ってプライベートサブモジュールを利用するビルドの設定を行います。
その際にはサービスアカウントを用いて <a href="/docs.docker.jp.onthefly/docker-hub/builds/#build-repositories-with-linked-private-submodules">上の手順</a> に従います。</li>
</ol>

<h2 id="whats-next">次に読むものは</h2>

<h3 id="customize-your-build-process">ビルド処理のカスタマイズ</h3>

<p>自動ビルドをカスタマイズするために、高度なオプションも用意されています。
たとえばユーティリティー環境変数、フック、ビルド時のオーバーライドなどです。
詳しくは <a href="/docs.docker.jp.onthefly/docker-hub/builds/advanced/">自動ビルドおよび自動テストのための高度なオプション</a> を参照してください。</p>

<h3 id="add-automated-tests">自動テストの追加</h3>

<p>イメージがプッシュされるまえにコードのテストを行うには、Docker Hub の <a href="/docs.docker.jp.onthefly/docker-hub/builds/automated-testing/">自動テスト</a> 機能を利用します。
これは自動ビルドや自動デプロイとシームレスに連携しています。</p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>自動テストからビルドされるイメージはテスト目的に限られます。
したがってビルドされたイメージは Docker Hub にはプッシュされません。</p>
</blockquote>
<span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span style="vertical-align: 2px"><a href="/docs.docker.jp.onthefly/search/?q=automated">automated</a>, <a href="/docs.docker.jp.onthefly/search/?q=build">build</a>, <a href="/docs.docker.jp.onthefly/search/?q=images">images</a>, <a href="/docs.docker.jp.onthefly/search/?q=Docker Hub">Docker Hub</a></span><div class="ratings-div"><div id="pd_rating_holder_8453675"></div></div></section>
                    </main>
                    <nav class="col-nav">
                        <div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
                            <div id="navbar" class="nav-sidebar">
                                <ul class="nav hidden-md hidden-lg"></ul>
                                <ul class="nav" id="jsTOCLeftNav"></ul>
                            </div>
                        </div>
                    </nav>
                    <div class="col-toc">
                        <div class="sidebar hidden-xs hidden-sm">
                            <div class="toc-nav">
                                <div class="feedback-links">
                                    <ul><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/edit/master/src/docker-hub/builds/index.ch"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 本ページの編集</a></li><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/issues/new?body=File: [docker-hub/builds/index.ch](https://matsuand.github.io/docs.docker.jp.onthefly/docker-hub/builds/)" class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 変更リクエスト</a></li>
                                        <li><div class="toggle-mode">
  <div class="icon">
      <i class="fa fa-sun-o" aria-hidden="true"></i>
  </div>
  <div class="toggle-switch">
      <label class="switch">
          <input type="checkbox" id="switch-style">
          <span class="slider round"></span>
      </label>
  </div>
  <div class="icon">
      <i class="fa fa-moon-o" aria-hidden="true"></i>
  </div>
</div>
</li>
                                    </ul>
                                </div><div id="side-toc-title">本ページ内:</div>
<ul id="my_toc" class="inline_toc">
  <li><a href="#how-automated-builds-work" class="nomunge">自動ビルドはどのように動くか</a></li>
  <li><a href="#configure-automated-build-settings" class="nomunge">自動ビルドの設定</a>
    <ul>
      <li><a href="#set-up-build-rules" class="nomunge">ビルドルールの設定</a></li>
      <li><a href="#environment-variables-for-builds" class="nomunge">ビルドにおける環境変数</a></li>
    </ul>
  </li>
  <li><a href="#check-your-active-builds" class="nomunge">アクティブなビルドの確認</a></li>
  <li><a href="#cancel-or-retry-a-build" class="nomunge">ビルドのキャンセルまたは再実行</a></li>
  <li><a href="#disable-an-automated-build" class="nomunge">自動ビルドの無効化</a></li>
  <li><a href="#advanced-automated-build-options" class="nomunge">高度な自動ビルドオプション</a>
    <ul>
      <li><a href="#tag-and-branch-builds" class="nomunge">タグビルドやブランチビルド</a></li>
      <li><a href="#set-the-build-context-and-dockerfile-location" class="nomunge">ビルドコンテキストと Dockerfile の場所指定</a></li>
      <li><a href="#regexes-and-automated-builds" class="nomunge">正規表現と自動ビルド</a></li>
      <li><a href="#build-images-with-buildKit" class="nomunge">BuildKit を用いたイメージビルド</a></li>
    </ul>
  </li>
  <li><a href="#プライベートサブモジュールをリンクしているリポジトリのビルド" class="nomunge">プライベートサブモジュールをリンクしているリポジトリのビルド</a></li>
  <li><a href="#autobuild-for-teams" class="nomunge">チーム向けの自動ビルド</a>
    <ul>
      <li><a href="#service-users-for-team-autobuilds" class="nomunge">チーム自動ビルドに対するサービスユーザー</a></li>
    </ul>
  </li>
  <li><a href="#whats-next" class="nomunge">次に読むものは</a>
    <ul>
      <li><a href="#customize-your-build-process" class="nomunge">ビルド処理のカスタマイズ</a></li>
      <li><a href="#add-automated-tests" class="nomunge">自動テストの追加</a></li>
    </ul>
  </li>
</ul>

</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">
          
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products" target="_blank" rel="noopener">製品ラインアップ</a></b></li>
                        <li><a href="https://www.docker.com/products/personal" target="_blank" rel="noopener">Docker Personal</a></li>
                        <li><a href="https://www.docker.com/products/pro" target="_blank" rel="noopener">Docker Pro</a></li>
                        <li><a href="https://www.docker.com/products/team" target="_blank" rel="noopener">Docker Team</a></li>
                        <li><a href="https://www.docker.com/products/business" target="_blank" rel="noopener">Docker Business</a></li>
                        <li><a href="https://www.docker.com/products" target="_blank" rel="noopener">サブスクリプション比較</a></li>
                        <li><b><a href="https://www.docker.com/" target="_blank" rel="noopener">機能</a></b></li>
                        <li><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">Docker Desktop</a></li>
                        <li><a href="https://www.docker.com/products/docker-hub" target="_blank" rel="noopener">Docker Hub</a></li>
                        <li><a href="https://www.docker.com/products/secure-software-supply-chain" target="_blank" rel="noopener">セキュアなソフトウェアサプライチェーン</a></li>
                        <li><a href="https://www.docker.com/products/container-runtime" target="_blank" rel="noopener">コンテナーランタイム</a></li>
                        <li><a href="https://www.docker.com/products/developer-tools" target="_blank" rel="noopener">開発ツール</a></li>
                        <li><a href="https://www.docker.com/partners" target="_blank" rel="noopener">信頼できるコンテント</a></li>
                        <li><a href="https://www.docker.com/roadmap" target="_blank" rel="noopener">Docker 製品ロードマップ</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">開発者</a></b></li>
                        <li><a href="https://www.docker.com/use-cases" target="_blank" rel="noopener">利用例</a></li>
                        <li><a href="https://docs.docker.com/get-started/" target="_blank" rel="noopener">はじめよう</a></li>
                        <li><a href="https://www.docker.com/blog/" target="_blank" rel="noopener">ブログ</a></li>
                        <li><a href="https://www.docker.com/docker-community" target="_blank" rel="noopener">コミュニティー</a></li>
                        <li><a href="https://www.docker.com/open-source" target="_blank" rel="noopener">オープンソース</a></li>
                        <li><a href="https://www.docker.com/community/get-involved/developer-preview" target="_blank" rel="noopener">プレビュープログラム</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">価格体系</a></b></li>
                        <li><a href="https://www.docker.com/pricing/faq" target="_blank" rel="noopener">FAQ</a></li>
                        <li><a href="https://www.docker.com/partners/programs" target="_blank" rel="noopener">Docker 認定公開者向けプログラム</a></li>
                        <li><a href="https://www.docker.com/partners" target="_blank" rel="noopener">パートナー</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/company" target="_blank" rel="noopener">会社概要</a></b></li>
                        <li><a href="https://www.docker.com/what-container" target="_blank" rel="noopener">コンテナーって何？</a></li>
                        <li><a href="https://www.docker.com/why-docker" target="_blank" rel="noopener">なぜ Docker？</a></li>
                        <li><a href="https://www.docker.com/events" target="_blank" rel="noopener">仮想イベント</a></li>
                        <li><a href="https://www.docker.com/swag" target="_blank" rel="noopener">Swag ストア
                        </a></li>
                        <li><a href="https://www.docker.com/company/newsroom" target="_blank" rel="noopener">ニュースルーム</a></li>
                        <li><a href="https://www.docker.com/careers" target="_blank" rel="noopener">採用情報</a></li>
                        <li><a href="https://www.docker.com/company/contact" target="_blank" rel="noopener">連絡先</a></li>
                        <li><a href="https://www.docker.com/customers" target="_blank" rel="noopener">顧客</a></li>
                        <li><a href="https://www.docker.com/newsletter-subscription" target="_blank" rel="noopener">ニュースレター</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="https://www.docker.com/legal/docker-terms-service" target="_blank" rel="noopener">サービス契約</a></li>
                        <li><a href="https://status.docker.com/" target="_blank" rel="noopener">ステータス</a></li>
                        <li><a href="https://www.docker.com/legal" target="_blank" rel="noopener">法的情報</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2013-2021 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="https://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="https://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-slideshare"><a href="https://www.slideshare.net/docker">Slideshare</a></li>
                    <li class="fa fa-reddit"><a href="https://www.reddit.com/r/docker">Reddit</a></li>
                </ul>
            </div>
        </div>
    </div>

    </footer>
    <script>const pageURL = "/docker-hub/builds/";</script></body>
</html>
