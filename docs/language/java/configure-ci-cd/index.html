<!DOCTYPE html>
<!-- Page generated 2022-04-25 09:39:05 +0900-->
<html lang="ja"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Configure CI/CD for your application | Docker ドキュメント</title>
  <meta name="description" content="Learn how to Configure CI/CD for your application" />
  <meta name="keywords" content="Java, CI/CD, local, development">
  <link rel="canonical" href="https://localhost:4000{{ site.baseurl }}/language/java/configure-ci-cd/" />

  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <link rel="apple-touch-icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta name="msapplication-TileImage" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico">
  <meta property="og:image" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
  <meta name="theme-color" content="#2496ed" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- hide elements that are only shown without JavaScript enabled -->
  <script>document.documentElement.classList.add('js')</script>
  <style>html.js .no-js { display: none !important; }</style><script defer src="/docs.docker.jp.onthefly/js/theme-switcher.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/anchorlinks.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/jquery.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
  <script defer src="/docs.docker.jp.onthefly/js/docs.js"></script><script defer src="/docs.docker.jp.onthefly/js/search.js"></script><link rel="preload" as="font" href="https://fonts.gstatic.com/s/opensans/v18/mem8YaGs126MiZpBA-UFVZ0bf8pkAg.woff2" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/geomanist/hinted-Geomanist-Book.woff2"    type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/geomanist/hinted-Geomanist-Regular.woff2" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/glyphicons-halflings-regular.woff2"       type="font/woff2" crossorigin="anonymous">
  <link rel="preload" as="font" href="/docs.docker.jp.onthefly/fonts/fontawesome-webfont.woff2?v=4.7.0"        type="font/woff2" crossorigin="anonymous">

  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/font-awesome.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/bootstrap.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/style.css" id="pagestyle">

  <!-- SEO stuff -->
  <meta name="twitter:title" itemprop="title name" content="Configure CI/CD for your application"/>
  <meta name="twitter:description" property="og:description" itemprop="description" content="" />
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:domain" content="matsuand.github.io"/>
  <meta name="twitter:site" content="@docker_docs"/>
  <meta name="twitter:url" content="https://twitter.com/docker_docs"/>
  <meta name="twitter:image:src" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:image:alt" content="Docker ドキュメント"/>
  <meta property="og:title" content="Configure CI/CD for your application" />
  <meta property="og:description" content="Learn how to Configure CI/CD for your application" />
  <meta property="og:type" content="website"/>
  <meta property="og:updated_time" itemprop="dateUpdated" content="2022-04-25T09:39:05+09:00"/>
  <meta property="og:image" itemprop="image primaryImageOfPage" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta property="og:locale" content="ja_JP" />
  <meta property="og:url" content="https://matsuand.github.io/docs.docker.jp.onthefly/language/java/configure-ci-cd/" />
  <meta property="og:site_name" content="Docker ドキュメント" />
  <meta property="article:published_time" itemprop="datePublished" content="2022-04-25T09:39:05+09:00"/>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebPage","headline":"Configure CI/CD for your application","description":"Learn how to Configure CI/CD for your application","url":"https://docs.docker.com/language/java/configure-ci-cd/"}</script>
  <!-- END SEO STUFF -->
</head>
<body class="colums">
    <header>
        <nav class="nav-secondary navbar navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="/docs.docker.jp.onthefly/">
                <img class="logo" src="/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs" width="160" height="28" />
            </a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="logo-mobile">
    <a href="/docs.docker.jp.onthefly/">
        <img src="/docs.docker.jp.onthefly/images/docker-icon.svg" alt="Docker Docs" title="Docker Docs" width="30" height="30" />
    </a>
</div>
<div class="search-form" id="search-div">
    <form class="search-form form-inline" id="searchForm" action="/docs.docker.jp.onthefly/search/" method="get">
        <label for="st-search-input" class="sr-only">検索</label>
        <input class="search-field form-control ds-input" id="st-search-input" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteResults"></div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container hidden-sm hidden-xs">
    <div>
        <ul class="nav navbar-nav"><li><a href="/docs.docker.jp.onthefly/" id="home">ホーム</a></li><li><a href="/docs.docker.jp.onthefly/get-started/overview/" id="guides">ガイド</a></li><li><a href="/docs.docker.jp.onthefly/desktop/" id="manuals">マニュアル</a></li><li><a href="/docs.docker.jp.onthefly/reference/" id="reference">リファレンス</a></li><li><a href="/docs.docker.jp.onthefly/samples/" id="samples">サンプル</a></li></ul>
    </div>
    <div class="ctrl-right">
        <a href="javascript:void(0)" id="menu-toggle" aria-label="現在ページのメニュートグル"><i class="fa fa-indent" aria-hidden="true"></i></a>
    </div>
</div>
<div class="row hidden-sm hidden-xs">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li><a href="/docs.docker.jp.onthefly/" title="Docker docs homepage"><i class="fa fa-home"></i></a></li>
            <li><a href="/docs.docker.jp.onthefly/get-started/overview/">ガイド</a></li><li><a href="/docs.docker.jp.onthefly/language/">各種言語別ガイド (New)</a></li><li><a href="/docs.docker.jp.onthefly/language/java/">Java</a></li><li><a href="/docs.docker.jp.onthefly/language/java/configure-ci-cd/">CI/CD の設定</a></li></ol>
    </nav>
</div></div>
    </div>
</nav>

    </header>
    <div class="wrapper right-open">
        <div class="container-fluid">
            <div class="row">
                <div class="col-body">
                    <main class="col-content content">
                        <section class="section"><h1>Configure CI/CD for your application</h1><p><em class="reading-time">読む時間の目安: 12 分</em></p><ul class="pagination">
  <li><a href="/docs.docker.jp.onthefly/language/java/build-images/">イメージのビルド</a></li>
  <li><a href="/docs.docker.jp.onthefly/language/java/run-containers/">コンテナーとしてイメージ実行</a></li>
  <li><a href="/docs.docker.jp.onthefly/language/java/develop/">コンテナーの開発利用</a></li>
  <li><a href="/docs.docker.jp.onthefly/language/java/run-tests/">テストの実行</a></li>
  <li class="active"><a href="/docs.docker.jp.onthefly/language/java/configure-ci-cd/">CI/CD の設定</a></li>
  <li><a href="/docs.docker.jp.onthefly/language/java/deploy/">アプリのデプロイ</a></li>
</ul>

<p>This page guides you through the process of setting up a GitHub Action CI/CD pipeline with Docker containers. Before setting up a new pipeline, we recommend that you take a look at <a href="https://www.docker.com/blog/best-practices-for-using-docker-hub-for-ci-cd/" target="_blank" rel="noopener" class="_">Ben’s blog</a> on CI/CD best practices .</p>

<p>This guide contains instructions on how to:</p>

<ol>
  <li>Use a sample Docker project as an example to configure GitHub Actions</li>
  <li>Set up the GitHub Actions workflow</li>
  <li>Optimize your workflow to reduce the number of pull requests and the total build time</li>
  <li>Push only specific versions to Docker Hub</li>
  <li>Optimize your image using multi-stage builds</li>
</ol>

<h2 id="set-up-a-docker-project">Set up a Docker project</h2>

<p>Let’s get started. This guide uses a simple Docker project as an example. The <a href="https://github.com/usha-mandya/SimpleWhaleDemo" target="_blank" rel="noopener" class="_">SimpleWhaleDemo</a> repository contains an Nginx alpine image. You can either clone this repository, or use your own Docker project.</p>

<p><img src="/docs.docker.jp.onthefly/ci-cd/images/simplewhaledemo.png" alt="SimpleWhaleDemo" width="500px" /></p>

<p>Before we start, ensure you can access <a href="https://hub.docker.com/">Docker Hub</a> from any workflows you create. To do this:</p>

<ol>
  <li>
    <p>Add your Docker ID as a secret to GitHub. Navigate to your GitHub repository and click <strong>Settings</strong> &gt; <strong>Secrets</strong> &gt; <strong>New secret</strong>.</p>
  </li>
  <li>
    <p>Create a new secret with the name <code class="highlighter-rouge">DOCKER_HUB_USERNAME</code> and your Docker ID as value.</p>
  </li>
  <li>
    <p>Create a new Personal Access Token (PAT). To create a new token, go to <a href="https://hub.docker.com/settings/security">Docker Hub Settings</a> and then click <strong>New Access Token</strong>.</p>
  </li>
  <li>
    <p>Let’s call this token <strong>simplewhaleci</strong>.</p>

    <p><img src="/docs.docker.jp.onthefly/ci-cd/images/github-access-token.png" alt="New access token" width="500px" /></p>
  </li>
  <li>
    <p>Now, add this Personal Access Token (PAT) as a second secret into the GitHub secrets UI with the name <code class="highlighter-rouge">DOCKER_HUB_ACCESS_TOKEN</code>.</p>

    <p><img src="/docs.docker.jp.onthefly/ci-cd/images/github-secrets.png" alt="GitHub Secrets" width="500px" /></p>
  </li>
</ol>

<h2 id="set-up-the-github-actions-workflow">Set up the GitHub Actions workflow</h2>

<p>In the previous section, we created a PAT and added it to GitHub to ensure we can access Docker Hub from any workflow. Now, let’s set up our GitHub Actions workflow to build and store our images in Hub. We can achieve this by creating two Docker actions:</p>

<ol>
  <li>The first action enables us to log in to Docker Hub using the secrets we stored in the GitHub Repository.</li>
  <li>The second one is the build and push action.</li>
</ol>

<p>In this example, let us set the push flag to <code class="highlighter-rouge">true</code> as we also want to push. We’ll then add a tag to specify to always go to the latest version. Lastly, we’ll echo the image digest to see what was pushed.</p>

<p>To set up the workflow:</p>

<ol>
  <li>Go to your repository in GitHub and then click <strong>Actions</strong> &gt; <strong>New workflow</strong>.</li>
  <li>Click <strong>set up a workflow yourself</strong> and add the following content:</li>
</ol>

<p>First, we will name this workflow:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">CI to Docker Hub</span>
</code></pre></div></div>

<p>Then, we will choose when we run this workflow. In our example, we are going to do it for every push against the main branch of our project:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">main</span> <span class="pi">]</span>
</code></pre></div></div>

<p>Now, we need to specify what we actually want to happen within our action (what jobs), we are going to add our build one and select that it runs on the latest Ubuntu instances available:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">jobs</span><span class="pi">:</span>

  <span class="na">build</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
</code></pre></div></div>

<p>Now, we can add the steps required. The first one checks-out our repository under <code class="highlighter-rouge">$GITHUB_WORKSPACE</code>, so our workflow can access it. The second is to use our PAT and username to log into Docker Hub. The third is the Builder, the action  uses BuildKit under the hood through a simple Buildx action which we will also setup</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">steps</span><span class="pi">:</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Check Out Repo</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Login to Docker Hub</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/login-action@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">username</span><span class="pi">:</span> <span class="s">${{ secrets.DOCKER_HUB_USERNAME }}</span>
          <span class="na">password</span><span class="pi">:</span> <span class="s">${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Docker Buildx</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">buildx</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/setup-buildx-action@v1</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build and push</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">docker_build</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/build-push-action@v2</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">context</span><span class="pi">:</span> <span class="s">./</span>
          <span class="na">file</span><span class="pi">:</span> <span class="s">./Dockerfile</span>
          <span class="na">push</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">tags</span><span class="pi">:</span> <span class="s">${{ secrets.DOCKER_HUB_USERNAME }}/simplewhale:latest</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Image digest</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">echo ${{ steps.docker_build.outputs.digest }}</span>
</code></pre></div></div>

<p>Now, let the workflow run for the first time and then tweak the Dockerfile to make sure the CI is running and pushing the new image changes:</p>

<p><img src="/docs.docker.jp.onthefly/ci-cd/images/ci-to-hub.png" alt="CI to Docker Hub" width="500px" /></p>

<h2 id="optimize-the-workflow">Optimize the workflow</h2>

<p>Next, let’s look at how we can optimize the GitHub Actions workflow through build cache. This has two main advantages:</p>

<ol>
  <li>Build cache reduces the build time as it will not have to re-download all of the images, and</li>
  <li>It also reduces the number of pulls we complete against Docker Hub. We need to make use of GitHub cache to make use of this.</li>
</ol>

<p>Let us set up a Builder with a build cache. First, we need to set up cache for the builder.  In this example, let us add the path and keys to store this under using GitHub cache for this.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Cache Docker layers</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/cache@v2</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/tmp/.buildx-cache</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">${{ runner.os }}-buildx-${{ github.sha }}</span>
          <span class="na">restore-keys</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="no">${{ runner.os }}-buildx-</span>
</code></pre></div></div>

<p>And lastly, after adding the builder and build cache snippets to the top of the Actions file, we need to add some extra attributes to the build and push step. This involves:</p>

<p>Setting up the builder to use the output of the buildx step, and then
Using the cache we set up earlier for it to store to and to retrieve</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Login to Docker Hub</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/login-action@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">username</span><span class="pi">:</span> <span class="s">${{ secrets.DOCKER_HUB_USERNAME }}</span>
          <span class="na">password</span><span class="pi">:</span> <span class="s">${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build and push</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">docker_build</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/build-push-action@v2</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">context</span><span class="pi">:</span> <span class="s">./</span>
          <span class="na">file</span><span class="pi">:</span> <span class="s">./Dockerfile</span>
          <span class="na">builder</span><span class="pi">:</span> <span class="s">${{ steps.buildx.outputs.name }}</span>
          <span class="na">push</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">tags</span><span class="pi">:</span>  <span class="s">${{ secrets.DOCKER_HUB_USERNAME }}/simplewhale:latest</span>
          <span class="na">cache-from</span><span class="pi">:</span> <span class="s">type=local,src=/tmp/.buildx-cache</span>
          <span class="na">cache-to</span><span class="pi">:</span> <span class="s">type=local,dest=/tmp/.buildx-cache</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Image digest</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">echo ${{ steps.docker_build.outputs.digest }}</span>
</code></pre></div></div>

<p>Now, run the workflow again and verify that it uses the build cache.</p>

<h2 id="push-tagged-versions-to-docker-hub">Push tagged versions to Docker Hub</h2>

<p>Earlier, we learnt how to set up a GitHub Actions workflow to a  Docker project, how to optimize the workflow by setting up a builder with build cache. Let’s now look at how we can improve it further. We can do this by adding the ability to have tagged versions behave differently to all commits to master. This means, only specific versions are pushed, instead of every commit updating the latest version on Docker Hub.</p>

<p>You can consider this approach to have your commits go to a local registry to then use in nightly tests. By doing this, you can always test what is latest while reserving your tagged versions for release to Docker Hub.</p>

<p>This involves two steps:</p>

<ol>
  <li>Modifying the GitHub workflow to only push commits with specific tags to Docker Hub</li>
  <li>Setting up a GitHub Actions file to store the latest commit as an image in the GitHub registry</li>
</ol>

<p>First, let us modify our existing GitHub workflow to only push to Hub if there’s a particular tag. For example:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">tags</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">v*.*.*"</span>
</code></pre></div></div>

<p>This ensures that the main CI will only trigger if we tag our commits with <code class="highlighter-rouge">V.n.n.n.</code> Let’s test this. For example, run the following command:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> git tag <span class="nt">-a</span> v1.0.2
<span class="gp">$</span> git push origin v1.0.2
</code></pre></div></div>

<p>Now, go to GitHub and check your Actions</p>

<p><img src="/docs.docker.jp.onthefly/ci-cd/images/push-tagged-version.png" alt="Push tagged version" width="500px" /></p>

<p>Now, let’s set up a second GitHub action file to store our latest commit as an image in the GitHub registry. You may want to do this to:</p>

<ol>
  <li>Run your nightly tests or recurring tests, or</li>
  <li>To share work in progress images with colleagues.</li>
</ol>

<p>Let’s clone our previous GitHub action and add back in our previous logic for all pushes. This will mean we have two workflow files, our previous one and our new one we will now work on.
Next, change your Docker Hub login to a GitHub container registry login:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="na">if</span><span class="pi">:</span> <span class="s">github.event_name != 'pull_request'</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/login-action@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">registry</span><span class="pi">:</span> <span class="s">ghcr.io</span>
          <span class="na">username</span><span class="pi">:</span> <span class="s">${{ github.actor }}</span>
          <span class="na">password</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
</code></pre></div></div>

<p>To authenticate against the <a href="https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry">GitHub Container Registry</a>, use the <a href="https://docs.github.com/en/actions/reference/authentication-in-a-workflow"><code class="highlighter-rouge">GITHUB_TOKEN</code></a> for the best security and experience.</p>

<p>You may need to <a href="https://docs.github.com/en/packages/managing-github-packages-using-github-actions-workflows/publishing-and-installing-a-package-with-github-actions#upgrading-a-workflow-that-accesses-ghcrio">manage write and read access of GitHub Actions</a> for repositories in the container settings.</p>

<p>You can also use a <a href="https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token">personal access token (PAT)</a> with the <a href="https://docs.github.com/en/packages/getting-started-with-github-container-registry/migrating-to-github-container-registry-for-docker-images#authenticating-with-the-container-registry">appropriate scopes</a>.
Remember to change how the image is tagged. The following example keeps ‘latest’ as the only tag. However, you can add any logic to this if you prefer:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">tags</span><span class="pi">:</span> <span class="s">ghcr.io/${{ github.repository_owner }}/simplewhale:latest</span>
</code></pre></div></div>

<p><img src="/docs.docker.jp.onthefly/ci-cd/images/ghcr-logic.png" alt="Update tagged images" width="500px" /></p>

<p>Now, we will have two different flows: one for our changes to master, and one for our pull requests. Next, we need to modify what we had before to ensure we are pushing our PRs to the GitHub registry rather than to Docker Hub.</p>

<h2 id="optimize-your-image-using-multi-stage-builds">Optimize your image using multi-stage builds</h2>

<p>Now, let’s take a look at the Dockerfile and see how we can optimize it to work in development, as well as get smaller images to run containers in production. As this is the last step in the file, it will be used by default to build the image when you run a docker build without specifying the target:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker build <span class="nt">--tag</span> java-docker <span class="nb">.</span>
<span class="go">docker build --tag java-docker .

[+] Building 1.2s (15/15) FINISHED
</span><span class="gp"> =&gt;</span> <span class="o">[</span>internal] load build definition from Dockerfile
<span class="gp"> =&gt;</span> <span class="o">=&gt;</span> transferring dockerfile: 37B
<span class="gp"> =&gt;</span> <span class="o">[</span>internal] load .dockerignore
<span class="gp"> =&gt;</span> <span class="o">=&gt;</span> transferring context: 2B
<span class="gp"> =&gt;</span> <span class="o">[</span>internal] load metadata <span class="k">for </span>docker.io/library/openjdk:11-jre-slim
<span class="gp"> =&gt;</span> <span class="o">[</span>internal] load metadata <span class="k">for </span>docker.io/library/openjdk:16-alpine3.13
<span class="gp"> =&gt;</span> <span class="o">[</span>internal] load build context
<span class="gp"> =&gt;</span> <span class="o">=&gt;</span> transferring context: 11.48kB
<span class="gp"> =&gt;</span> <span class="o">[</span>production 1/2] FROM docker.io/library/openjdk:11-jre-slim@sha256:85795599f4c765182c414a1eb4e272841e18e2f267ce5010ea6a266f7f26e7f6
<span class="gp"> =&gt;</span> <span class="o">[</span>base 1/6] FROM docker.io/library/openjdk:16-alpine3.13@sha256:49d822f4fa4deb5f9d0201ffeec9f4d113bcb4e7e49bd6bc063d3ba93aacbcae
<span class="gp"> =&gt;</span> CACHED <span class="o">[</span>base 2/6] WORKDIR /app
<span class="gp"> =&gt;</span> CACHED <span class="o">[</span>base 3/6] COPY .mvn/ .mvn
<span class="gp"> =&gt;</span> CACHED <span class="o">[</span>base 4/6] COPY mvnw pom.xml ./
<span class="gp"> =&gt;</span> CACHED <span class="o">[</span>base 5/6] RUN ./mvnw dependency:go-offline
<span class="gp"> =&gt;</span> CACHED <span class="o">[</span>base 6/6] COPY src ./src
<span class="gp"> =&gt;</span> CACHED <span class="o">[</span>build 1/1] RUN ./mvnw package
<span class="gp"> =&gt;</span> CACHED <span class="o">[</span>production 2/2] COPY <span class="nt">--from</span><span class="o">=</span>build /app/target/spring-petclinic-<span class="k">*</span>.jar /spring-petclinic.jar
<span class="gp"> =&gt;</span> exporting to image
<span class="gp"> =&gt;</span> <span class="o">=&gt;</span> exporting layers
<span class="gp"> =&gt;</span> <span class="o">=&gt;</span> writing image sha256:c17469b9e2f30537060f48bbe5d9d22003dd35edef7092348824a2438101ab3a
<span class="gp"> =&gt;</span> <span class="o">=&gt;</span> naming to docker.io/library/java-docker
</code></pre></div></div>

<p>The second interesting point is that this step doesn’t take the base target or a JDK image as reference. Instead, it uses a Java Runtime Environment image.
Note that you don’t need a large image with all the development dependencies to run your application in production. Limiting the number of dependencies in production images can significantly limit the attack surface.</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> openjdk:11-jre-slim as production</span>
<span class="k">EXPOSE</span><span class="s"> 8080</span>

<span class="k">COPY</span><span class="s"> --from=build /app/target/spring-petclinic-*.jar /spring-petclinic.jar</span>

<span class="k">CMD</span><span class="s"> ["java", "-Djava.security.egd=file:/dev/./urandom", "-jar", "/spring-petclinic.jar"]</span>
</code></pre></div></div>

<p>The container will also automatically expose its 8080 port and copies the Java Archive produced in build step to use it  at container startup.</p>

<p>The production image built in this way only contains a runtime environment with the final application archive, just what you need to start your Spring Pet Clinic application.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker build <span class="nt">--tag</span> java-docker:jdk <span class="nb">.</span> <span class="nt">--target</span> development
<span class="gp">$</span> docker build <span class="nt">--tag</span> java-docker:jre <span class="nb">.</span>
<span class="gp">$</span>  docker images
<span class="go">REPOSITORY       TAG        IMAGE ID         CREATED        SIZE
java-docker      jre        c17469b9e2f3     3 hours ago    270MB
java-docker      jdk        4c15436d8ab7     5 hours ago    567MB
</span></code></pre></div></div>

<h2 id="next-steps">Next steps</h2>

<p>In this module, you have learnt how to set up GitHub Actions workflow to an existing Docker project, optimize your workflow to improve build times and reduce the number of pull requests, and finally, we learnt how to push only specific versions to Docker Hub. You can also set up nightly tests against the latest tag, test each PR, or do something more elegant with the tags we are using and make use of the Git tag for the same tag in our image.</p>

<p>You can also consider deploying your application. For detailed instructions, see:</p>

<p><a href="/docs.docker.jp.onthefly/language/java/deploy/" class="button primary-btn">Deploy your application</a></p>

<h2 id="feedback">Feedback</h2>

<p>Help us improve this topic by providing your feedback. Let us know what you think by creating an issue in the <a href="https://github.com/docker/docker.github.io/issues/new?title=[Java%20docs%20feedback]" target="_blank" rel="noopener" class="_">Docker Docs</a> GitHub repository. Alternatively, <a href="https://github.com/docker/docker.github.io/pulls" target="_blank" rel="noopener" class="_">create a PR</a> to suggest updates.</p>

<p><br /></p>
<span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span style="vertical-align: 2px"><a href="/docs.docker.jp.onthefly/search/?q=Java">Java</a>, <a href="/docs.docker.jp.onthefly/search/?q=CI/CD">CI/CD</a>, <a href="/docs.docker.jp.onthefly/search/?q=local">local</a>, <a href="/docs.docker.jp.onthefly/search/?q=development">development</a></span><div class="ratings-div"><div id="pd_rating_holder_8453675"></div></div></section>
                    </main>
                    <nav class="col-nav">
                        <div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
                            <div id="navbar" class="nav-sidebar">
                                <ul class="nav hidden-md hidden-lg"></ul>
                                <ul class="nav" id="jsTOCLeftNav"></ul>
                            </div>
                        </div>
                    </nav>
                    <div class="col-toc">
                        <div class="sidebar hidden-xs hidden-sm">
                            <div class="toc-nav">
                                <div class="feedback-links">
                                    <ul><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/edit/master/src/language/java/configure-ci-cd.ch"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 本ページの編集</a></li><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/issues/new?body=File: [language/java/configure-ci-cd.ch](https://matsuand.github.io/docs.docker.jp.onthefly/language/java/configure-ci-cd/)" class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 変更リクエスト</a></li>
                                        <li><div class="toggle-mode">
  <div class="icon">
      <i class="fa fa-sun-o" aria-hidden="true"></i>
  </div>
  <div class="toggle-switch">
      <label class="switch">
          <input type="checkbox" id="switch-style">
          <span class="slider round"></span>
      </label>
  </div>
  <div class="icon">
      <i class="fa fa-moon-o" aria-hidden="true"></i>
  </div>
</div>
</li>
                                    </ul>
                                </div><div id="side-toc-title">本ページ内:</div>
<ul id="my_toc" class="inline_toc">
  <li><a href="#set-up-a-docker-project" class="nomunge">Set up a Docker project</a></li>
  <li><a href="#set-up-the-github-actions-workflow" class="nomunge">Set up the GitHub Actions workflow</a></li>
  <li><a href="#optimize-the-workflow" class="nomunge">Optimize the workflow</a></li>
  <li><a href="#push-tagged-versions-to-docker-hub" class="nomunge">Push tagged versions to Docker Hub</a></li>
  <li><a href="#optimize-your-image-using-multi-stage-builds" class="nomunge">Optimize your image using multi-stage builds</a></li>
  <li><a href="#next-steps" class="nomunge">Next steps</a></li>
  <li><a href="#feedback" class="nomunge">Feedback</a></li>
</ul>

</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">
          
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products" target="_blank" rel="noopener">製品ラインアップ</a></b></li>
                        <li><a href="https://www.docker.com/products/personal" target="_blank" rel="noopener">Docker Personal</a></li>
                        <li><a href="https://www.docker.com/products/pro" target="_blank" rel="noopener">Docker Pro</a></li>
                        <li><a href="https://www.docker.com/products/team" target="_blank" rel="noopener">Docker Team</a></li>
                        <li><a href="https://www.docker.com/products/business" target="_blank" rel="noopener">Docker Business</a></li>
                        <li><a href="https://www.docker.com/products" target="_blank" rel="noopener">サブスクリプション比較</a></li>
                        <li><b><a href="https://www.docker.com/" target="_blank" rel="noopener">機能</a></b></li>
                        <li><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">Docker Desktop</a></li>
                        <li><a href="https://www.docker.com/products/docker-hub" target="_blank" rel="noopener">Docker Hub</a></li>
                        <li><a href="https://www.docker.com/products/secure-software-supply-chain" target="_blank" rel="noopener">セキュアなソフトウェアサプライチェーン</a></li>
                        <li><a href="https://www.docker.com/products/container-runtime" target="_blank" rel="noopener">コンテナーランタイム</a></li>
                        <li><a href="https://www.docker.com/products/developer-tools" target="_blank" rel="noopener">開発ツール</a></li>
                        <li><a href="https://www.docker.com/partners" target="_blank" rel="noopener">信頼できるコンテント</a></li>
                        <li><a href="https://www.docker.com/roadmap" target="_blank" rel="noopener">Docker 製品ロードマップ</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">開発者</a></b></li>
                        <li><a href="https://www.docker.com/use-cases" target="_blank" rel="noopener">利用例</a></li>
                        <li><a href="https://docs.docker.com/get-started/" target="_blank" rel="noopener">はじめよう</a></li>
                        <li><a href="https://www.docker.com/blog/" target="_blank" rel="noopener">ブログ</a></li>
                        <li><a href="https://www.docker.com/docker-community" target="_blank" rel="noopener">コミュニティー</a></li>
                        <li><a href="https://www.docker.com/open-source" target="_blank" rel="noopener">オープンソース</a></li>
                        <li><a href="https://www.docker.com/community/get-involved/developer-preview" target="_blank" rel="noopener">プレビュープログラム</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">価格体系</a></b></li>
                        <li><a href="https://www.docker.com/pricing/faq" target="_blank" rel="noopener">FAQ</a></li>
                        <li><a href="https://www.docker.com/partners/programs" target="_blank" rel="noopener">Docker 認定公開者向けプログラム</a></li>
                        <li><a href="https://www.docker.com/partners" target="_blank" rel="noopener">パートナー</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/company" target="_blank" rel="noopener">会社概要</a></b></li>
                        <li><a href="https://www.docker.com/what-container" target="_blank" rel="noopener">コンテナーって何？</a></li>
                        <li><a href="https://www.docker.com/why-docker" target="_blank" rel="noopener">なぜ Docker？</a></li>
                        <li><a href="https://www.docker.com/events" target="_blank" rel="noopener">仮想イベント</a></li>
                        <li><a href="https://www.docker.com/swag" target="_blank" rel="noopener">Swag ストア
                        </a></li>
                        <li><a href="https://www.docker.com/company/newsroom" target="_blank" rel="noopener">ニュースルーム</a></li>
                        <li><a href="https://www.docker.com/careers" target="_blank" rel="noopener">採用情報</a></li>
                        <li><a href="https://www.docker.com/company/contact" target="_blank" rel="noopener">連絡先</a></li>
                        <li><a href="https://www.docker.com/customers" target="_blank" rel="noopener">顧客</a></li>
                        <li><a href="https://www.docker.com/newsletter-subscription" target="_blank" rel="noopener">ニュースレター</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="https://www.docker.com/legal/docker-terms-service" target="_blank" rel="noopener">サービス契約</a></li>
                        <li><a href="https://status.docker.com/" target="_blank" rel="noopener">ステータス</a></li>
                        <li><a href="https://www.docker.com/legal" target="_blank" rel="noopener">法的情報</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2013-2021 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="https://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="https://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-slideshare"><a href="https://www.slideshare.net/docker">Slideshare</a></li>
                    <li class="fa fa-reddit"><a href="https://www.reddit.com/r/docker">Reddit</a></li>
                </ul>
            </div>
        </div>
    </div>

    </footer>
    <script>const pageURL = "/language/java/configure-ci-cd/";</script></body>
</html>
